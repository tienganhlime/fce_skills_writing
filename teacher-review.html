<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FCE Writing - Sửa Feedback</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #9C27B0; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
    textarea { width: 100%; height: 100px; margin-top: 5px; }
    button { padding: 10px 20px; margin: 10px 5px 10px 0; font-size: 16px; cursor: pointer; }
    .btn-save { background: #2196F3; color: white; border: none; border-radius: 5px; }
    .btn-pdf { background: #FF9800; color: white; border: none; border-radius: 5px; }
    .info { background: #e8f5e9; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>FCE Writing - Sửa Feedback</h1>
    <div id="info" class="info"></div>

    <div class="section">
      <h3>Đề 1: <span id="topic1Title"></span></h3>
      <p><strong>Mở bài:</strong> <span id="intro1"></span></p>
      <p><strong>Phân tích (SS/IS/Q/T):</strong> <span id="analysis1"></span></p>
      <p><strong>Outline:</strong> <span id="outline1"></span></p>
      <p><strong>AI chấm:</strong> <span id="aiScore1"></span> | Level: <span id="aiLevel1"></span></p>
      <label><strong>Feedback giáo viên (Đề 1):</strong></label><br>
      <textarea id="feedback1" placeholder="Nhập nhận xét, gợi ý..."></textarea>
    </div>

    <div class="section">
      <h3>Đề 2: <span id="topic2Title"></span></h3>
      <p><strong>Mở bài:</strong> <span id="intro2"></span></p>
      <p><strong>Phân tích:</strong> <span id="analysis2"></span></p>
      <p><strong>Outline:</strong> <span id="outline2"></span></p>
      <p><strong>AI chấm:</strong> <span id="aiScore2"></span> | Level: <span id="aiLevel2"></span></p>
      <label><strong>Feedback giáo viên (Đề 2):</strong></label><br>
      <textarea id="feedback2" placeholder="Nhập nhận xét, gợi ý..."></textarea>
    </div>

    <button class="btn-save" onclick="saveFeedback()">Lưu Feedback</button>
    <button class="btn-pdf" onclick="exportPDF()">Export PDF</button>
    <a id="pdfLink" style="display:none"></a>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzIp9jfs0GEOh_Y-0AnBBXXaX4AjsMHHW7SkZjDjJwtXFHicIqXyddq9IOZmEijXuu-Fg/execE'; // ← DÁN URL WEB APP VÀO ĐÂY
    const urlParams = new URLSearchParams(window.location.search);
    const studentCode = urlParams.get('code');
    const week = urlParams.get('week') || '1';

    async function loadData() {
      if (!studentCode) return alert('Thiếu mã HS!');

      const [workRes, feedbackRes] = await Promise.all([
        fetch(`${API_URL}?action=getStudentWork&code=${studentCode}&week=${week}`),
        fetch(`${API_URL}?action=getFeedback&code=${studentCode}&week=${week}`)
      ]);

      const work = (await workRes.json()).work;
      const feedback = (await feedbackRes.json()).feedback;

      document.getElementById('info').innerHTML = `
        <strong>Học sinh:</strong> ${work.studentName} (${studentCode}) 
        | <strong>Nộp lúc:</strong> ${work.timestamp} 
        | <strong>Thời gian:</strong> ${work.totalTime}
      `;

      // Đề 1
      document.getElementById('topic1Title').textContent = 'We are much too worried about how people and things look';
      document.getElementById('intro1').textContent = work.topic1.introduction;
      document.getElementById('analysis1').textContent = `${work.topic1.ss}, ${work.topic1.is}, ${work.topic1.q}, ${work.topic1.t}`;
      document.getElementById('outline1').textContent = `${work.topic1.body1} | ${work.topic1.body2} | ${work.topic1.body3}`;
      document.getElementById('aiScore1').textContent = feedback.source === 'ai' ? `${feedback.analysisScore1}/${feedback.introScore1}` : '?';
      document.getElementById('aiLevel1').textContent = feedback.level1 || '?';

      // Đề 2
      document.getElementById('topic2Title').textContent = 'Students should help to make decisions at school';
      document.getElementById('intro2').textContent = work.topic2.introduction;
      document.getElementById('analysis2').textContent = `${work.topic2.ss}, ${work.topic2.is}, ${work.topic2.q}, ${work.topic2.t}`;
      document.getElementById('outline2').textContent = `${work.topic2.body1} | ${work.topic2.body2} | ${work.topic2.body3}`;
      document.getElementById('aiScore2').textContent = feedback.source === 'ai' ? `${feedback.analysisScore2}/${feedback.introScore2}` : '?';
      document.getElementById('aiLevel2').textContent = feedback.level2 || '?';

      // Load feedback giáo viên (nếu có)
      if (feedback.source === 'teacher') {
        const f = feedback.data;
        document.getElementById('feedback1').value = f.topic1?.teacherNote || '';
        document.getElementById('feedback2').value = f.topic2?.teacherNote || '';
      }
    }

    async function saveFeedback() {
      const feedback = {
        topic1: { teacherNote: document.getElementById('feedback1').value },
        topic2: { teacherNote: document.getElementById('feedback2').value }
      };

      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'updateFeedback', studentCode, week, feedback })
      });
      const data = await res.json();
      alert(data.message || 'Đã lưu!');
    }

    async function exportPDF() {
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'exportPDF', studentCode, week })
      });
      const data = await res.json();
      if (data.pdfUrl) {
        document.getElementById('pdfLink').href = data.pdfUrl;
        document.getElementById('pdfLink').click();
      } else {
        alert('Lỗi tạo PDF');
      }
    }

    window.onload = loadData;
  </script>
</body>
</html>