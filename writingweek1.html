<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FCE Writing Week 1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none !important; }
    .field { @apply w-full p-3 border-2 border-green-300 rounded-lg focus:border-green-600 focus:outline-none resize-none; }
    .progress-bar { @apply h-3 rounded-full bg-green-600 transition-all duration-300; }
    .spinner { @apply inline-block w-5 h-5 border-2 border-t-green-600 border-gray-300 rounded-full animate-spin; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-green-100 min-h-screen font-sans">

<!-- MÀN HÌNH NHẬP MÃ -->
<div id="codeScreen" class="flex items-center justify-center min-h-screen p-6">
  <div class="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full">
    <h1 class="text-4xl font-bold text-green-700 text-center mb-2">FCE WRITING</h1>
    <p class="text-green-600 text-center mb-8">WEEK 1</p>
    <input type="text" id="studentCode" class="field text-center text-2xl uppercase font-mono" placeholder="HS001">
    <button onclick="verifyStudent()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-xl transition shadow-lg flex items-center justify-center gap-2">
      <span>XÁC NHẬN & BẮT ĐẦU</span>
    </button>
  </div>
</div>

<!-- MÀN HÌNH LÀM BÀI -->
<div id="testScreen" class="hidden p-6 pb-32">
  <div class="max-w-6xl mx-auto">
    <!-- HEADER -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 sticky top-4 z-10">
      <div class="flex justify-between items-center mb-4">
        <div>
          <p class="text-lg font-semibold">Học sinh: <span id="headerName" class="text-green-700"></span></p>
          <p class="text-sm text-gray-600">Mã: <span id="headerCode"></span></p>
        </div>
        <div class="text-right">
          <p class="text-2xl font-mono text-green-700" id="timerDisplay">00:00</p>
          <p class="text-sm text-gray-600">Tiến độ: <span id="progressText">0/16</span></p>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="progressBar" class="progress-bar w-0"></div>
      </div>
    </div>

    <!-- ĐỀ 1 -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
      <h2 class="text-2xl font-bold text-blue-700 mb-6">ĐỀ 1: APPEARANCE & SOCIETY</h2>
      <div class="grid grid-cols-2 gap-4 mb-6">
        <input id="t1_ss" class="field" placeholder="SS">
        <input id="t1_is" class="field" placeholder="IS">
        <input id="t1_q" class="field" placeholder="Q">
        <input id="t1_t" class="field" placeholder="T">
      </div>
      <textarea id="t1_body1" class="field mb-3" rows="3" placeholder="Body 1"></textarea>
      <textarea id="t1_body2" class="field mb-3" rows="3" placeholder="Body 2"></textarea>
      <textarea id="t1_body3" class="field mb-6" rows="3" placeholder="Body 3"></textarea>
      <textarea id="t1_intro" class="field" rows="5" placeholder="Mở bài (50-70 từ)"></textarea>
    </div>

    <!-- ĐỀ 2 -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-24">
      <h2 class="text-2xl font-bold text-purple-700 mb-6">ĐỀ 2: STUDENT VOICE</h2>
      <div class="grid grid-cols-2 gap-4 mb-6">
        <input id="t2_ss" class="field" placeholder="SS">
        <input id="t2_is" class="field" placeholder="IS">
        <input id="t2_q" class="field" placeholder="Q">
        <input id="t2_t" class="field" placeholder="T">
      </div>
      <textarea id="t2_body1" class="field mb-3" rows="3" placeholder="Body 1"></textarea>
      <textarea id="t2_body2" class="field mb-3" rows="3" placeholder="Body 2"></textarea>
      <textarea id="t2_body3" class="field mb-6" rows="3" placeholder="Body 3"></textarea>
      <textarea id="t2_intro" class="field" rows="5" placeholder="Mở bài (50-70 từ)"></textarea>
    </div>

    <!-- NÚT NỘP -->
    <button onclick="submitTest()" id="submitBtn" class="fixed bottom-8 right-8 bg-green-600 hover:bg-green-700 text-white px-10 py-5 rounded-full shadow-2xl text-2xl font-bold transition z-20 flex items-center gap-3">
      <span>NỘP BÀI</span>
    </button>
  </div>
</div>

<script>
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzUTzh-IwLSAXDPA2MajISbCEiE1g4A986PE8y1MCSJiL0MBZbE_-0vjDgFN16WwObm/exec';
  let studentInfo = {}, startTime = 0, timerInterval;
  let keystrokeLog = {}, behaviorData = {}, timeBreakdown = {}, totalPastes = 0, totalEdits = 0;
  const fields = ['t1_ss','t1_is','t1_q','t1_t','t1_body1','t1_body2','t1_body3','t1_intro','t2_ss','t2_is','t2_q','t2_t','t2_body1','t2_body2','t2_body3','t2_intro'];

  // Timer + Progress
  function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
      const secs = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById('timerDisplay').textContent = `${String(Math.floor(secs/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}`;
      updateProgress();
    }, 500);
  }

  function updateProgress() {
    const filled = fields.filter(id => document.getElementById(id)?.value.trim().length > 0).length;
    document.getElementById('progressText').textContent = `${filled}/${fields.length}`;
    document.getElementById('progressBar').style.width = `${(filled / fields.length) * 100}%`;
  }

  // Keystroke + Paste + Time tracking
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    let startFieldTime = 0;
    el.addEventListener('focus', () => startFieldTime = Date.now());
    el.addEventListener('input', () => {
      const timeInField = Math.floor((Date.now() - startFieldTime) / 1000);
      timeBreakdown[id] = (timeBreakdown[id] || 0) + timeInField;
      startFieldTime = Date.now();
      totalEdits++;
      updateProgress();
    });
    el.addEventListener('paste', () => totalPastes++);
  });

  // Verify
  async function verifyStudent() {
    const code = document.getElementById('studentCode').value.trim().toUpperCase();
    if (!code) return alert('Nhập mã!');
    const url = `${GOOGLE_SCRIPT_URL}?action=verify&code=${encodeURIComponent(code)}`;
    try {
      const res = await fetch(url, { mode: 'cors' });
      const data = await res.json();
      if (data.exists) {
        studentInfo = { code, name: data.studentName };
        document.getElementById('headerName').textContent = data.studentName;
        document.getElementById('headerCode').textContent = code;
        document.getElementById('codeScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        startTimer();
      } else alert('Mã không tồn tại!');
    } catch { alert('Lỗi kết nối!'); }
  }

  // Submit
  async function submitTest() {
    const dataToSend = {
      examType: 'essay', weekNumber: 1,
      studentCode: studentInfo.code, studentName: studentInfo.name,
      totalTimeSeconds: Math.floor((Date.now() - startTime) / 1000),
      totalPastes, totalEdits, behaviorData, timeBreakdown,
      topic1: collectTopic('t1'), topic2: collectTopic('t2')
    };

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Đang nộp...';

    try {
      const res = await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST', mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend)
      });
      const result = await res.json();
      alert(result.status === 'success' ? 'Nộp bài thành công!' : 'Lỗi: ' + result.message);
      clearInterval(timerInterval);
    } catch {
      alert('Lỗi nộp bài!');
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'NỘP BÀI';
    }
  }

  function collectTopic(prefix) {
    return {
      ss: getVal(`${prefix}_ss`), is: getVal(`${prefix}_is`), q: getVal(`${prefix}_q`), t: getVal(`${prefix}_t`),
      body1: getVal(`${prefix}_body1`), body2: getVal(`${prefix}_body2`), body3: getVal(`${prefix}_body3`),
      introduction: getVal(`${prefix}_intro`),
      wordCount: getVal(`${prefix}_intro`).split(/\s+/).filter(w => w).length,
      timeSeconds: timeBreakdown[`${prefix}_intro`] || 0,
      keystrokeLog: {}
    };
  }

  function getVal(id) { return document.getElementById(id)?.value.trim() || ''; }
</script>

</body>
</html>