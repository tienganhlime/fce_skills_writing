<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard - FCE Writing - LIME</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tab { @apply px-4 py-2 rounded-t-lg font-semibold transition; }
    .tab-active { @apply bg-white text-green-700 border-t-2 border-green-600; }
    .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    .editable {
  @apply p-4 border rounded-lg bg-yellow-50 border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500;
  min-height: 100px;
  overflow-y: auto;           /* Quan trọng nhất */
  resize: vertical;
  line-height: 1.6;
  max-height: 80vh;
  scrollbar-width: thin;      /* Firefox */
}
.editable::-webkit-scrollbar {
  width: 6px;
}
.editable::-webkit-scrollbar-track {
  background: #fefce8;
}
.editable::-webkit-scrollbar-thumb {
  background: #ca8a04;
  border-radius: 3px;
}
  </style>
</head>
<body class="min-h-screen p-4">

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-20 fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
        <div>
          <h1 class="text-2xl font-bold text-green-700">Teacher Dashboard</h1>
          <p class="text-green-600 text-sm">FCE Writing - Quản lý bài nộp & Feedback</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-600">
        <p>Giáo viên: <span class="font-semibold">Admin</span></p>
        <p id="currentDate"></p>
      </div>
    </div>
  </div>

  <!-- CHỌN TUẦN -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <label class="block text-green-800 font-semibold mb-2">Chọn Tuần</label>
    <select id="weekSelect" class="w-full md:w-64 px-4 py-3 border-2 border-green-300 rounded-lg text-lg" onchange="loadDashboard()">
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
    </select>
  </div>

  <!-- TỔNG QUAN & THỐNG KÊ -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">Tổng quan</h3>
      <p class="text-3xl font-bold text-green-600" id="submittedCount">0</p>
      <p class="text-sm text-gray-600">Đã nộp / <span id="totalStudents">0</span> học sinh</p>
      <p class="text-sm text-orange-600 mt-2" id="notSubmittedList"></p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
  <h3 class="text-xl font-bold text-green-700 mb-3">Average Scores (5 Topics)</h3>
  <div class="grid grid-cols-2 gap-4">
    <div>
      <p class="text-3xl font-bold text-blue-600" id="avgAnalysis">0.0</p>
      <p class="text-sm text-gray-600">Analysis</p>
    </div>
    <div>
      <p class="text-3xl font-bold text-purple-600" id="avgIntro">0.0</p>
      <p class="text-sm text-gray-600">Introduction</p>
    </div>
  </div>
</div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <canvas id="cefrChart" height="100"></canvas>
    </div>
  </div>

  <!-- DANH SÁCH HỌC SINH -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <h3 class="text-xl font-bold text-green-700 mb-4">Danh sách học sinh</h3>
    <div id="studentList" class="space-y-3">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- CHI TIẾT HỌC SINH -->
  <div id="studentDetail" class="hidden bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-green-700" id="detailName"></h3>
      <button onclick="closeDetail()" class="text-red-600 hover:text-red-800 font-bold">Đóng</button>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-1 mb-6 border-b">
  <button class="tab tab-active" onclick="showTab('topic1')">Topic 1</button>
  <button class="tab tab-inactive" onclick="showTab('topic2')">Topic 2</button>
  <button class="tab tab-inactive" onclick="showTab('topic3')">Topic 3</button>
  <button class="tab tab-inactive" onclick="showTab('topic4')">Topic 4</button>
  <button class="tab tab-inactive" onclick="showTab('topic5')">Topic 5</button>
  <button class="tab tab-inactive" onclick="showTab('stats')">Statistics</button>
</div>

    <!-- Nội dung tab -->
    <div id="tab-topic1" class="space-y-6"></div>
<div id="tab-topic2" class="hidden space-y-6"></div>
<div id="tab-topic3" class="hidden space-y-6"></div>
<div id="tab-topic4" class="hidden space-y-6"></div>
<div id="tab-topic5" class="hidden space-y-6"></div>
<div id="tab-stats" class="hidden space-y-6"></div>

    <!-- Nút hành động -->
    <div class="flex gap-3 mt-6">
      <button onclick="saveEditedFeedback()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        Lưu Feedback Đã Sửa
      </button>
      <button onclick="exportPDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
        Export PDF
      </button>
    </div>
  </div>

</div>

<script>
  // THAY BẰNG URL WEB APP CỦA BẠN
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIp9jfs0GEOh_Y-0AnBBXXaX4AjsMHHW7SkZjDjJwtXFHicIqXyddq9IOZmEijXuu-Fg/exec';

  let currentWeek = 1;
  let currentStudent = null;
  let allSubmissions = [];
  let allStudents = [];
  let currentFeedback = {}; // Lưu feedback đang chỉnh sửa

  // Load khi mở trang
  window.onload = () => {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
    loadDashboard();
  };

  function loadDashboard() {
    currentWeek = document.getElementById('weekSelect').value;
    document.getElementById('studentList').innerHTML = '<div class="spinner"></div>';

    // Lấy danh sách nộp
    fetch(`${GOOGLE_SCRIPT_URL}?action=getSubmissions&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        allSubmissions = data.submissions || [];
        loadStudentList();
        loadOverview();
      })
      .catch(err => {
        document.getElementById('studentList').innerHTML = '<p class="text-red-600">Lỗi kết nối Apps Script!</p>';
        console.error(err);
      });

    // Lấy danh sách học sinh
    fetch(`${GOOGLE_SCRIPT_URL}?action=getAllStudents`)
      .then(r => r.json())
      .then(data => allStudents = data.students || [])
      .catch(() => allStudents = []);
  }

  function loadStudentList() {
    const list = document.getElementById('studentList');
    const submittedCodes = allSubmissions.map(s => s.code);
    const notSubmitted = allStudents.filter(s => !submittedCodes.includes(s.code));

    let html = '';
    [...allSubmissions, ...notSubmitted.map(s => ({...s, notSubmitted: true}))].sort((a,b) => a.code.localeCompare(b.code)).forEach(s => {
      const status = s.notSubmitted ? 'text-red-600' : 'text-green-600';
      const btn = s.notSubmitted ? '' : `<button onclick="viewStudent('${s.code}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Xem</button>`;
      html += `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
          <div>
            <span class="font-semibold">${s.code}</span> - 
            <span>${s.name || 'Chưa có tên'}</span>
            ${s.notSubmitted ? '<span class="text-red-500 text-sm ml-2">(Chưa nộp)</span>' : ''}
          </div>
          ${btn}
        </div>`;
    });
    list.innerHTML = html || '<p class="text-gray-500 text-center">Không có dữ liệu</p>';
  }

  function loadOverview() {
    const submitted = allSubmissions.length;
    const total = allStudents.length;
    document.getElementById('submittedCount').textContent = submitted;
    document.getElementById('totalStudents').textContent = total;

    const notSubmittedNames = allStudents.filter(s => !allSubmissions.find(sub => sub.code === s.code)).map(s => s.code).join(', ');
    document.getElementById('notSubmittedList').textContent = notSubmittedNames ? `Chưa nộp: ${notSubmittedNames}` : 'Tất cả đã nộp';

    // Giả lập thống kê (sẽ lấy thật từ API sau)
    document.getElementById('avgAnalysis').textContent = '7.8';
    document.getElementById('avgIntro').textContent = '6.5';

    // Biểu đồ CEFR
    const ctx = document.getElementById('cefrChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['C1/C2', 'B2+', 'B2', 'B1+', 'B1', 'A2'],
        datasets: [{
          data: [1, 2, 3, 5, 4, 0],
          backgroundColor: ['#4CAF50', '#8BC34A', '#2196F3', '#FFC107', '#FF9800', '#F44336']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  function viewStudent(code) {
    currentStudent = code;
    document.getElementById('studentDetail').classList.remove('hidden');
    document.getElementById('detailName').textContent = `${code} - Đang tải...`;
    document.getElementById('tab-topic1').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-topic2').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-stats').innerHTML = '<div class="spinner"></div>';

    fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentDetail&code=${code}&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        if (data.status === 'success') {
          renderStudentDetail(data);
        } else {
          alert('Không tìm thấy bài làm');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Lỗi kết nối');
      });
  }

  function renderStudentDetail(data) {
    const work = data.work;
    const name = work.studentName || 'Unknown';
    document.getElementById('detailName').textContent = `${currentStudent} - ${name}`;

currentFeedback = data;
const t1 = work.topic1;
const t2 = work.topic2;
const t3 = work.topic3;
const t4 = work.topic4;
const t5 = work.topic5;

 console.log('===== DEBUG TOPICS =====');
    console.log('Topic 1 SS:', t1?.ss);
    console.log('Topic 2 SS:', t2?.ss);
    console.log('Topic 3 SS:', t3?.ss);
    console.log('Topic 4 SS:', t4?.ss);
    console.log('Topic 5 SS:', t5?.ss);
    console.log('AI Feedback:', data.aiFeedback);
    console.log('Teacher Feedback:', data.teacherFeedback);

// === ĐỀ 1 ===
{
const fb1 = data.teacherFeedback?.topic1 || data.aiFeedback?.topic1 || {};

// ✨ ĐỌC VIETNAMESE FEEDBACK
const vnFeedback = fb1.vietnamese_feedback || {};
const analysisFb = fb1.analysis_feedback || {};
const introFb = fb1.introduction_feedback || {};

// ✨ ƯU TIÊN TIẾNG VIỆT
const strengthsVN = vnFeedback.strengths_vn || introFb.strengths || [];
const weaknessesVN = vnFeedback.weaknesses_vn || introFb.weaknesses || [];
const suggestions = vnFeedback.suggestions_vn || fb1.improvement_suggestions || [];

document.getElementById('tab-topic1').innerHTML = `
  <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
    <h4 class="font-bold text-blue-800 mb-3">ĐỀ 1: ${t1.title || 'APPEARANCE & SOCIETY'}</h4>
    <p class="text-sm italic mb-4">"${t1.prompt || '...'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Phân tích -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t1.ss || '—'}</div>
          <div><strong>IS:</strong> ${t1.is || '—'}</div>
          <div><strong>Q:</strong> ${t1.q || '—'}</div>
          <div><strong>T:</strong> ${t1.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t1.body1, t1.body2, t1.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <!-- Mở bài -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t1.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t1.wordCount || 0} | Thời gian: ${t1.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Tiết -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề (Score: <span class="text-blue-600">${fb1.analysis_score || 0}/10</span>)</h6>
          <textarea id="t1-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb.ss_correct ? '✅' : '❌'} - ${analysisFb.ss_comment || ''}
IS: ${analysisFb.is_correct ? '✅' : '❌'} - ${analysisFb.is_comment || ''}
Q: ${analysisFb.q_correct ? '✅' : '❌'} - ${analysisFb.q_comment || ''}
T: ${analysisFb.t_correct ? '✅' : '❌'} - ${analysisFb.t_comment || ''}
Outline Score: ${analysisFb.outline_score || 0}/2 - ${analysisFb.outline_comment || ''}

Overall: ${vnFeedback.summary || fb1.overall_comment || ''}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Mở bài (Score: <span class="text-blue-600">${fb1.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb1.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t1-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t1-structure" class="editable w-full mt-2" rows="5">Background (Nền/Bối cảnh): ${introFb.structure_breakdown?.background || 0}/1
Paraphrase (Diễn đạt lại đề): ${introFb.structure_breakdown?.paraphrase || 0}/1.5
Thesis (Câu chủ đề/Quan điểm): ${introFb.structure_breakdown?.thesis || 0}/2
General (Tổng quan/Chuyển ý): ${introFb.structure_breakdown?.general || 0}/0.5
Word Count (Số từ): ${introFb.word_count_score || 0}/1 (${introFb.word_count || 0} words)</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t1-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 2 ===
{
const fb2 = data.teacherFeedback?.topic2 || data.aiFeedback?.topic2 || {};

const vnFeedback = fb2.vietnamese_feedback || {};
const analysisFb = fb2.analysis_feedback || {};
const introFb = fb2.introduction_feedback || {};

const strengthsVN = vnFeedback.strengths_vn || introFb.strengths || [];
const weaknessesVN = vnFeedback.weaknesses_vn || introFb.weaknesses || [];
const suggestions = vnFeedback.suggestions_vn || fb2.improvement_suggestions || [];

document.getElementById('tab-topic2').innerHTML = `
  <div class="bg-gradient-to-r from-green-50 to-green-100 p-5 rounded-xl">
    <h4 class="font-bold text-green-800 mb-3">ĐỀ 2: ${t2.title || 'STUDENTS & SCHOOL DECISIONS'}</h4>
    <p class="text-sm italic mb-4">"${t2.prompt || 'Students should help to make decisions about what happens at school'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Phân tích -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t2.ss || '—'}</div>
          <div><strong>IS:</strong> ${t2.is || '—'}</div>
          <div><strong>Q:</strong> ${t2.q || '—'}</div>
          <div><strong>T:</strong> ${t2.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t2.body1, t2.body2, t2.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <!-- Mở bài -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t2.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t2.wordCount || 0} | Thời gian: ${t2.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Tiết -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề (Score: <span class="text-blue-600">${fb2.analysis_score || 0}/10</span>)</h6>
          <textarea id="t2-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb.ss_correct ? '✅' : '❌'} - ${analysisFb.ss_comment || ''}
IS: ${analysisFb.is_correct ? '✅' : '❌'} - ${analysisFb.is_comment || ''}
Q: ${analysisFb.q_correct ? '✅' : '❌'} - ${analysisFb.q_comment || ''}
T: ${analysisFb.t_correct ? '✅' : '❌'} - ${analysisFb.t_comment || ''}
Outline Score: ${analysisFb.outline_score || 0}/2 - ${analysisFb.outline_comment || ''}

Overall: ${vnFeedback.summary || fb2.overall_comment || ''}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Mở bài (Score: <span class="text-blue-600">${fb2.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb2.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t2-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t2-structure" class="editable w-full mt-2" rows="5">Background (Nền/Bối cảnh): ${introFb.structure_breakdown?.background || 0}/1
Paraphrase (Diễn đạt lại đề): ${introFb.structure_breakdown?.paraphrase || 0}/1.5
Thesis (Câu chủ đề/Quan điểm): ${introFb.structure_breakdown?.thesis || 0}/2
General (Tổng quan/Chuyển ý): ${introFb.structure_breakdown?.general || 0}/0.5
Word Count (Số từ): ${introFb.word_count_score || 0}/1 (${introFb.word_count || 0} words)</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t2-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 3 ===
{
const fb3 = data.teacherFeedback?.topic3 || data.aiFeedback?.topic3 || {};

const vnFeedback = fb3.vietnamese_feedback || {};
const analysisFb = fb3.analysis_feedback || {};
const introFb = fb3.introduction_feedback || {};

const strengthsVN = vnFeedback.strengths_vn || introFb.strengths || [];
const weaknessesVN = vnFeedback.weaknesses_vn || introFb.weaknesses || [];
const suggestions = vnFeedback.suggestions_vn || fb3.improvement_suggestions || [];

document.getElementById('tab-topic3').innerHTML = `
  <div class="bg-gradient-to-r from-teal-50 to-teal-100 p-5 rounded-xl">
    <h4 class="font-bold text-teal-800 mb-3">ĐỀ 3: ${t3.title || 'TECHNOLOGY & HAPPINESS'}</h4>
    <p class="text-sm italic mb-4">"${t3.prompt || 'Technology has made our lives easier but has it made us happier?'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t3.ss || '—'}</div>
          <div><strong>IS:</strong> ${t3.is || '—'}</div>
          <div><strong>Q:</strong> ${t3.q || '—'}</div>
          <div><strong>T:</strong> ${t3.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t3.body1, t3.body2, t3.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t3.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t3.wordCount || 0} | Thời gian: ${t3.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề (Score: <span class="text-blue-600">${fb3.analysis_score || 0}/10</span>)</h6>
          <textarea id="t3-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb.ss_correct ? '✅' : '❌'} - ${analysisFb.ss_comment || ''}
IS: ${analysisFb.is_correct ? '✅' : '❌'} - ${analysisFb.is_comment || ''}
Q: ${analysisFb.q_correct ? '✅' : '❌'} - ${analysisFb.q_comment || ''}
T: ${analysisFb.t_correct ? '✅' : '❌'} - ${analysisFb.t_comment || ''}
Outline Score: ${analysisFb.outline_score || 0}/2 - ${analysisFb.outline_comment || ''}

Overall: ${vnFeedback.summary || fb3.overall_comment || ''}</textarea>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Mở bài (Score: <span class="text-blue-600">${fb3.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb3.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t3-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t3-structure" class="editable w-full mt-2" rows="5">Background (Nền/Bối cảnh): ${introFb.structure_breakdown?.background || 0}/1
Paraphrase (Diễn đạt lại đề): ${introFb.structure_breakdown?.paraphrase || 0}/1.5
Thesis (Câu chủ đề/Quan điểm): ${introFb.structure_breakdown?.thesis || 0}/2
General (Tổng quan/Chuyển ý): ${introFb.structure_breakdown?.general || 0}/0.5
Word Count (Số từ): ${introFb.word_count_score || 0}/1 (${introFb.word_count || 0} words)</textarea>
          </div>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t3-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 4 ===
{
const fb4 = data.teacherFeedback?.topic4 || data.aiFeedback?.topic4 || {};

const vnFeedback = fb4.vietnamese_feedback || {};
const analysisFb = fb4.analysis_feedback || {};
const introFb = fb4.introduction_feedback || {};

const strengthsVN = vnFeedback.strengths_vn || introFb.strengths || [];
const weaknessesVN = vnFeedback.weaknesses_vn || introFb.weaknesses || [];
const suggestions = vnFeedback.suggestions_vn || fb4.improvement_suggestions || [];

document.getElementById('tab-topic4').innerHTML = `
  <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-5 rounded-xl">
    <h4 class="font-bold text-orange-800 mb-3">ĐỀ 4: ${t4.title || 'OPPORTUNITIES FOR YOUNG PEOPLE'}</h4>
    <p class="text-sm italic mb-4">"${t4.prompt || 'Young people today have more opportunities than their parents\' generation'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t4.ss || '—'}</div>
          <div><strong>IS:</strong> ${t4.is || '—'}</div>
          <div><strong>Q:</strong> ${t4.q || '—'}</div>
          <div><strong>T:</strong> ${t4.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t4.body1, t4.body2, t4.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t4.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t4.wordCount || 0} | Thời gian: ${t4.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề (Score: <span class="text-blue-600">${fb4.analysis_score || 0}/10</span>)</h6>
          <textarea id="t4-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb.ss_correct ? '✅' : '❌'} - ${analysisFb.ss_comment || ''}
IS: ${analysisFb.is_correct ? '✅' : '❌'} - ${analysisFb.is_comment || ''}
Q: ${analysisFb.q_correct ? '✅' : '❌'} - ${analysisFb.q_comment || ''}
T: ${analysisFb.t_correct ? '✅' : '❌'} - ${analysisFb.t_comment || ''}
Outline Score: ${analysisFb.outline_score || 0}/2 - ${analysisFb.outline_comment || ''}

Overall: ${vnFeedback.summary || fb4.overall_comment || ''}</textarea>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Mở bài (Score: <span class="text-blue-600">${fb4.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb4.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t4-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t4-structure" class="editable w-full mt-2" rows="5">Background (Nền/Bối cảnh): ${introFb.structure_breakdown?.background || 0}/1
Paraphrase (Diễn đạt lại đề): ${introFb.structure_breakdown?.paraphrase || 0}/1.5
Thesis (Câu chủ đề/Quan điểm): ${introFb.structure_breakdown?.thesis || 0}/2
General (Tổng quan/Chuyển ý): ${introFb.structure_breakdown?.general || 0}/0.5
Word Count (Số từ): ${introFb.word_count_score || 0}/1 (${introFb.word_count || 0} words)</textarea>
          </div>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t4-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 5 ===
{
const fb5 = data.teacherFeedback?.topic5 || data.aiFeedback?.topic5 || {};

const vnFeedback = fb5.vietnamese_feedback || {};
const analysisFb = fb5.analysis_feedback || {};
const introFb = fb5.introduction_feedback || {};

const strengthsVN = vnFeedback.strengths_vn || introFb.strengths || [];
const weaknessesVN = vnFeedback.weaknesses_vn || introFb.weaknesses || [];
const suggestions = vnFeedback.suggestions_vn || fb5.improvement_suggestions || [];

document.getElementById('tab-topic5').innerHTML = `
  <div class="bg-gradient-to-r from-pink-50 to-pink-100 p-5 rounded-xl">
    <h4 class="font-bold text-pink-800 mb-3">ĐỀ 5: ${t5.title || 'PRACTICAL LIFE SKILLS IN SCHOOLS'}</h4>
    <p class="text-sm italic mb-4">"${t5.prompt || 'Schools should teach practical life skills rather than just academic subjects'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t5.ss || '—'}</div>
          <div><strong>IS:</strong> ${t5.is || '—'}</div>
          <div><strong>Q:</strong> ${t5.q || '—'}</div>
          <div><strong>T:</strong> ${t5.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t5.body1, t5.body2, t5.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t5.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t5.wordCount || 0} | Thời gian: ${t5.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề (Score: <span class="text-blue-600">${fb5.analysis_score || 0}/10</span>)</h6>
          <textarea id="t5-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb.ss_correct ? '✅' : '❌'} - ${analysisFb.ss_comment || ''}
IS: ${analysisFb.is_correct ? '✅' : '❌'} - ${analysisFb.is_comment || ''}
Q: ${analysisFb.q_correct ? '✅' : '❌'} - ${analysisFb.q_comment || ''}
T: ${analysisFb.t_correct ? '✅' : '❌'} - ${analysisFb.t_comment || ''}
Outline Score: ${analysisFb.outline_score || 0}/2 - ${analysisFb.outline_comment || ''}

Overall: ${vnFeedback.summary || fb5.overall_comment || ''}</textarea>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Mở bài (Score: <span class="text-blue-600">${fb5.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb5.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t5-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t5-structure" class="editable w-full mt-2" rows="5">Background (Nền/Bối cảnh): ${introFb.structure_breakdown?.background || 0}/1
Paraphrase (Diễn đạt lại đề): ${introFb.structure_breakdown?.paraphrase || 0}/1.5
Thesis (Câu chủ đề/Quan điểm): ${introFb.structure_breakdown?.thesis || 0}/2
General (Tổng quan/Chuyển ý): ${introFb.structure_breakdown?.general || 0}/0.5
Word Count (Số từ): ${introFb.word_count_score || 0}/1 (${introFb.word_count || 0} words)</textarea>
          </div>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t5-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

    // === Tab Statistics (Work statistics for 5 topics) ===
document.getElementById('tab-stats').innerHTML = `
  <div class="bg-green-50 p-4 rounded-lg">
    <h5 class="font-bold text-green-700 mb-3">WORK STATISTICS</h5>
    <div class="space-y-2 text-sm">
      <p><strong>Total time:</strong> ${work.totalTime || '0m 0s'}</p>
      <p><strong>Topic 1 time:</strong> ${t1.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 2 time:</strong> ${t2.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 3 time:</strong> ${work.topic3?.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 4 time:</strong> ${work.topic4?.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 5 time:</strong> ${work.topic5?.timeUsed || '0m 0s'}</p>
      <p><strong>Total pastes:</strong> ${data.totalPastes || 0}</p>
      <p><strong>Total edits:</strong> ${data.totalEdits || 0}</p>
    </div>
  </div>
`;

  setTimeout(() => {
  document.querySelectorAll('#tab-topic1 .editable').forEach(textarea => {
    textarea.style.height = 'auto';
    textarea.style.height = (textarea.scrollHeight + 10) + 'px';
    textarea.style.overflowY = 'hidden';
  });
}, 100);
}

 function showTab(tab) {
  // Ẩn tất cả tab
  document.querySelectorAll('#studentDetail > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
  
  // Hiện tab được chọn
  const activeTab = document.getElementById(`tab-${tab}`);
  activeTab.classList.remove('hidden');

  // Active nút
  document.querySelectorAll('.tab').forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
  event.target.classList.replace('tab-inactive', 'tab-active');

  // QUAN TRỌNG: Chỉ resize textarea của tab đang hiện
  setTimeout(() => {
    activeTab.querySelectorAll('.editable').forEach(textarea => {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight + 10) + 'px';
      textarea.style.overflowY = 'hidden';
    });
  }, 50);
}

  function closeDetail() {
    document.getElementById('studentDetail').classList.add('hidden');
  }

function exportPDF() {
  if (!currentStudent) return alert('Chọn học sinh trước!');

  const studentName = document.getElementById('detailName').textContent.trim();
  const printWin = window.open('', '_blank');

  printWin.document.write(`
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>FCE Feedback - ${studentName}</title>
<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 0;
    padding: 0;
    color: #1f2937;
    line-height: 1.6;
    background: white;
  }
  .page {
    page-break-after: always;
    padding: 2cm 1.5cm 1.5cm 1.5cm;   /* trên 2cm, trái-phải-dưới 1.5cm */
    min-height: 29.7cm;
    position: relative;
  }
  .page:last-child { page-break-after: avoid; }

  .header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 3px solid #10b981;
  }
  .header img {
    height: 80px;
    margin-bottom: 8px;
  }
  .header h1 {
    font-size: 18pt;
    font-weight: bold;
    color: #065f46;
    margin: 8px 0 4px 0;
  }
  .header p {
    font-size: 12pt;
    color: #374151;
    margin: 4px 0;
  }

  .topic-title {
    font-size: 16pt;
    font-weight: bold;
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    margin: 25px 0 15px 0;
    display: inline-block;
  }
  .topic1 { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
  .topic2 { background: linear-gradient(135deg, #10b981, #059669); }
  .topic3 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
  .topic4 { background: linear-gradient(135deg, #f59e0b, #d97706); }
  .topic5 { background: linear-gradient(135deg, #ec4899, #db2777); }
  .stats { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

  .section {
    margin: 16px 0;
    background: #fffbeb;
    padding: 16px;
    border-radius: 8px;
    border-left: 6px solid #f59e0b;
    font-size: 12pt;
  }
  .section h3 {
    font-size: 14pt;
    margin: 0 0 10px 0;
    color: #92400e;
    font-weight: bold;
  }
  pre {
    white-space: pre-wrap;
    font-family: inherit;
    margin: 0;
    font-size: 12pt;
    line-height: 1.7;
  }

  .footer {
    position: absolute;
    bottom: 1cm;
    left: 1.5cm;
    right: 1.5cm;
    text-align: center;
    font-size: 10pt;
    color: #6b7280;
    border-top: 1px solid #e5e7eb;
    padding-top: 8px;
  }

  @page {
    size: A4;
    margin: 0;
  }
  @media print {
    body { padding: 0; }
    .page { box-shadow: none; padding: 2cm 1.5cm 1.5cm 1.5cm; }
  }
</style>
</head>
<body>

<div class="page">
  <div class="header">
    <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME Logo">
    <h1>FCE WRITING – FEEDBACK REPORT</h1>
    <p><strong>${studentName}</strong> • Week ${currentWeek} • ${new Date().toLocaleDateString('vi-VN')}</p>
    <p>Hotline: 090 123 4567 • Email: info@limeenglish.vn</p>
  </div>

  ${genTopic('topic1', 'TOPIC 1 – APPEARANCE & SOCIETY', 'topic1')}
  ${genTopic('topic2', 'TOPIC 2 – STUDENTS & SCHOOL DECISIONS', 'topic2')}
  ${genTopic('topic3', 'TOPIC 3 – TECHNOLOGY & HAPPINESS', 'topic3')}
  ${genTopic('topic4', 'TOPIC 4 – OPPORTUNITIES FOR YOUNG PEOPLE', 'topic4')}
  ${genTopic('topic5', 'TOPIC 5 – PRACTICAL LIFE SKILLS', 'topic5')}

  <div style="margin-top:30px">
    <div class="topic-title stats">THỐNG KÊ HOẠT ĐỘNG</div>
    <div class="section"><pre>${document.getElementById('tab-stats').innerText.trim()}</pre></div>
  </div>

  <div class="footer">
    LIME English Center • Địa chỉ: 123 Đường ABC, Quận 1, TP.HCM • www.limeenglish.vn
  </div>
</div>

</body>
</html>
`);

  function genTopic(id, title, cls) {
    const raw = document.getElementById('tab-' + id).innerHTML
      .replace(/<textarea/g, '<pre')
      .replace(/<\/textarea>/g, '</pre>')
      .replace(/contenteditable="true"/g, '')
      .replace(/class="editable[^"]*"/g, ''); // bỏ class lằng nhằng

    return `
    <div class="topic-title ${cls}">${title}</div>
    <div style="margin-bottom:25px">${raw}</div>`;
  }

  printWin.document.close();
  setTimeout(() => printWin.print(), 1000);
}

function saveEditedFeedback() {
  if (!currentStudent || !currentFeedback) {
    alert('Vui lòng chọn học sinh trước!');
    return;
  }

  // Helper lấy giá trị textarea an toàn (dù tab đang ẩn)
  function getValue(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
  }

  function parseStrengthsWeaknesses(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    const strengths = [], weaknesses = [];
    let section = null;
    lines.forEach(line => {
      if (line.includes('ĐIỂM MẠNH')) section = 'strengths';
      else if (line.includes('ĐIỂM YẾU')) section = 'weaknesses';
      else if ((line.startsWith('•') || line.startsWith('-') || line.match(/^\d+\./)) && line.length > 2) {
        const content = line.replace(/^[•\-\d.\s]+/, '').trim();
        if (content && !content.includes('Chưa có')) {
          if (section === 'strengths') strengths.push(content);
          else if (section === 'weaknesses') weaknesses.push(content);
        }
      }
    });
    return { strengths, weaknesses };
  }

  const payload = {
    action: 'saveTeacherFeedback',
    studentCode: currentStudent,
    weekNumber: currentWeek,
    studentName: document.getElementById('detailName').textContent.split(' - ')[1] || 'Unknown',
    teacherFeedback: {}  // Đổi cấu trúc cho rõ ràng
  };

  // Duyệt 5 topic
  for (let i = 1; i <= 5; i++) {
    const prefix = `t${i}`;
    const analysis = getValue(`${prefix}-analysis-full`);
    const swText = getValue(`${prefix}-strengths-weaknesses`);
    const structure = getValue(`${prefix}-structure`);
    const suggestions = getValue(`${prefix}-suggestions`);

    const { strengths, weaknesses } = parseStrengthsWeaknesses(swText);
    const suggs = suggestions.split('\n')
      .map(l => l.replace(/^[•\-\d.\s]+/, '').trim())
      .filter(Boolean);

    payload.teacherFeedback[`topic${i}`] = {
      analysis_full: analysis,
      strengths_vn: strengths,
      weaknesses_vn: weaknesses,
      structure_breakdown: structure,
      suggestions_vn: suggs,
      saved_at: new Date().toISOString()
    };
  }

  // Gửi lên Google Apps Script
  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'success') {
      alert('Đã lưu thành công feedback cho 5 đề!');
      currentFeedback.teacherFeedback = payload.teacherFeedback; // Cập nhật lại local
    } else {
      alert('Lỗi lưu: ' + (res.message || 'Unknown error'));
    }
  })
  .catch(err => {
    console.error(err);
    alert('Lỗi kết nối server!');
  });
}

// Auto-resize all editable textareas
function autoResizeTextareas() {
  document.querySelectorAll('.editable').forEach(textarea => {
    // Reset height to recalculate
    textarea.style.height = 'auto';
    // Set height based on scrollHeight
    textarea.style.height = (textarea.scrollHeight + 5) + 'px';
    
    // Add input listener for dynamic resize
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight + 5) + 'px';
    });
  });
}
  </script>

</body>
</html>