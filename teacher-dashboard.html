<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard - FCE Writing - LIME</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tab { @apply px-4 py-2 rounded-t-lg font-semibold transition; }
    .tab-active { @apply bg-white text-green-700 border-t-2 border-green-600; }
    .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    .editable {
  @apply p-4 border rounded-lg bg-yellow-50 border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500;
  min-height: 100px;
  overflow-y: auto;           /* Quan trọng nhất */
  resize: vertical;
  line-height: 1.6;
  max-height: 80vh;
  scrollbar-width: thin;      /* Firefox */
}
.editable::-webkit-scrollbar {
  width: 6px;
}
.editable::-webkit-scrollbar-track {
  background: #fefce8;
}
.editable::-webkit-scrollbar-thumb {
  background: #ca8a04;
  border-radius: 3px;
}
  </style>
</head>
<body class="min-h-screen p-4">

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-20 fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
        <div>
          <h1 class="text-2xl font-bold text-green-700">Teacher Dashboard</h1>
          <p class="text-green-600 text-sm">FCE Writing - Quản lý bài nộp & Feedback</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-600">
        <p>Giáo viên: <span class="font-semibold">Admin</span></p>
        <p id="currentDate"></p>
      </div>
    </div>
  </div>

  <!-- CHỌN TUẦN -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <label class="block text-green-800 font-semibold mb-2">Chọn Tuần</label>
    <select id="weekSelect" class="w-full md:w-64 px-4 py-3 border-2 border-green-300 rounded-lg text-lg" onchange="loadDashboard()">
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
    </select>
  </div>

  <!-- TỔNG QUAN & THỐNG KÊ -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">Tổng quan</h3>
      <p class="text-3xl font-bold text-green-600" id="submittedCount">0</p>
      <p class="text-sm text-gray-600">Đã nộp / <span id="totalStudents">0</span> học sinh</p>
      <p class="text-sm text-orange-600 mt-2" id="notSubmittedList"></p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
  <h3 class="text-xl font-bold text-green-700 mb-3">Average Scores (5 Topics)</h3>
  <div class="grid grid-cols-2 gap-4">
    <div>
      <p class="text-3xl font-bold text-blue-600" id="avgAnalysis">0.0</p>
      <p class="text-sm text-gray-600">Analysis</p>
    </div>
    <div>
      <p class="text-3xl font-bold text-purple-600" id="avgIntro">0.0</p>
      <p class="text-sm text-gray-600">Introduction</p>
    </div>
  </div>
</div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <canvas id="cefrChart" height="100"></canvas>
    </div>
  </div>

  <!-- DANH SÁCH HỌC SINH -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <h3 class="text-xl font-bold text-green-700 mb-4">Danh sách học sinh</h3>
    <div id="studentList" class="space-y-3">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- CHI TIẾT HỌC SINH -->
  <div id="studentDetail" class="hidden bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-green-700" id="detailName"></h3>
      <button onclick="closeDetail()" class="text-red-600 hover:text-red-800 font-bold">Đóng</button>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-1 mb-6 border-b">
  <button class="tab tab-active" onclick="showTab('topic1')">Topic 1</button>
  <button class="tab tab-inactive" onclick="showTab('topic2')">Topic 2</button>
  <button class="tab tab-inactive" onclick="showTab('topic3')">Topic 3</button>
  <button class="tab tab-inactive" onclick="showTab('topic4')">Topic 4</button>
  <button class="tab tab-inactive" onclick="showTab('topic5')">Topic 5</button>
  <button class="tab tab-inactive" onclick="showTab('stats')">Statistics</button>
</div>

    <!-- Nội dung tab -->
    <div id="tab-topic1" class="space-y-6"></div>
<div id="tab-topic2" class="hidden space-y-6"></div>
<div id="tab-topic3" class="hidden space-y-6"></div>
<div id="tab-topic4" class="hidden space-y-6"></div>
<div id="tab-topic5" class="hidden space-y-6"></div>
<div id="tab-stats" class="hidden space-y-6"></div>

    <!-- Nút hành động -->
    <div class="flex gap-3 mt-6">
      <button onclick="saveEditedFeedback()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        Lưu Feedback Đã Sửa
      </button>
      <button onclick="exportPDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
        Export PDF
      </button>
    </div>
  </div>

</div>

<script>
  // THAY BẰNG URL WEB APP CỦA BẠN
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIp9jfs0GEOh_Y-0AnBBXXaX4AjsMHHW7SkZjDjJwtXFHicIqXyddq9IOZmEijXuu-Fg/exec';

  let currentWeek = 1;
  let currentStudent = null;
  let allSubmissions = [];
  let allStudents = [];
  let currentFeedback = {}; // Lưu feedback đang chỉnh sửa

  // Load khi mở trang
  window.onload = () => {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
    loadDashboard();
  };

  function loadDashboard() {
    currentWeek = document.getElementById('weekSelect').value;
    document.getElementById('studentList').innerHTML = '<div class="spinner"></div>';

    // Lấy danh sách nộp
    fetch(`${GOOGLE_SCRIPT_URL}?action=getSubmissions&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        allSubmissions = data.submissions || [];
        loadStudentList();
        loadOverview();
      })
      .catch(err => {
        document.getElementById('studentList').innerHTML = '<p class="text-red-600">Lỗi kết nối Apps Script!</p>';
        console.error(err);
      });

    // Lấy danh sách học sinh
    fetch(`${GOOGLE_SCRIPT_URL}?action=getAllStudents`)
      .then(r => r.json())
      .then(data => allStudents = data.students || [])
      .catch(() => allStudents = []);
  }

  function loadStudentList() {
    const list = document.getElementById('studentList');
    const submittedCodes = allSubmissions.map(s => s.code);
    const notSubmitted = allStudents.filter(s => !submittedCodes.includes(s.code));

    let html = '';
    [...allSubmissions, ...notSubmitted.map(s => ({...s, notSubmitted: true}))].sort((a,b) => a.code.localeCompare(b.code)).forEach(s => {
      const status = s.notSubmitted ? 'text-red-600' : 'text-green-600';
      const btn = s.notSubmitted ? '' : `<button onclick="viewStudent('${s.code}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Xem</button>`;
      html += `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
          <div>
            <span class="font-semibold">${s.code}</span> - 
            <span>${s.name || 'Chưa có tên'}</span>
            ${s.notSubmitted ? '<span class="text-red-500 text-sm ml-2">(Chưa nộp)</span>' : ''}
          </div>
          ${btn}
        </div>`;
    });
    list.innerHTML = html || '<p class="text-gray-500 text-center">Không có dữ liệu</p>';
  }

  function loadOverview() {
    const submitted = allSubmissions.length;
    const total = allStudents.length;
    document.getElementById('submittedCount').textContent = submitted;
    document.getElementById('totalStudents').textContent = total;

    const notSubmittedNames = allStudents.filter(s => !allSubmissions.find(sub => sub.code === s.code)).map(s => s.code).join(', ');
    document.getElementById('notSubmittedList').textContent = notSubmittedNames ? `Chưa nộp: ${notSubmittedNames}` : 'Tất cả đã nộp';

    // Giả lập thống kê (sẽ lấy thật từ API sau)
    document.getElementById('avgAnalysis').textContent = '7.8';
    document.getElementById('avgIntro').textContent = '6.5';

    // Biểu đồ CEFR
    const ctx = document.getElementById('cefrChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['C1/C2', 'B2+', 'B2', 'B1+', 'B1', 'A2'],
        datasets: [{
          data: [1, 2, 3, 5, 4, 0],
          backgroundColor: ['#4CAF50', '#8BC34A', '#2196F3', '#FFC107', '#FF9800', '#F44336']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  function viewStudent(code) {
    currentStudent = code;
    document.getElementById('studentDetail').classList.remove('hidden');
    document.getElementById('detailName').textContent = `${code} - Đang tải...`;
    document.getElementById('tab-topic1').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-topic2').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-stats').innerHTML = '<div class="spinner"></div>';

    fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentDetail&code=${code}&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        if (data.status === 'success') {
          renderStudentDetail(data);
        } else {
          alert('Không tìm thấy bài làm');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Lỗi kết nối');
      });
  }

  function renderStudentDetail(data) {
    const work = data.work;
    const name = work.studentName || 'Unknown';
    document.getElementById('detailName').textContent = `${currentStudent} - ${name}`;

currentFeedback = data;
const t1 = work.topic1;
const t2 = work.topic2;
const t3 = work.topic3;
const t4 = work.topic4;
const t5 = work.topic5;

 console.log('===== DEBUG TOPICS =====');
    console.log('Topic 1 SS:', t1?.ss);
    console.log('Topic 2 SS:', t2?.ss);
    console.log('Topic 3 SS:', t3?.ss);
    console.log('Topic 4 SS:', t4?.ss);
    console.log('Topic 5 SS:', t5?.ss);
    console.log('AI Feedback:', data.aiFeedback);
    console.log('Teacher Feedback:', data.teacherFeedback);

// === ĐỀ 1 ===
{
const fb1 = data.teacherFeedback?.topic1 || data.aiFeedback?.topic1 || {};

// ✅ ĐƠN GIẢN: Lấy trực tiếp từ feedback đã lưu
const strengthsVN = fb1.strengths_vn || [];
const weaknessesVN = fb1.weaknesses_vn || [];
const suggestions = fb1.suggestions_vn || [];
const analysisText = fb1.analysis_full || '';
const structureText = fb1.structure_breakdown || '';

document.getElementById('tab-topic1').innerHTML = `
  <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
    <h4 class="font-bold text-blue-800 mb-3">ĐỀ 1: ${t1.title || 'APPEARANCE & SOCIETY'}</h4>
    <p class="text-sm italic mb-4">"${t1.prompt || '...'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Phân tích -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t1.ss || '—'}</div>
          <div><strong>IS:</strong> ${t1.is || '—'}</div>
          <div><strong>Q:</strong> ${t1.q || '—'}</div>
          <div><strong>T:</strong> ${t1.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t1.body1, t1.body2, t1.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <!-- Mở bài -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t1.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t1.wordCount || 0} | Thời gian: ${t1.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Tiết -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
  <h6 class="font-semibold text-gray-700">Phân tích đề</h6>
  <textarea id="t1-analysis-full" class="editable w-full mt-2" rows="6">${analysisText}</textarea>
</div>

        <!-- Introduction Feedback -->
       <div>
  <h6 class="font-semibold text-gray-700">Mở bài</h6>
  
  <div>
    <strong>Điểm mạnh & Điểm yếu:</strong>
    <textarea id="t1-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
  </div>

  <div class="mt-3">
    <strong>Breakdown điểm số chi tiết:</strong>
    <textarea id="t1-structure" class="editable w-full mt-2" rows="5">${structureText}</textarea>
  </div>
</div>
        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t1-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 2 ===
{
const fb2 = data.teacherFeedback?.topic2 || data.aiFeedback?.topic2 || {};

// ✅ ĐƠN GIẢN: Lấy trực tiếp từ feedback đã lưu
const strengthsVN = fb2.strengths_vn || [];
const weaknessesVN = fb2.weaknesses_vn || [];
const suggestions = fb2.suggestions_vn || [];
const analysisText = fb2.analysis_full || '';
const structureText = fb2.structure_breakdown || '';

document.getElementById('tab-topic2').innerHTML = `
  <div class="bg-gradient-to-r from-green-50 to-green-100 p-5 rounded-xl">
    <h4 class="font-bold text-green-800 mb-3">ĐỀ 2: ${t2.title || 'STUDENTS & SCHOOL DECISIONS'}</h4>
    <p class="text-sm italic mb-4">"${t2.prompt || 'Students should help to make decisions about what happens at school'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Phân tích -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t2.ss || '—'}</div>
          <div><strong>IS:</strong> ${t2.is || '—'}</div>
          <div><strong>Q:</strong> ${t2.q || '—'}</div>
          <div><strong>T:</strong> ${t2.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t2.body1, t2.body2, t2.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <!-- Mở bài -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t2.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t2.wordCount || 0} | Thời gian: ${t2.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Tiết -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề</h6>
          <textarea id="t2-analysis-full" class="editable w-full mt-2" rows="6">${analysisText}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Mở bài</h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t2-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t2-structure" class="editable w-full mt-2" rows="5">${structureText}</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t2-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 3 ===
{
const fb3 = data.teacherFeedback?.topic3 || data.aiFeedback?.topic3 || {};

// ✅ ĐƠN GIẢN: Lấy trực tiếp từ feedback đã lưu
const strengthsVN = fb3.strengths_vn || [];
const weaknessesVN = fb3.weaknesses_vn || [];
const suggestions = fb3.suggestions_vn || [];
const analysisText = fb3.analysis_full || '';
const structureText = fb3.structure_breakdown || '';

document.getElementById('tab-topic3').innerHTML = `
  <div class="bg-gradient-to-r from-teal-50 to-teal-100 p-5 rounded-xl">
    <h4 class="font-bold text-teal-800 mb-3">ĐỀ 3: ${t3.title || 'TECHNOLOGY & HAPPINESS'}</h4>
    <p class="text-sm italic mb-4">"${t3.prompt || 'Technology has made our lives easier but has it made us happier?'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t3.ss || '—'}</div>
          <div><strong>IS:</strong> ${t3.is || '—'}</div>
          <div><strong>Q:</strong> ${t3.q || '—'}</div>
          <div><strong>T:</strong> ${t3.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t3.body1, t3.body2, t3.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t3.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t3.wordCount || 0} | Thời gian: ${t3.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề</h6>
          <textarea id="t3-analysis-full" class="editable w-full mt-2" rows="6">${analysisText}</textarea>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Mở bài</h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t3-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t3-structure" class="editable w-full mt-2" rows="5">${structureText}</textarea>
          </div>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t3-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 4 ===
{
const fb4 = data.teacherFeedback?.topic4 || data.aiFeedback?.topic4 || {};

// ✅ ĐƠN GIẢN: Lấy trực tiếp từ feedback đã lưu
const strengthsVN = fb4.strengths_vn || [];
const weaknessesVN = fb4.weaknesses_vn || [];
const suggestions = fb4.suggestions_vn || [];
const analysisText = fb4.analysis_full || '';
const structureText = fb4.structure_breakdown || '';

document.getElementById('tab-topic4').innerHTML = `
  <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-5 rounded-xl">
    <h4 class="font-bold text-orange-800 mb-3">ĐỀ 4: ${t4.title || 'OPPORTUNITIES FOR YOUNG PEOPLE'}</h4>
    <p class="text-sm italic mb-4">"${t4.prompt || 'Young people today have more opportunities than their parents\' generation'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t4.ss || '—'}</div>
          <div><strong>IS:</strong> ${t4.is || '—'}</div>
          <div><strong>Q:</strong> ${t4.q || '—'}</div>
          <div><strong>T:</strong> ${t4.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t4.body1, t4.body2, t4.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t4.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t4.wordCount || 0} | Thời gian: ${t4.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề</h6>
          <textarea id="t4-analysis-full" class="editable w-full mt-2" rows="6">${analysisText}</textarea>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Mở bài</h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t4-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t4-structure" class="editable w-full mt-2" rows="5">${structureText}</textarea>
          </div>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t4-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ĐỀ 5 ===
{
const fb5 = data.teacherFeedback?.topic5 || data.aiFeedback?.topic5 || {};

// ✅ ĐƠN GIẢN: Lấy trực tiếp từ feedback đã lưu
const strengthsVN = fb5.strengths_vn || [];
const weaknessesVN = fb5.weaknesses_vn || [];
const suggestions = fb5.suggestions_vn || [];
const analysisText = fb5.analysis_full || '';
const structureText = fb5.structure_breakdown || '';

document.getElementById('tab-topic5').innerHTML = `
  <div class="bg-gradient-to-r from-pink-50 to-pink-100 p-5 rounded-xl">
    <h4 class="font-bold text-pink-800 mb-3">ĐỀ 5: ${t5.title || 'PRACTICAL LIFE SKILLS IN SCHOOLS'}</h4>
    <p class="text-sm italic mb-4">"${t5.prompt || 'Schools should teach practical life skills rather than just academic subjects'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t5.ss || '—'}</div>
          <div><strong>IS:</strong> ${t5.is || '—'}</div>
          <div><strong>Q:</strong> ${t5.q || '—'}</div>
          <div><strong>T:</strong> ${t5.t || '—'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t5.body1, t5.body2, t5.body3].filter(x=>x).join(' → ') || '—'}</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t5.introduction || '—'}</p>
        <p class="mt-2 text-xs text-gray-600">Số từ: ${t5.wordCount || 0} | Thời gian: ${t5.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NHẬN XÉT & ĐÁNH GIÁ</h5>
      
      <div class="space-y-4">
        <div>
          <h6 class="font-semibold text-gray-700">Phân tích đề</h6>
          <textarea id="t5-analysis-full" class="editable w-full mt-2" rows="6">${analysisText}</textarea>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Mở bài</h6>
          
          <div>
            <strong>Điểm mạnh & Điểm yếu:</strong>
            <textarea id="t5-strengths-weaknesses" class="editable w-full mt-2" rows="8">ĐIỂM MẠNH:
${strengthsVN.map(s => `• ${s}`).join('\n') || '• Chưa có'}

ĐIỂM YẾU:
${weaknessesVN.map(w => `• ${w}`).join('\n') || '• Chưa có'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown điểm số chi tiết:</strong>
            <textarea id="t5-structure" class="editable w-full mt-2" rows="5">${structureText}</textarea>
          </div>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">Gợi ý cải thiện:</h6>
          <textarea id="t5-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `• ${s}`).join('\n') || '• Chưa có'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

    // === Tab Statistics (Work statistics for 5 topics) ===
document.getElementById('tab-stats').innerHTML = `
  <div class="bg-green-50 p-4 rounded-lg">
    <h5 class="font-bold text-green-700 mb-3">WORK STATISTICS</h5>
    <div class="space-y-2 text-sm">
      <p><strong>Total time:</strong> ${work.totalTime || '0m 0s'}</p>
      <p><strong>Topic 1 time:</strong> ${t1.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 2 time:</strong> ${t2.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 3 time:</strong> ${work.topic3?.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 4 time:</strong> ${work.topic4?.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 5 time:</strong> ${work.topic5?.timeUsed || '0m 0s'}</p>
      <p><strong>Total pastes:</strong> ${data.totalPastes || 0}</p>
      <p><strong>Total edits:</strong> ${data.totalEdits || 0}</p>
    </div>
  </div>
`;

  setTimeout(() => {
  document.querySelectorAll('#tab-topic1 .editable').forEach(textarea => {
    textarea.style.height = 'auto';
    textarea.style.height = (textarea.scrollHeight + 10) + 'px';
    textarea.style.overflowY = 'hidden';
  });
}, 100);
}

 function showTab(tab) {
  // Ẩn tất cả tab
  document.querySelectorAll('#studentDetail > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
  
  // Hiện tab được chọn
  const activeTab = document.getElementById(`tab-${tab}`);
  activeTab.classList.remove('hidden');

  // Active nút
  document.querySelectorAll('.tab').forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
  event.target.classList.replace('tab-inactive', 'tab-active');

  // QUAN TRỌNG: Chỉ resize textarea của tab đang hiện
  setTimeout(() => {
    activeTab.querySelectorAll('.editable').forEach(textarea => {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight + 10) + 'px';
      textarea.style.overflowY = 'hidden';
    });
  }, 50);
}

  function closeDetail() {
    document.getElementById('studentDetail').classList.add('hidden');
  }

function exportPDF() {
  if (!currentStudent) return alert('Chọn học sinh trước!');

  const studentName = document.getElementById('detailName').textContent.trim();
  const printWin = window.open('', '_blank');

  const topics = ['topic1', 'topic2', 'topic3', 'topic4', 'topic5'];
  const topicTitles = [
    'TOPIC 1 – APPEARANCE & SOCIETY',
    'TOPIC 2 – STUDENTS & SCHOOL DECISIONS',
    'TOPIC 3 – TECHNOLOGY & HAPPINESS',
    'TOPIC 4 – OPPORTUNITIES FOR YOUNG PEOPLE',
    'TOPIC 5 – PRACTICAL LIFE SKILLS'
  ];
  const topicColors = ['topic1', 'topic2', 'topic3', 'topic4', 'topic5'];

  printWin.document.write(`
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>FCE Feedback - ${studentName}</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  @page {
    size: A4;
    margin: 1.5cm;  /* ✅ LỀ 1.5CM */
  }
  
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    color: #1f2937;
    line-height: 1.6;
    background: white;
    font-size: 13pt;
  }

  /* ===== TABLE LAYOUT ĐỂ HEADER/FOOTER TỰ ĐỘNG ===== */
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  thead {
    display: table-header-group;  /* ✅ TỰ ĐỘNG LẶP LẠI MỌI TRANG */
  }
  
  tfoot {
    display: table-footer-group;  /* ✅ TỰ ĐỘNG LẶP LẠI MỌI TRANG */
  }
  
  tbody {
    display: table-row-group;
  }

  /* ===== HEADER ===== */
  .page-header {
    text-align: center;
    padding-bottom: 0.3cm;
    border-bottom: 2px solid #10b981;
  }
  .page-header img {
    height: 35px;
    margin-bottom: 0.2cm;
  }
  .page-header p {
    font-size: 9pt;
    color: #374151;
    line-height: 1.2;
  }

  /* ===== FOOTER ===== */
  .page-footer {
    text-align: center;
    font-size: 9pt;
    color: #6b7280;
    border-top: 1px solid #e5e7eb;
    padding-top: 0.3cm;
  }

  /* ===== TIÊU ĐỀ CHÍNH (CHỈ TRANG 1) ===== */
  .main-title {
    text-align: center;
    margin: 0.5cm 0 0.6cm 0;
  }
  .main-title h1 {
    font-size: 18pt;
    font-weight: bold;
    color: #065f46;
    margin-bottom: 0.2cm;
  }
  .main-title p {
    font-size: 11pt;
    color: #374151;
  }

  /* ===== TOPIC TITLE ===== */
  .topic-title {
    font-size: 14pt;
    font-weight: bold;
    color: white;
    padding: 7px 12px;
    border-radius: 5px;
    margin: 0.6cm 0 0.3cm 0;
    display: inline-block;
  }
  .topic1 { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
  .topic2 { background: linear-gradient(135deg, #10b981, #059669); }
  .topic3 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
  .topic4 { background: linear-gradient(135deg, #f59e0b, #d97706); }
  .topic5 { background: linear-gradient(135deg, #ec4899, #db2777); }
  .stats { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

  /* ===== SECTION ===== */
  .section {
    margin: 0.3cm 0;
    background: #fffbeb;
    padding: 0.35cm 0.4cm;
    border-radius: 5px;
    border-left: 3px solid #f59e0b;
  }
  .section h3 {
    font-size: 12pt;
    margin-bottom: 0.25cm;
    color: #92400e;
    font-weight: 600;
  }
  .section pre {
    white-space: pre-wrap;
    font-family: inherit;
    font-size: 12pt;
    line-height: 1.5;
    margin: 0;
  }

  @media print {
    body { 
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }
</style>
</head>
<body>

<table>
  <!-- ✅ HEADER (LẶP LẠI MỌI TRANG) -->
  <thead>
    <tr>
      <td>
        <div class="page-header">
          <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME">
          <p>Hotline: 0976222792 • Email: info.limeschool@gmail.com</p>
        </div>
      </td>
    </tr>
  </thead>

  <!-- ✅ FOOTER (LẶP LẠI MỌI TRANG) -->
  <tfoot>
    <tr>
      <td>
        <div class="page-footer">
          LIME English Center • Địa chỉ: Yên Hòa - Mỹ Đình, Hà Nội • www.lime.edu.vn
        </div>
      </td>
    </tr>
  </tfoot>

  <!-- ✅ NỘI DUNG CHÍNH -->
  <tbody>
    <tr>
      <td>
        <!-- TIÊU ĐỀ CHÍNH (CHỈ TRANG 1) -->
        <div class="main-title">
          <h1>FCE WRITING – FEEDBACK REPORT</h1>
          <p><strong>${studentName}</strong> • Week ${currentWeek} • ${new Date().toLocaleDateString('vi-VN')}</p>
        </div>

        <!-- NỘI DUNG CÁC TOPIC -->
        ${topics.map((topic, index) => generateTopic(index)).join('')}

        <!-- STATISTICS -->
        <div class="topic-title stats">THỐNG KÊ HOẠT ĐỘNG</div>
        <div class="section">
          <pre>${document.getElementById('tab-stats')?.innerText.trim() || 'Không có dữ liệu'}</pre>
        </div>
      </td>
    </tr>
  </tbody>
</table>

</body>
</html>
`);

  function generateTopic(index) {
    const tabId = topics[index];
    const title = topicTitles[index];
    const colorClass = topicColors[index];
    const tab = document.getElementById('tab-' + tabId);
    
    if (!tab) return '';
    
    const textareas = tab.querySelectorAll('textarea.editable');
    let html = `<div class="topic-title ${colorClass}">${title}</div>`;
    
    textareas.forEach(textarea => {
      let label = 'Nội dung';
      const prevElement = textarea.previousElementSibling;
      if (prevElement && prevElement.tagName === 'STRONG') {
        label = prevElement.textContent;
      } else if (prevElement?.querySelector) {
        const strong = prevElement.querySelector('strong');
        if (strong) label = strong.textContent;
      }
      
      html += `
        <div class="section">
          <h3>${label}</h3>
          <pre>${textarea.value}</pre>
        </div>`;
    });
    
    return html;
  }

  printWin.document.close();
  setTimeout(() => printWin.print(), 500);
}

function saveEditedFeedback() {
  if (!currentStudent || !currentFeedback) {
    alert('Vui lòng chọn học sinh trước!');
    return;
  }

  // Helper lấy giá trị textarea an toàn (dù tab đang ẩn)
  function getValue(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
  }

  function parseStrengthsWeaknesses(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    const strengths = [], weaknesses = [];
    let section = null;
    lines.forEach(line => {
      if (line.includes('ĐIỂM MẠNH')) section = 'strengths';
      else if (line.includes('ĐIỂM YẾU')) section = 'weaknesses';
      else if ((line.startsWith('•') || line.startsWith('-') || line.match(/^\d+\./)) && line.length > 2) {
        const content = line.replace(/^[•\-\d.\s]+/, '').trim();
        if (content && !content.includes('Chưa có')) {
          if (section === 'strengths') strengths.push(content);
          else if (section === 'weaknesses') weaknesses.push(content);
        }
      }
    });
    return { strengths, weaknesses };
  }

  const payload = {
    action: 'saveTeacherFeedback',
    studentCode: currentStudent,
    weekNumber: currentWeek,
    studentName: document.getElementById('detailName').textContent.split(' - ')[1] || 'Unknown',
    teacherFeedback: {}  // Đổi cấu trúc cho rõ ràng
  };

  // Duyệt 5 topic
  for (let i = 1; i <= 5; i++) {
    const prefix = `t${i}`;
    const analysis = getValue(`${prefix}-analysis-full`);
    const swText = getValue(`${prefix}-strengths-weaknesses`);
    const structure = getValue(`${prefix}-structure`);
    const suggestions = getValue(`${prefix}-suggestions`);

    const { strengths, weaknesses } = parseStrengthsWeaknesses(swText);
    const suggs = suggestions.split('\n')
      .map(l => l.replace(/^[•\-\d.\s]+/, '').trim())
      .filter(Boolean);

    payload.teacherFeedback[`topic${i}`] = {
      analysis_full: analysis,
      strengths_vn: strengths,
      weaknesses_vn: weaknesses,
      structure_breakdown: structure,
      suggestions_vn: suggs,
      saved_at: new Date().toISOString()
    };
  }

  // Gửi lên Google Apps Script
fetch(GOOGLE_SCRIPT_URL, {
  method: 'POST',
  mode: 'cors',                    // bắt buộc có
  cache: 'no-cache',
  // BỎ HOÀN TOÀN header Content-Type → tự động thành text/plain → bypass preflight
  body: JSON.stringify(payload)
})
.then(r => {
  if (!r.ok) throw new Error(`Server error: ${r.status}`);
  return r.text();                 // đọc text
})
.then(text => {
  let res;
  try { res = JSON.parse(text); } 
  catch(e) { console.log('Response không phải JSON, nhưng vẫn lưu được:', text); }
  
  alert('Đã lưu thành công tất cả 5 đề!');
  setTimeout(() => location.reload(), 800);  // reload để in ra nội dung mới
})
.catch(err => {
  console.error('Lỗi lưu feedback:', err);
  alert('Lỗi mạng hoặc server. Kiểm tra console (F12) để xem chi tiết.');
});
}

// Auto-resize all editable textareas
function autoResizeTextareas() {
  document.querySelectorAll('.editable').forEach(textarea => {
    // Reset height to recalculate
    textarea.style.height = 'auto';
    // Set height based on scrollHeight
    textarea.style.height = (textarea.scrollHeight + 5) + 'px';
    
    // Add input listener for dynamic resize
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight + 5) + 'px';
    });
  });
}
  </script>

</body>
</html>