<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - FCE Writing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%);
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .student-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .student-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .editable-feedback {
            border: 2px dashed #ccc;
            padding: 12px;
            border-radius: 8px;
            background: #FFFEF7;
            cursor: text;
            min-height: 100px;
        }
        .editable-feedback:hover {
            border-color: #2196F3;
            background: #FFF9E6;
        }
        .editable-feedback:focus {
            outline: none;
            border-color: #2196F3;
            border-style: solid;
        }
        .tab-button {
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }
        .tab-button.active {
            background: white;
            color: #2196F3;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }
        .tab-button:not(.active) {
            background: rgba(255,255,255,0.5);
            color: #666;
        }
    </style>
</head>
<body>

<!-- M√ÄN H√åNH PASSWORD -->
<div id="passwordScreen" class="min-h-screen flex items-center justify-center p-4 fade-in">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
        <div class="text-center mb-8">
            <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                 alt="LIME Logo" class="w-24 h-24 mx-auto mb-4 object-contain">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">üë®‚Äçüè´ Teacher Dashboard</h1>
            <p class="text-gray-600">FCE Writing - H·ªá th·ªëng ch·∫•m b√†i</p>
            <div class="mt-4 h-1 w-32 bg-blue-500 mx-auto rounded"></div>
        </div>
        
        <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">üîê M·∫≠t kh·∫©u gi√°o vi√™n:</label>
            <input type="password" id="passwordInput" 
                class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-lg"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
                onkeypress="if(event.key==='Enter') verifyPassword()">
        </div>

        <button onclick="verifyPassword()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
            X√ÅC NH·∫¨N
        </button>
        
        <div class="mt-4 text-center text-sm text-gray-500">
            üìû Li√™n h·ªá: 0976222792
        </div>
    </div>
</div>

<!-- M√ÄN H√åNH DASHBOARD -->
<div id="dashboardScreen" class="hidden min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                         alt="LIME Logo" class="w-16 h-16 object-contain">
                    <div>
                        <h1 class="text-3xl font-bold text-blue-700">üë®‚Äçüè´ Teacher Dashboard</h1>
                        <p class="text-gray-600">FCE Writing - Qu·∫£n l√Ω & ch·∫•m b√†i</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Ch·ªçn tu·∫ßn:</label>
                        <select id="weekSelect" onchange="loadWeekData()" 
                            class="px-4 py-2 border-2 border-blue-300 rounded-lg font-semibold text-blue-700">
                            <option value="1">Week 1</option>
                            <option value="2">Week 2</option>
                            <option value="3">Week 3</option>
                        </select>
                    </div>
                    <button onclick="location.reload()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold">
                        üîÑ L√†m m·ªõi
                    </button>
                </div>
            </div>
        </div>

        <!-- Th·ªëng k√™ t·ªïng quan -->
        <div id="statsSection" class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä T·ªïng quan</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 text-center">
                    <p class="text-green-600 text-sm mb-1">ƒê√£ n·ªôp b√†i</p>
                    <p id="statSubmitted" class="text-3xl font-bold text-green-700">0</p>
                </div>
                <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center">
                    <p class="text-red-600 text-sm mb-1">Ch∆∞a n·ªôp</p>
                    <p id="statPending" class="text-3xl font-bold text-red-700">0</p>
                </div>
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 text-center">
                    <p class="text-blue-600 text-sm mb-1">ƒêi·ªÉm TB</p>
                    <p id="statAverage" class="text-3xl font-bold text-blue-700">--</p>
                </div>
                <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-4 text-center">
                    <p class="text-purple-600 text-sm mb-1">Level TB</p>
                    <p id="statLevel" class="text-xl font-bold text-purple-700">N/A</p>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch h·ªçc sinh -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üë®‚Äçüéì Danh s√°ch h·ªçc sinh ƒë√£ n·ªôp</h2>
            
            <div id="studentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- S·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
            </div>
            
            <div id="noStudents" class="hidden text-center py-12 text-gray-500">
                <svg class="w-24 h-24 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-xl">Ch∆∞a c√≥ h·ªçc sinh n√†o n·ªôp b√†i</p>
            </div>
        </div>
    </div>
</div>

<!-- M√ÄN H√åNH XEM CHI TI·∫æT -->
<div id="reviewScreen" class="hidden min-h-screen p-4 pb-32">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-10">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <button onclick="backToDashboard()" class="text-blue-600 hover:text-blue-800 font-semibold mb-2">
                        ‚Üê Quay l·∫°i danh s√°ch
                    </button>
                    <h1 class="text-2xl font-bold text-gray-800">
                        üìù <span id="reviewStudentName">H·ªçc sinh</span> (<span id="reviewStudentCode">HS001</span>)
                    </h1>
                    <p class="text-sm text-gray-600">
                        üìÖ N·ªôp l√∫c: <span id="reviewTimestamp">--</span> | 
                        ‚è±Ô∏è Th·ªùi gian: <span id="reviewTime">--</span>
                    </p>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="saveEdits()" id="saveBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg">
                        üíæ L∆∞u ch·ªânh s·ª≠a
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-t-2xl shadow-lg p-4 mb-0">
            <div class="flex gap-2">
                <div class="tab-button active" onclick="switchTab('topic1')" id="tab1">üìù ƒê·ªÅ 1</div>
                <div class="tab-button" onclick="switchTab('topic2')" id="tab2">üìù ƒê·ªÅ 2</div>
                <div class="tab-button" onclick="switchTab('behavior')" id="tab3">üìä H√†nh vi</div>
            </div>
        </div>

        <!-- Content Tabs -->
        <div id="tabContent" class="bg-white rounded-b-2xl rounded-tr-2xl shadow-2xl p-8">
            <!-- Topic 1 -->
            <div id="topic1Content" class="fade-in">
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6 rounded-r-lg">
                    <h3 class="font-bold text-blue-800 text-lg">üìã ƒê·ªÅ b√†i ƒë·∫ßy ƒë·ªß:</h3>
                    <p class="text-blue-900 mt-2" id="topic1Prompt">Loading...</p>
                </div>

                <!-- Ph·∫ßn 1: Ph√¢n t√≠ch ƒë·ªÅ -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-blue-500 pb-2">
                        PH·∫¶N 1: PH√ÇN T√çCH ƒê·ªÄ B√ÄI
                    </h3>
                    
                    <div class="bg-gray-50 rounded-xl p-6 mb-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">1. SS (Specific Subject):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t1_ss">--</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">2. IS (Independent Subject):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t1_is">--</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">3. Q (Question):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t1_q">--</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">4. T (Tasks):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t1_t">--</p>
                            </div>
                        </div>
                        
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">Outline:</p>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-600">Body 1:</p>
                                    <p class="font-semibold" id="t1_body1">--</p>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-600">Body 2:</p>
                                    <p class="font-semibold" id="t1_body2">--</p>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-600">Body 3:</p>
                                    <p class="font-semibold" id="t1_body3">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback AI ph√¢n t√≠ch -->
                    <div class="bg-blue-50 rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-blue-800">ü§ñ Nh·∫≠n x√©t AI:</h4>
                            <div class="flex items-center gap-4">
                                <label class="text-sm font-semibold text-gray-700">ƒêi·ªÉm ph√¢n t√≠ch:</label>
                                <input type="number" id="t1_analysis_score" min="0" max="10" step="0.5"
                                    class="w-20 px-3 py-2 border-2 border-blue-300 rounded-lg font-bold text-blue-700 text-center"
                                    value="0">
                                <span class="text-gray-600">/ 10</span>
                            </div>
                        </div>
                        
                        <div contenteditable="true" class="editable-feedback" id="t1_analysis_feedback">
                            Click ƒë·ªÉ ch·ªânh s·ª≠a nh·∫≠n x√©t...
                        </div>
                    </div>
                </div>

                <!-- Ph·∫ßn 2: M·ªü b√†i -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-blue-500 pb-2">
                        PH·∫¶N 2: ƒêO·∫†N M·ªû B√ÄI
                    </h3>
                    
                    <div class="bg-gray-50 rounded-xl p-6 mb-4">
                        <p class="font-semibold text-gray-700 mb-2">B√†i vi·∫øt c·ªßa h·ªçc sinh:</p>
                        <div class="bg-white p-4 rounded border-2 border-gray-300 italic" id="t1_intro">--</div>
                        <p class="text-sm text-gray-600 mt-2">
                            üìù S·ªë t·ª´: <span id="t1_wordcount" class="font-semibold">0</span> | 
                            ‚è±Ô∏è Th·ªùi gian: <span id="t1_time" class="font-semibold">--</span>
                        </p>
                    </div>

                    <!-- Feedback AI m·ªü b√†i -->
                    <div class="bg-purple-50 rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-purple-800">ü§ñ Nh·∫≠n x√©t AI:</h4>
                            <div class="flex items-center gap-4">
                                <label class="text-sm font-semibold text-gray-700">ƒêi·ªÉm m·ªü b√†i:</label>
                                <input type="number" id="t1_intro_score" min="0" max="10" step="0.5"
                                    class="w-20 px-3 py-2 border-2 border-purple-300 rounded-lg font-bold text-purple-700 text-center"
                                    value="0">
                                <span class="text-gray-600">/ 10</span>
                                
                                <label class="text-sm font-semibold text-gray-700 ml-4">Level:</label>
                                <select id="t1_cefr" class="px-3 py-2 border-2 border-purple-300 rounded-lg font-bold">
                                    <option value="A2">A2</option>
                                    <option value="A2+">A2+</option>
                                    <option value="B1">B1</option>
                                    <option value="B1+">B1+</option>
                                    <option value="B2">B2</option>
                                    <option value="B2+">B2+</option>
                                    <option value="C1">C1</option>
                                </select>
                            </div>
                        </div>
                        
                        <div contenteditable="true" class="editable-feedback" id="t1_intro_feedback">
                            Click ƒë·ªÉ ch·ªânh s·ª≠a nh·∫≠n x√©t...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topic 2 -->
            <div id="topic2Content" class="hidden">
                <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-6 rounded-r-lg">
                    <h3 class="font-bold text-purple-800 text-lg">üìã ƒê·ªÅ b√†i ƒë·∫ßy ƒë·ªß:</h3>
                    <p class="text-purple-900 mt-2" id="topic2Prompt">Loading...</p>
                </div>

                <!-- Ph·∫ßn 1: Ph√¢n t√≠ch ƒë·ªÅ -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-purple-500 pb-2">
                        PH·∫¶N 1: PH√ÇN T√çCH ƒê·ªÄ B√ÄI
                    </h3>
                    
                    <div class="bg-gray-50 rounded-xl p-6 mb-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">1. SS (Specific Subject):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t2_ss">--</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">2. IS (Independent Subject):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t2_is">--</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">3. Q (Question):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t2_q">--</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700 mb-2">4. T (Tasks):</p>
                                <p class="text-gray-900 bg-white p-3 rounded border" id="t2_t">--</p>
                            </div>
                        </div>
                        
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">Outline:</p>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-600">Body 1:</p>
                                    <p class="font-semibold" id="t2_body1">--</p>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-600">Body 2:</p>
                                    <p class="font-semibold" id="t2_body2">--</p>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-sm text-gray-600">Body 3:</p>
                                    <p class="font-semibold" id="t2_body3">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-blue-800">ü§ñ Nh·∫≠n x√©t AI:</h4>
                            <div class="flex items-center gap-4">
                                <label class="text-sm font-semibold text-gray-700">ƒêi·ªÉm ph√¢n t√≠ch:</label>
                                <input type="number" id="t2_analysis_score" min="0" max="10" step="0.5"
                                    class="w-20 px-3 py-2 border-2 border-blue-300 rounded-lg font-bold text-blue-700 text-center"
                                    value="0">
                                <span class="text-gray-600">/ 10</span>
                            </div>
                        </div>
                        
                        <div contenteditable="true" class="editable-feedback" id="t2_analysis_feedback">
                            Click ƒë·ªÉ ch·ªânh s·ª≠a nh·∫≠n x√©t...
                        </div>
                    </div>
                </div>

                <!-- Ph·∫ßn 2: M·ªü b√†i -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-purple-500 pb-2">
                        PH·∫¶N 2: ƒêO·∫†N M·ªû B√ÄI
                    </h3>
                    
                    <div class="bg-gray-50 rounded-xl p-6 mb-4">
                        <p class="font-semibold text-gray-700 mb-2">B√†i vi·∫øt c·ªßa h·ªçc sinh:</p>
                        <div class="bg-white p-4 rounded border-2 border-gray-300 italic" id="t2_intro">--</div>
                        <p class="text-sm text-gray-600 mt-2">
                            üìù S·ªë t·ª´: <span id="t2_wordcount" class="font-semibold">0</span> | 
                            ‚è±Ô∏è Th·ªùi gian: <span id="t2_time" class="font-semibold">--</span>
                        </p>
                    </div>

                    <div class="bg-purple-50 rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-purple-800">ü§ñ Nh·∫≠n x√©t AI:</h4>
                            <div class="flex items-center gap-4">
                                <label class="text-sm font-semibold text-gray-700">ƒêi·ªÉm m·ªü b√†i:</label>
                                <input type="number" id="t2_intro_score" min="0" max="10" step="0.5"
                                    class="w-20 px-3 py-2 border-2 border-purple-300 rounded-lg font-bold text-purple-700 text-center"
                                    value="0">
                                <span class="text-gray-600">/ 10</span>
                                
                                <label class="text-sm font-semibold text-gray-700 ml-4">Level:</label>
                                <select id="t2_cefr" class="px-3 py-2 border-2 border-purple-300 rounded-lg font-bold">
                                    <option value="A2">A2</option>
                                    <option value="A2+">A2+</option>
                                    <option value="B1">B1</option>
                                    <option value="B1+">B1+</option>
                                    <option value="B2">B2</option>
                                    <option value="B2+">B2+</option>
                                    <option value="C1">C1</option>
                                </select>
                            </div>
                        </div>
                        
                        <div contenteditable="true" class="editable-feedback" id="t2_intro_feedback">
                            Click ƒë·ªÉ ch·ªânh s·ª≠a nh·∫≠n x√©t...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Behavior Tab -->
            <div id="behaviorContent" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Ph√¢n t√≠ch h√†nh vi l√†m b√†i</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-50 rounded-xl p-6">
                        <h4 class="font-bold text-blue-800 mb-4">‚è±Ô∏è Th·ªùi gian ph√¢n b·ªï</h4>
                        <div class="space-y-2" id="timeBreakdown">
                            <p class="text-gray-500">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 rounded-xl p-6">
                        <h4 class="font-bold text-yellow-800 mb-4">‚úèÔ∏è Ch·ªânh s·ª≠a & Paste</h4>
                        <div class="space-y-2" id="editStats">
                            <p class="text-gray-500">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ========== CONFIGURATION ==========
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIp9jfs0GEOh_Y-0AnBBXXaX4AjsMHHW7SkZjDjJwtXFHicIqXyddq9IOZmEijXuu-Fg/exec';
const TEACHER_PASSWORD = 'lime2025';

// ========== ƒê·ªÄ B√ÄI ==========
const TOPICS = {
    1: {
        topic1: {
            title: "APPEARANCE & SOCIETY",
            prompt: `"We are much too worried about how people and things look. Do you agree?"

Points to consider:
‚Ä¢ being like your friends
‚Ä¢ the effect of celebrities
‚Ä¢ your own idea

Many people believe that in modern society, we place too much emphasis on appearance - how people look, what they wear, and how things appear on the surface. Some argue this focus on looks comes from wanting to fit in with friends, the influence of celebrities and social media, and societal pressure to maintain certain standards.`
        },
        topic2: {
            title: "STUDENTS & SCHOOL DECISIONS",
            prompt: `"Do you think that students should help to make decisions about what happens at school?"

Points to consider:
‚Ä¢ the subjects children study
‚Ä¢ school rules
‚Ä¢ your own idea

There is ongoing debate about whether students should have a voice in school decisions. Some believe students should participate in choosing subjects they study, creating school rules, and other aspects of school life. Others think these decisions should remain with teachers and administrators.`
        }
    }
};

// ========== GLOBAL VARIABLES ==========
let currentWeek = 1;
let currentStudent = null;
let allStudents = [];
let currentStudentData = null;

// ========== PASSWORD VERIFICATION ==========
function verifyPassword() {
    const password = document.getElementById('passwordInput').value;
    
    if (password === TEACHER_PASSWORD) {
        document.getElementById('passwordScreen').classList.add('hidden');
        document.getElementById('dashboardScreen').classList.remove('hidden');
        loadWeekData();
    } else {
        alert('‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
        document.getElementById('passwordInput').value = '';
    }
}

// ========== LOAD WEEK DATA ==========
async function loadWeekData() {
    currentWeek = document.getElementById('weekSelect').value;
    
    showLoading('studentList', 'ƒêang t·∫£i d·ªØ li·ªáu...');
    
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSubmissions&week=${currentWeek}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            allStudents = data.submissions || [];
            displayStudentList(allStudents);
            updateStats(allStudents);
        } else {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('studentList').innerHTML = `
            <div class="col-span-full text-center text-red-600 p-8">
                ‚ùå L·ªói k·∫øt n·ªëi! Vui l√≤ng ki·ªÉm tra Internet ho·∫∑c th·ª≠ l·∫°i.
            </div>
        `;
    }
}

// ========== DISPLAY STUDENT LIST ==========
function displayStudentList(students) {
    const container = document.getElementById('studentList');
    const noStudents = document.getElementById('noStudents');
    
    if (!students || students.length === 0) {
        container.classList.add('hidden');
        noStudents.classList.remove('hidden');
        return;
    }
    
    container.classList.remove('hidden');
    noStudents.classList.add('hidden');
    
    container.innerHTML = students.map(student => {
        const statusBadge = student.aiStatus === 'DONE' 
            ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded">‚úÖ ƒê√£ ch·∫•m</span>'
            : '<span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded">‚è≥ ƒêang ch·∫•m</span>';
        
        return `
            <div class="student-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-md"
                 onclick="viewStudentDetail('${student.code}')">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${student.name || 'Kh√¥ng c√≥ t√™n'}</h3>
                        <p class="text-sm text-gray-600">${student.code || ''}</p>
                    </div>
                    ${statusBadge}
                </div>
                
                <div class="text-sm text-gray-600 space-y-1">
                    <p>üìÖ ${student.timestamp || '--'}</p>
                    <p>‚è±Ô∏è ${student.totalTime || '--'}</p>
                </div>
                
                <button class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition">
                    üëÅÔ∏è Xem chi ti·∫øt
                </button>
            </div>
        `;
    }).join('');
}

// ========== UPDATE STATISTICS ==========
function updateStats(students) {
    const submitted = students.length;
    const pending = Math.max(0, 20 - submitted);
    
    document.getElementById('statSubmitted').textContent = submitted;
    document.getElementById('statPending').textContent = pending;
    
    // T√≠nh ƒëi·ªÉm trung b√¨nh (s·∫Ω c·∫≠p nh·∫≠t sau)
    document.getElementById('statAverage').textContent = '--';
    document.getElementById('statLevel').textContent = '--';
}

// ========== VIEW STUDENT DETAIL ==========
async function viewStudentDetail(studentCode) {
    currentStudent = studentCode;
    
    document.getElementById('dashboardScreen').classList.add('hidden');
    document.getElementById('reviewScreen').classList.remove('hidden');
    
    showLoading('tabContent', 'ƒêang t·∫£i chi ti·∫øt...');
    
    try {
        const response = await fetch(
            `${GOOGLE_SCRIPT_URL}?action=getStudentDetail&code=${studentCode}&week=${currentWeek}`
        );
        const data = await response.json();
        
        if (data.status === 'success') {
            currentStudentData = data;
            displayStudentDetail(data);
        } else {
            throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu h·ªçc sinh!');
        backToDashboard();
    }
}

// ========== DISPLAY STUDENT DETAIL ==========
function displayStudentDetail(data) {
    // Ki·ªÉm tra c·∫•u tr√∫c d·ªØ li·ªáu
    if (!data.work) {
        alert('‚ùå D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!');
        backToDashboard();
        return;
    }

    const work = data.work;
    const aiStatus = data.aiStatus || 'PENDING';
    const feedbackSource = data.feedbackSource || 'pending';
    
    // Ch·ªçn feedback (∆∞u ti√™n Teacher > AI)
    let feedback = data.teacherFeedback || data.aiFeedback;
    
    // Header info
    document.getElementById('reviewStudentName').textContent = work.studentName || 'N/A';
    document.getElementById('reviewStudentCode').textContent = work.studentCode || 'N/A';
    document.getElementById('reviewTimestamp').textContent = work.timestamp || '--';
    document.getElementById('reviewTime').textContent = work.totalTime || '--';
    
    // Hi·ªÉn th·ªã tr·∫°ng th√°i AI
    showAIStatus(aiStatus, feedbackSource);
    
    // Hi·ªÉn th·ªã ƒë·ªÅ b√†i
    const weekTopics = TOPICS[currentWeek] || TOPICS[1];
    document.getElementById('topic1Prompt').textContent = weekTopics.topic1.prompt;
    document.getElementById('topic2Prompt').textContent = weekTopics.topic2.prompt;
    
    // Topic 1 - Student work
    document.getElementById('t1_ss').textContent = work.topic1?.ss || '(Kh√¥ng c√≥)';
    document.getElementById('t1_is').textContent = work.topic1?.is || '(Kh√¥ng c√≥)';
    document.getElementById('t1_q').textContent = work.topic1?.q || '(Kh√¥ng c√≥)';
    document.getElementById('t1_t').textContent = work.topic1?.t || '(Kh√¥ng c√≥)';
    document.getElementById('t1_body1').textContent = work.topic1?.body1 || '(Kh√¥ng c√≥)';
    document.getElementById('t1_body2').textContent = work.topic1?.body2 || '(Kh√¥ng c√≥)';
    document.getElementById('t1_body3').textContent = work.topic1?.body3 || '(Kh√¥ng c√≥)';
    document.getElementById('t1_intro').textContent = work.topic1?.introduction || '(Kh√¥ng c√≥)';
    document.getElementById('t1_wordcount').textContent = work.topic1?.wordCount || 0;
    document.getElementById('t1_time').textContent = work.topic1?.timeUsed || '--';
    
    // Topic 2 - Student work
    document.getElementById('t2_ss').textContent = work.topic2?.ss || '(Kh√¥ng c√≥)';
    document.getElementById('t2_is').textContent = work.topic2?.is || '(Kh√¥ng c√≥)';
    document.getElementById('t2_q').textContent = work.topic2?.q || '(Kh√¥ng c√≥)';
    document.getElementById('t2_t').textContent = work.topic2?.t || '(Kh√¥ng c√≥)';
    document.getElementById('t2_body1').textContent = work.topic2?.body1 || '(Kh√¥ng c√≥)';
    document.getElementById('t2_body2').textContent = work.topic2?.body2 || '(Kh√¥ng c√≥)';
    document.getElementById('t2_body3').textContent = work.topic2?.body3 || '(Kh√¥ng c√≥)';
    document.getElementById('t2_intro').textContent = work.topic2?.introduction || '(Kh√¥ng c√≥)';
    document.getElementById('t2_wordcount').textContent = work.topic2?.wordCount || 0;
    document.getElementById('t2_time').textContent = work.topic2?.timeUsed || '--';
    
    // Load feedback d·ª±a tr√™n tr·∫°ng th√°i
    if (feedback) {
        loadFeedback(feedback, feedbackSource === 'teacher');
    } else {
        // AI ch∆∞a ch·∫•m xong
        setPlaceholderFeedback(aiStatus);
    }
    
    // Show first tab
    switchTab('topic1');
}

// ========== HI·ªÇN TH·ªä TR·∫†NG TH√ÅI AI ==========
function showAIStatus(aiStatus, feedbackSource) {
    const header = document.querySelector('#reviewScreen .bg-white.rounded-2xl.shadow-2xl > div');
    
    // X√≥a badge c≈© n·∫øu c√≥
    const oldBadge = header.querySelector('.ai-status-badge');
    if (oldBadge) oldBadge.remove();
    
    let badgeHTML = '';
    
    if (feedbackSource === 'teacher') {
        badgeHTML = `
            <div class="ai-status-badge bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold text-sm inline-block mt-2">
                ‚úèÔ∏è ƒê√£ ch·ªânh s·ª≠a b·ªüi gi√°o vi√™n
            </div>
        `;
    } else if (feedbackSource === 'ai') {
        badgeHTML = `
            <div class="ai-status-badge bg-green-500 text-white px-4 py-2 rounded-lg font-semibold text-sm inline-block mt-2">
                ‚úÖ AI ƒë√£ ch·∫•m xong
            </div>
        `;
    } else if (aiStatus === 'PENDING') {
        badgeHTML = `
            <div class="ai-status-badge bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold text-sm inline-block mt-2">
                ‚è≥ AI ƒëang ch·∫•m (t·ª± ƒë·ªông m·ªói 5 ph√∫t)
            </div>
        `;
    } else if (aiStatus === 'ERROR') {
        badgeHTML = `
            <div class="ai-status-badge bg-red-500 text-white px-4 py-2 rounded-lg font-semibold text-sm inline-block mt-2">
                ‚ùå L·ªói AI - Li√™n h·ªá admin
            </div>
        `;
    }
    
    if (badgeHTML) {
        header.insertAdjacentHTML('beforeend', badgeHTML);
    }
}

// ========== LOAD FEEDBACK ==========
function loadFeedback(feedback, isTeacherEdit) {
    // Topic 1
    if (feedback.topic1) {
        const t1 = feedback.topic1;
        
        document.getElementById('t1_analysis_score').value = t1.analysis_score || 0;
        document.getElementById('t1_intro_score').value = t1.introduction_score || 0;
        document.getElementById('t1_cefr').value = t1.cefr_level || 'B1';
        
        // Parse v√† format feedback
        const analysisFeedback = parseAndFormatFeedback(t1.analysis_feedback);
        const introFeedback = parseAndFormatFeedback(t1.introduction_feedback);
        
        document.getElementById('t1_analysis_feedback').innerHTML = analysisFeedback;
        document.getElementById('t1_intro_feedback').innerHTML = introFeedback;
    }
    
    // Topic 2
    if (feedback.topic2) {
        const t2 = feedback.topic2;
        
        document.getElementById('t2_analysis_score').value = t2.analysis_score || 0;
        document.getElementById('t2_intro_score').value = t2.introduction_score || 0;
        document.getElementById('t2_cefr').value = t2.cefr_level || 'B1';
        
        const analysisFeedback = parseAndFormatFeedback(t2.analysis_feedback);
        const introFeedback = parseAndFormatFeedback(t2.introduction_feedback);
        
        document.getElementById('t2_analysis_feedback').innerHTML = analysisFeedback;
        document.getElementById('t2_intro_feedback').innerHTML = introFeedback;
    }
    
    // Show badge if teacher edited
    if (isTeacherEdit) {
        showTeacherEditBadge();
    }
}

// ========== PARSE AND FORMAT FEEDBACK ==========
function parseAndFormatFeedback(feedbackData) {
    if (!feedbackData) return 'Ch∆∞a c√≥ nh·∫≠n x√©t t·ª´ AI';
    
    // N·∫øu l√† string, th·ª≠ parse JSON
    let feedback = feedbackData;
    if (typeof feedbackData === 'string') {
        try {
            feedback = JSON.parse(feedbackData);
        } catch (e) {
            // N·∫øu kh√¥ng parse ƒë∆∞·ª£c, tr·∫£ v·ªÅ string g·ªëc
            return feedbackData;
        }
    }
    
    // N·∫øu l√† object, format th√†nh HTML
    if (typeof feedback === 'object') {
        let html = '<div class="space-y-3">';
        
        // Analysis feedback
        if (feedback.ss_comment) {
            html += `<p><strong class="text-blue-700">‚úÖ SS:</strong> ${feedback.ss_comment}</p>`;
        }
        if (feedback.is_comment) {
            html += `<p><strong class="text-blue-700">‚úÖ IS:</strong> ${feedback.is_comment}</p>`;
        }
        if (feedback.q_comment) {
            html += `<p><strong class="text-blue-700">‚úÖ Q:</strong> ${feedback.q_comment}</p>`;
        }
        if (feedback.t_comment) {
            html += `<p><strong class="text-blue-700">‚úÖ T:</strong> ${feedback.t_comment}</p>`;
        }
        if (feedback.outline_comment) {
            html += `<p><strong class="text-purple-700">üìù Outline:</strong> ${feedback.outline_comment}</p>`;
        }
        
        // Introduction feedback
        if (feedback.strengths && Array.isArray(feedback.strengths) && feedback.strengths.length > 0) {
            html += '<div><p class="font-bold text-green-700 mb-2">‚úÖ ƒêI·ªÇM M·∫†NH:</p><ul class="list-disc pl-5 space-y-1">';
            feedback.strengths.forEach(s => {
                html += `<li>${s}</li>`;
            });
            html += '</ul></div>';
        }
        
        if (feedback.weaknesses && Array.isArray(feedback.weaknesses) && feedback.weaknesses.length > 0) {
            html += '<div><p class="font-bold text-orange-700 mb-2">‚ö†Ô∏è C·∫¶N C·∫¢I THI·ªÜN:</p><ul class="list-disc pl-5 space-y-1">';
            feedback.weaknesses.forEach(w => {
                html += `<li>${w}</li>`;
            });
            html += '</ul></div>';
        }
        
        if (feedback.grammar_errors && Array.isArray(feedback.grammar_errors) && feedback.grammar_errors.length > 0) {
            html += '<div><p class="font-bold text-red-700 mb-2">üî¥ L·ªñI GRAMMAR:</p><ul class="list-disc pl-5 space-y-1">';
            feedback.grammar_errors.forEach(err => {
                html += `<li>"<span class="text-red-600">${err.error}</span>" ‚Üí "<span class="text-green-600">${err.correction}</span>"</li>`;
            });
            html += '</ul></div>';
        }
        
        if (feedback.overall_comment) {
            html += `<div><p class="font-bold text-blue-700 mb-2">üí¨ NH·∫¨N X√âT CHUNG:</p><p>${feedback.overall_comment}</p></div>`;
        }
        
        if (feedback.improvement_suggestions && Array.isArray(feedback.improvement_suggestions) && feedback.improvement_suggestions.length > 0) {
            html += '<div><p class="font-bold text-purple-700 mb-2">üí° G·ª¢I √ù C·∫¢I THI·ªÜN:</p><ol class="list-decimal pl-5 space-y-1">';
            feedback.improvement_suggestions.forEach(sug => {
                html += `<li>${sug}</li>`;
            });
            html += '</ol></div>';
        }
        
        html += '</div>';
        return html;
    }
    
    return 'Ch∆∞a c√≥ nh·∫≠n x√©t t·ª´ AI';
}

function setPlaceholderFeedback(aiStatus) {
    let placeholder = '';
    
    if (aiStatus === 'PENDING') {
        placeholder = `
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                <p class="text-yellow-800 font-semibold mb-2">‚è≥ AI ƒëang ch·∫•m b√†i...</p>
                <p class="text-yellow-700 text-sm">
                    H·ªá th·ªëng AI t·ª± ƒë·ªông ch·∫•m m·ªói 5 ph√∫t. Vui l√≤ng quay l·∫°i sau ho·∫∑c b·∫•m "L√†m m·ªõi" ƒë·ªÉ ki·ªÉm tra.
                </p>
                <button onclick="location.reload()" class="mt-3 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-semibold text-sm">
                    üîÑ Ki·ªÉm tra l·∫°i
                </button>
            </div>
        `;
    } else if (aiStatus === 'ERROR') {
        placeholder = `
            <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                <p class="text-red-800 font-semibold mb-2">‚ùå L·ªói khi ch·∫•m b√†i</p>
                <p class="text-red-700 text-sm">
                    C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh AI ch·∫•m b√†i. Vui l√≤ng li√™n h·ªá admin ho·∫∑c ch·∫•m th·ªß c√¥ng.
                </p>
            </div>
        `;
    } else {
        placeholder = '<p class="text-gray-500 italic">Ch∆∞a c√≥ nh·∫≠n x√©t t·ª´ AI</p>';
    }
    
    document.getElementById('t1_analysis_feedback').innerHTML = placeholder;
    document.getElementById('t1_intro_feedback').innerHTML = placeholder;
    document.getElementById('t2_analysis_feedback').innerHTML = placeholder;
    document.getElementById('t2_intro_feedback').innerHTML = placeholder;
}

// ========== SWITCH TAB ==========
function switchTab(tabName) {
    // Hide all tabs
    document.getElementById('topic1Content').classList.add('hidden');
    document.getElementById('topic2Content').classList.add('hidden');
    document.getElementById('behaviorContent').classList.add('hidden');
    
    // Remove active from all buttons
    document.getElementById('tab1').classList.remove('active');
    document.getElementById('tab2').classList.remove('active');
    document.getElementById('tab3').classList.remove('active');
    
    // Show selected tab
    if (tabName === 'topic1') {
        document.getElementById('topic1Content').classList.remove('hidden');
        document.getElementById('tab1').classList.add('active');
    } else if (tabName === 'topic2') {
        document.getElementById('topic2Content').classList.remove('hidden');
        document.getElementById('tab2').classList.add('active');
    } else if (tabName === 'behavior') {
        document.getElementById('behaviorContent').classList.remove('hidden');
        document.getElementById('tab3').classList.add('active');
        loadBehaviorData();
    }
}

// ========== LOAD BEHAVIOR DATA ==========
function loadBehaviorData() {
    if (!currentStudentData || !currentStudentData.work) {
        document.getElementById('timeBreakdown').innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
        document.getElementById('editStats').innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
        return;
    }
    
    const work = currentStudentData.work;
    
    // Time breakdown - simplified version
    const timeHtml = `
        <div class="space-y-3">
            <div class="bg-white rounded p-3">
                <p class="font-semibold text-gray-800 mb-2">üìù ƒê·ªÅ 1:</p>
                <p class="text-sm">Th·ªùi gian: <strong>${work.topic1?.timeUsed || '0s'}</strong></p>
                <p class="text-sm">S·ªë t·ª´: <strong>${work.topic1?.wordCount || 0}</strong></p>
            </div>
            
            <div class="bg-white rounded p-3">
                <p class="font-semibold text-gray-800 mb-2">üìù ƒê·ªÅ 2:</p>
                <p class="text-sm">Th·ªùi gian: <strong>${work.topic2?.timeUsed || '0s'}</strong></p>
                <p class="text-sm">S·ªë t·ª´: <strong>${work.topic2?.wordCount || 0}</strong></p>
            </div>
            
            <div class="bg-blue-100 rounded p-3">
                <p class="font-semibold text-blue-800">‚è±Ô∏è T·ªïng th·ªùi gian: <strong>${work.totalTime}</strong></p>
            </div>
        </div>
    `;
    document.getElementById('timeBreakdown').innerHTML = timeHtml;
    
    // Edit & Paste stats - placeholder
    const editHtml = `
        <div class="space-y-3">
            <div class="bg-white rounded p-3">
                <p class="font-semibold text-gray-800 mb-2">üìä Th·ªëng k√™ ch·ªânh s·ª≠a:</p>
                <p class="text-sm text-gray-600">D·ªØ li·ªáu chi ti·∫øt v·ªÅ s·ªë l·∫ßn ch·ªânh s·ª≠a v√† paste s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong phi√™n b·∫£n ti·∫øp theo.</p>
            </div>
            
            <div class="bg-green-50 border border-green-200 rounded p-3">
                <p class="text-green-700 text-sm">‚úÖ H·ªçc sinh ƒë√£ ho√†n th√†nh b√†i l√†m</p>
            </div>
        </div>
    `;
    document.getElementById('editStats').innerHTML = editHtml;
}

// ========== SAVE EDITS ==========
async function saveEdits() {
    if (!currentStudent || !currentStudentData) {
        alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!');
        return;
    }
    
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<div class="spinner"></div> ƒêang l∆∞u...';
    
    // Collect edited data
    const editedData = {
        action: 'saveTeacherFeedback',
        studentCode: currentStudent,
        studentName: currentStudentData.work.studentName,
        weekNumber: currentWeek,
        topic1: {
            analysis_score: parseFloat(document.getElementById('t1_analysis_score').value),
            introduction_score: parseFloat(document.getElementById('t1_intro_score').value),
            cefr_level: document.getElementById('t1_cefr').value,
            analysis_feedback: document.getElementById('t1_analysis_feedback').innerHTML,
            introduction_feedback: document.getElementById('t1_intro_feedback').innerHTML
        },
        topic2: {
            analysis_score: parseFloat(document.getElementById('t2_analysis_score').value),
            introduction_score: parseFloat(document.getElementById('t2_intro_score').value),
            cefr_level: document.getElementById('t2_cefr').value,
            analysis_feedback: document.getElementById('t2_analysis_feedback').innerHTML,
            introduction_feedback: document.getElementById('t2_intro_feedback').innerHTML
        }
    };
    
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(editedData)
        });
        
        showTeacherEditBadge();
        
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        
        alert('‚úÖ ƒê√£ l∆∞u ch·ªânh s·ª≠a th√†nh c√¥ng!');
        
    } catch (error) {
        console.error('Error:', error);
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        alert('‚ö†Ô∏è ƒê√£ l∆∞u (no-cors mode) - Vui l√≤ng ki·ªÉm tra Google Sheets');
    }
}

// ========== BACK TO DASHBOARD ==========
function backToDashboard() {
    document.getElementById('reviewScreen').classList.add('hidden');
    document.getElementById('dashboardScreen').classList.remove('hidden');
    currentStudent = null;
    currentStudentData = null;
}

// ========== HELPER FUNCTIONS ==========
function showLoading(elementId, message) {
    document.getElementById(elementId).innerHTML = `
        <div class="text-center py-12">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">${message}</p>
        </div>
    `;
}

function showTeacherEditBadge() {
    // ƒê√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong showAIStatus()
    // H√†m n√†y gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('passwordInput').focus();
});
</script>

</body>
</html>