<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard - FCE Writing - LIME</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tab { @apply px-4 py-2 rounded-t-lg font-semibold transition; }
    .tab-active { @apply bg-white text-green-700 border-t-2 border-green-600; }
    .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    .editable { @apply p-3 border rounded-lg bg-yellow-50 border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500; }
  </style>
</head>
<body class="min-h-screen p-4">

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-20 fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
        <div>
          <h1 class="text-2xl font-bold text-green-700">Teacher Dashboard</h1>
          <p class="text-green-600 text-sm">FCE Writing - Quản lý bài nộp & Feedback</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-600">
        <p>Giáo viên: <span class="font-semibold">Admin</span></p>
        <p id="currentDate"></p>
      </div>
    </div>
  </div>

  <!-- CHỌN TUẦN -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <label class="block text-green-800 font-semibold mb-2">Chọn Tuần</label>
    <select id="weekSelect" class="w-full md:w-64 px-4 py-3 border-2 border-green-300 rounded-lg text-lg" onchange="loadDashboard()">
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
    </select>
  </div>

  <!-- TỔNG QUAN & THỐNG KÊ -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">Tổng quan</h3>
      <p class="text-3xl font-bold text-green-600" id="submittedCount">0</p>
      <p class="text-sm text-gray-600">Đã nộp / <span id="totalStudents">0</span> học sinh</p>
      <p class="text-sm text-orange-600 mt-2" id="notSubmittedList"></p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">Điểm trung bình</h3>
      <p class="text-2xl font-bold text-blue-600" id="avgAnalysis">0.0</p>
      <p class="text-sm text-gray-600">Phân tích đề</p>
      <p class="text-2xl font-bold text-purple-600 mt-2" id="avgIntro">0.0</p>
      <p class="text-sm text-gray-600">Mở bài</p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <canvas id="cefrChart" height="100"></canvas>
    </div>
  </div>

  <!-- DANH SÁCH HỌC SINH -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <h3 class="text-xl font-bold text-green-700 mb-4">Danh sách học sinh</h3>
    <div id="studentList" class="space-y-3">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- CHI TIẾT HỌC SINH -->
  <div id="studentDetail" class="hidden bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-green-700" id="detailName"></h3>
      <button onclick="closeDetail()" class="text-red-600 hover:text-red-800 font-bold">Đóng</button>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-1 mb-6 border-b">
      <button class="tab tab-active" onclick="showTab('topic1')">Đề 1</button>
      <button class="tab tab-inactive" onclick="showTab('topic2')">Đề 2</button>
      <button class="tab tab-inactive" onclick="showTab('stats')">Thống kê</button>
    </div>

    <!-- Nội dung tab -->
    <div id="tab-topic1" class="space-y-6"></div>
    <div id="tab-topic2" class="hidden space-y-6"></div>
    <div id="tab-stats" class="hidden space-y-6"></div>

    <!-- Nút hành động -->
    <div class="flex gap-3 mt-6">
      <button onclick="saveEditedFeedback()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        Lưu Feedback Đã Sửa
      </button>
      <button onclick="exportPDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
        Export PDF
      </button>
    </div>
  </div>

</div>

<script>
  // THAY BẰNG URL WEB APP CỦA BẠN
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKG7lehYtuGaYRpW1H-XGDh1bJJlj8wLhCc5b1rzFyOoKnpmPpruug2yjRdYG5W9CYbQ/exec';

  let currentWeek = 1;
  let currentStudent = null;
  let allSubmissions = [];
  let allStudents = [];
  let currentFeedback = {}; // Lưu feedback đang chỉnh sửa

  // Load khi mở trang
  window.onload = () => {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
    loadDashboard();
  };

  function loadDashboard() {
    currentWeek = document.getElementById('weekSelect').value;
    document.getElementById('studentList').innerHTML = '<div class="spinner"></div>';

    // Lấy danh sách nộp
    fetch(`${GOOGLE_SCRIPT_URL}?action=getSubmissions&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        allSubmissions = data.submissions || [];
        loadStudentList();
        loadOverview();
      })
      .catch(err => {
        document.getElementById('studentList').innerHTML = '<p class="text-red-600">Lỗi kết nối Apps Script!</p>';
        console.error(err);
      });

    // Lấy danh sách học sinh
    fetch(`${GOOGLE_SCRIPT_URL}?action=getAllStudents`)
      .then(r => r.json())
      .then(data => allStudents = data.students || [])
      .catch(() => allStudents = []);
  }

  function loadStudentList() {
    const list = document.getElementById('studentList');
    const submittedCodes = allSubmissions.map(s => s.code);
    const notSubmitted = allStudents.filter(s => !submittedCodes.includes(s.code));

    let html = '';
    [...allSubmissions, ...notSubmitted.map(s => ({...s, notSubmitted: true}))].sort((a,b) => a.code.localeCompare(b.code)).forEach(s => {
      const status = s.notSubmitted ? 'text-red-600' : 'text-green-600';
      const btn = s.notSubmitted ? '' : `<button onclick="viewStudent('${s.code}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Xem</button>`;
      html += `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
          <div>
            <span class="font-semibold">${s.code}</span> - 
            <span>${s.name || 'Chưa có tên'}</span>
            ${s.notSubmitted ? '<span class="text-red-500 text-sm ml-2">(Chưa nộp)</span>' : ''}
          </div>
          ${btn}
        </div>`;
    });
    list.innerHTML = html || '<p class="text-gray-500 text-center">Không có dữ liệu</p>';
  }

  function loadOverview() {
    const submitted = allSubmissions.length;
    const total = allStudents.length;
    document.getElementById('submittedCount').textContent = submitted;
    document.getElementById('totalStudents').textContent = total;

    const notSubmittedNames = allStudents.filter(s => !allSubmissions.find(sub => sub.code === s.code)).map(s => s.code).join(', ');
    document.getElementById('notSubmittedList').textContent = notSubmittedNames ? `Chưa nộp: ${notSubmittedNames}` : 'Tất cả đã nộp';

    // Giả lập thống kê (sẽ lấy thật từ API sau)
    document.getElementById('avgAnalysis').textContent = '7.8';
    document.getElementById('avgIntro').textContent = '6.5';

    // Biểu đồ CEFR
    const ctx = document.getElementById('cefrChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['C1/C2', 'B2+', 'B2', 'B1+', 'B1', 'A2'],
        datasets: [{
          data: [1, 2, 3, 5, 4, 0],
          backgroundColor: ['#4CAF50', '#8BC34A', '#2196F3', '#FFC107', '#FF9800', '#F44336']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  function viewStudent(code) {
    currentStudent = code;
    document.getElementById('studentDetail').classList.remove('hidden');
    document.getElementById('detailName').textContent = `${code} - Đang tải...`;
    document.getElementById('tab-topic1').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-topic2').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-stats').innerHTML = '<div class="spinner"></div>';

    fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentDetail&code=${code}&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        if (data.status === 'success') {
          renderStudentDetail(data);
        } else {
          alert('Không tìm thấy bài làm');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Lỗi kết nối');
      });
  }

  function renderStudentDetail(data) {
    const work = data.work;
    const name = work.studentName || 'Unknown';
    document.getElementById('detailName').textContent = `${currentStudent} - ${name}`;

    currentFeedback = data;

    // === ĐỀ 1 ===
    const t1 = work.topic1;
    const fb1 = data.teacherFeedback?.topic1 || data.aiFeedback?.topic1 || {};
    const analysisFb = fb1.analysis_feedback || {};
    const introFb = fb1.introduction_feedback || {};
    const grammarErrors = introFb.grammar_errors || [];
    const suggestions = fb1.improvement_suggestions || [];

    document.getElementById('tab-topic1').innerHTML = `
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
        <h4 class="font-bold text-blue-800 mb-3">ĐỀ 1: ${t1.title || 'APPEARANCE & SOCIETY'}</h4>
        <p class="text-sm italic mb-4">"${t1.prompt || '...'}"</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Phân tích -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
            <div class="space-y-1 text-sm">
              <div><strong>SS:</strong> ${t1.ss || '—'}</div>
              <div><strong>IS:</strong> ${t1.is || '—'}</div>
              <div><strong>Q:</strong> ${t1.q || '—'}</div>
              <div><strong>T:</strong> ${t1.t || '—'}</div>
            </div>
            <p class="mt-2"><strong>Outline:</strong> ${[t1.body1, t1.body2, t1.body3].filter(x=>x).join(' → ') || '—'}</p>
          </div>

          <!-- Mở bài -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
            <p class="text-sm bg-gray-50 p-3 rounded">${t1.introduction || '—'}</p>
            <p class="mt-2 text-xs text-gray-600">Số từ: ${t1.wordCount || 0} | Thời gian: ${t1.timeUsed || '0p 0s'}</p>
          </div>
        </div>

        <!-- Feedback Chi Tiết (AI/Teacher) -->
        <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
          <h5 class="font-bold text-yellow-800 mb-2">FEEDBACK CHI TIẾT (AI - Giáo viên sửa)</h5>
          
          <div class="space-y-4">
            <!-- Analysis Feedback -->
            <div>
              <h6 class="font-semibold text-gray-700">Phân tích đề (Score: <span class="text-blue-600">${fb1.analysis_score || 0}/10</span>)</h6>
              <ul class="list-disc pl-5 text-sm space-y-1">
                <li>SS: ${analysisFb.ss_correct ? '✅' : '❌'} - ${analysisFb.ss_comment || ''}</li>
                <li>IS: ${analysisFb.is_correct ? '✅' : '❌'} - ${analysisFb.is_comment || ''}</li>
                <li>Q: ${analysisFb.q_correct ? '✅' : '❌'} - ${analysisFb.q_comment || ''}</li>
                <li>T: ${analysisFb.t_correct ? '✅' : '❌'} - ${analysisFb.t_comment || ''}</li>
                <li>Outline Score: ${analysisFb.outline_score || 0}/2 - ${analysisFb.outline_comment || ''}</li>
              </ul>
              <textarea id="t1-analysis-comment" class="editable w-full mt-2" rows="3">${fb1.overall_comment || ''}</textarea>
            </div>

            <!-- Introduction Feedback -->
            <div>
              <h6 class="font-semibold text-gray-700">Mở bài (Score: <span class="text-blue-600">${fb1.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb1.cefr_level || 'N/A'}</span></h6>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <strong>Strengths:</strong>
                  <ul class="list-disc pl-5 space-y-1">
                    ${introFb.strengths?.map(s => `<li>${s}</li>`).join('') || '<li>None</li>'}
                  </ul>
                  <textarea id="t1-strengths" class="editable w-full mt-2" rows="3">${introFb.strengths?.join('\n') || ''}</textarea>
                </div>
                <div>
                  <strong>Weaknesses:</strong>
                  <ul class="list-disc pl-5 space-y-1">
                    ${introFb.weaknesses?.map(w => `<li>${w}</li>`).join('') || '<li>None</li>'}
                  </ul>
                  <textarea id="t1-weaknesses" class="editable w-full mt-2" rows="3">${introFb.weaknesses?.join('\n') || ''}</textarea>
                </div>
              </div>

              <div class="mt-3">
                <strong>Grammar Errors:</strong>
                <ul class="list-disc pl-5 space-y-1 text-sm">
                  ${grammarErrors.map(e => `<li>Error: "${e.error}" → Correction: "${e.correction}"</li>`).join('') || '<li>None</li>'}
                </ul>
                <textarea id="t1-grammar" class="editable w-full mt-2" rows="3">${grammarErrors.map(e => `${e.error} → ${e.correction}`).join('\n') || ''}</textarea>
              </div>

              <div class="mt-3">
                <strong>Structure Breakdown (Scores):</strong>
                <ul class="list-disc pl-5 space-y-1 text-sm">
                  <li>Background: ${introFb.structure_breakdown?.background || 0}/1</li>
                  <li>Paraphrase: ${introFb.structure_breakdown?.paraphrase || 0}/1.5</li>
                  <li>Thesis: ${introFb.structure_breakdown?.thesis || 0}/2</li>
                  <li>General: ${introFb.structure_breakdown?.general || 0}/0.5</li>
                </ul>
              </div>

              <div class="mt-3">
                <strong>Word Count Score:</strong> ${introFb.word_count_score || 0}/1 (${introFb.word_count || 0} words)
              </div>
            </div>

            <!-- Suggestions -->
            <div>
              <h6 class="font-semibold text-gray-700">Improvement Suggestions:</h6>
              <ul class="list-disc pl-5 space-y-1 text-sm">
                ${suggestions.map(s => `<li>${s}</li>`).join('') || '<li>None</li>'}
              </ul>
              <textarea id="t1-suggestions" class="editable w-full mt-2" rows="4">${suggestions.join('\n') || ''}</textarea>
            </div>
          </div>
        </div>
      </div>
    `;

    // === ĐỀ 2 ===
    const t2 = work.topic2;
    const fb2 = data.teacherFeedback?.topic2 || data.aiFeedback?.topic2 || {};
    const analysisFb2 = fb2.analysis_feedback || {};
    const introFb2 = fb2.introduction_feedback || {};
    const grammarErrors2 = introFb2.grammar_errors || [];
    const suggestions2 = fb2.improvement_suggestions || [];

    document.getElementById('tab-topic2').innerHTML = `
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
        <h4 class="font-bold text-blue-800 mb-3">ĐỀ 2: ${t2.title || 'SCHOOL DECISIONS'}</h4>
        <p class="text-sm italic mb-4">"${t2.prompt || '...'}"</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Phân tích -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
            <div class="space-y-1 text-sm">
              <div><strong>SS:</strong> ${t2.ss || '—'}</div>
              <div><strong>IS:</strong> ${t2.is || '—'}</div>
              <div><strong>Q:</strong> ${t2.q || '—'}</div>
              <div><strong>T:</strong> ${t2.t || '—'}</div>
            </div>
            <p class="mt-2"><strong>Outline:</strong> ${[t2.body1, t2.body2, t2.body3].filter(x=>x).join(' → ') || '—'}</p>
          </div>

          <!-- Mở bài -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
            <p class="text-sm bg-gray-50 p-3 rounded">${t2.introduction || '—'}</p>
            <p class="mt-2 text-xs text-gray-600">Số từ: ${t2.wordCount || 0} | Thời gian: ${t2.timeUsed || '0p 0s'}</p>
          </div>
        </div>

        <!-- Feedback Chi Tiết (AI/Teacher) -->
        <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
          <h5 class="font-bold text-yellow-800 mb-2">FEEDBACK CHI TIẾT (AI - Giáo viên sửa)</h5>
          
          <div class="space-y-4">
            <!-- Analysis Feedback -->
            <div>
              <h6 class="font-semibold text-gray-700">Phân tích đề (Score: <span class="text-blue-600">${fb2.analysis_score || 0}/10</span>)</h6>
              <ul class="list-disc pl-5 text-sm space-y-1">
                <li>SS: ${analysisFb2.ss_correct ? '✅' : '❌'} - ${analysisFb2.ss_comment || ''}</li>
                <li>IS: ${analysisFb2.is_correct ? '✅' : '❌'} - ${analysisFb2.is_comment || ''}</li>
                <li>Q: ${analysisFb2.q_correct ? '✅' : '❌'} - ${analysisFb2.q_comment || ''}</li>
                <li>T: ${analysisFb2.t_correct ? '✅' : '❌'} - ${analysisFb2.t_comment || ''}</li>
                <li>Outline Score: ${analysisFb2.outline_score || 0}/2 - ${analysisFb2.outline_comment || ''}</li>
              </ul>
              <textarea id="t2-analysis-comment" class="editable w-full mt-2" rows="3">${fb2.overall_comment || ''}</textarea>
            </div>

            <!-- Introduction Feedback -->
            <div>
              <h6 class="font-semibold text-gray-700">Mở bài (Score: <span class="text-blue-600">${fb2.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb2.cefr_level || 'N/A'}</span></h6>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <strong>Strengths:</strong>
                  <ul class="list-disc pl-5 space-y-1">
                    ${introFb2.strengths?.map(s => `<li>${s}</li>`).join('') || '<li>None</li>'}
                  </ul>
                  <textarea id="t2-strengths" class="editable w-full mt-2" rows="3">${introFb2.strengths?.join('\n') || ''}</textarea>
                </div>
                <div>
                  <strong>Weaknesses:</strong>
                  <ul class="list-disc pl-5 space-y-1">
                    ${introFb2.weaknesses?.map(w => `<li>${w}</li>`).join('') || '<li>None</li>'}
                  </ul>
                  <textarea id="t2-weaknesses" class="editable w-full mt-2" rows="3">${introFb2.weaknesses?.join('\n') || ''}</textarea>
                </div>
              </div>

              <div class="mt-3">
                <strong>Grammar Errors:</strong>
                <ul class="list-disc pl-5 space-y-1 text-sm">
                  ${grammarErrors2.map(e => `<li>Error: "${e.error}" → Correction: "${e.correction}"</li>`).join('') || '<li>None</li>'}
                </ul>
                <textarea id="t2-grammar" class="editable w-full mt-2" rows="3">${grammarErrors2.map(e => `${e.error} → ${e.correction}`).join('\n') || ''}</textarea>
              </div>

              <div class="mt-3">
                <strong>Structure Breakdown (Scores):</strong>
                <ul class="list-disc pl-5 space-y-1 text-sm">
                  <li>Background: ${introFb2.structure_breakdown?.background || 0}/1</li>
                  <li>Paraphrase: ${introFb2.structure_breakdown?.paraphrase || 0}/1.5</li>
                  <li>Thesis: ${introFb2.structure_breakdown?.thesis || 0}/2</li>
                  <li>General: ${introFb2.structure_breakdown?.general || 0}/0.5</li>
                </ul>
              </div>

              <div class="mt-3">
                <strong>Word Count Score:</strong> ${introFb2.word_count_score || 0}/1 (${introFb2.word_count || 0} words)
              </div>
            </div>

            <!-- Suggestions -->
            <div>
              <h6 class="font-semibold text-gray-700">Improvement Suggestions:</h6>
              <ul class="list-disc pl-5 space-y-1 text-sm">
                ${suggestions2.map(s => `<li>${s}</li>`).join('') || '<li>None</li>'}
              </ul>
              <textarea id="t2-suggestions" class="editable w-full mt-2" rows="4">${suggestions2.join('\n') || ''}</textarea>
            </div>
          </div>
        </div>
      </div>
    `;

    // === Tab Thống kê (Thời gian, Keystroke, etc.) ===
    document.getElementById('tab-stats').innerHTML = `
      <div class="bg-green-50 p-4 rounded-lg">
        <h5 class="font-bold text-green-700 mb-3">THỐNG KÊ LÀM BÀI</h5>
        <div class="space-y-2 text-sm">
          <p><strong>Tổng thời gian:</strong> ${work.totalTime || '0p 0s'}</p>
          <p><strong>Thời gian Đề 1:</strong> ${t1.timeUsed || '0p 0s'}</p>
          <p><strong>Thời gian Đề 2:</strong> ${t2.timeUsed || '0p 0s'}</p>
          <p><strong>Tổng pastes:</strong> ${data.totalPastes || 0}</p>
          <p><strong>Tổng edits:</strong> ${data.totalEdits || 0}</p>
          <p><strong>Keystroke Log Đề 1:</strong> ${t1.keystrokeLog || 'N/A'}</p>
          <p><strong>Keystroke Log Đề 2:</strong> ${t2.keystrokeLog || 'N/A'}</p>
        </div>
      </div>
    `;
  }

  function showTab(tab) {
    document.querySelectorAll('#studentDetail > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
    event.target.classList.replace('tab-inactive', 'tab-active');
  }

  function closeDetail() {
    document.getElementById('studentDetail').classList.add('hidden');
  }

  function saveEditedFeedback() {
    const payload = {
      action: 'saveTeacherFeedback',
      studentCode: currentStudent,
      weekNumber: currentWeek,
      studentName: document.getElementById('detailName').textContent.split(' - ')[1],
      topic1: {
        analysis_score: currentFeedback.aiFeedback?.topic1.analysis_score || 0,
        analysis_feedback: {
          outline_comment: document.getElementById('t1-analysis-comment').value
          // Thêm các field khác nếu editable
        },
        introduction_score: currentFeedback.aiFeedback?.topic1.introduction_score || 0,
        introduction_feedback: {
          strengths: document.getElementById('t1-strengths').value.split('\n').filter(line => line.trim()),
          weaknesses: document.getElementById('t1-weaknesses').value.split('\n').filter(line => line.trim()),
          grammar_errors: document.getElementById('t1-grammar').value.split('\n').filter(line => line.trim()).map(line => {
            const [error, correction] = line.split(' → ').map(s => s.trim());
            return {error, correction};
          })
        },
        cefr_level: currentFeedback.aiFeedback?.topic1.cefr_level || 'N/A',
        overall_comment: document.getElementById('t1-analysis-comment').value,
        improvement_suggestions: document.getElementById('t1-suggestions').value.split('\n').filter(line => line.trim())
      },
      topic2: {
        // Tương tự cho topic2
        analysis_score: currentFeedback.aiFeedback?.topic2.analysis_score || 0,
        analysis_feedback: {
          outline_comment: document.getElementById('t2-analysis-comment').value
        },
        introduction_score: currentFeedback.aiFeedback?.topic2.introduction_score || 0,
        introduction_feedback: {
          strengths: document.getElementById('t2-strengths').value.split('\n').filter(line => line.trim()),
          weaknesses: document.getElementById('t2-weaknesses').value.split('\n').filter(line => line.trim()),
          grammar_errors: document.getElementById('t2-grammar').value.split('\n').filter(line => line.trim()).map(line => {
            const [error, correction] = line.split(' → ').map(s => s.trim());
            return {error, correction};
          })
        },
        cefr_level: currentFeedback.aiFeedback?.topic2.cefr_level || 'N/A',
        overall_comment: document.getElementById('t2-analysis-comment').value,
        improvement_suggestions: document.getElementById('t2-suggestions').value.split('\n').filter(line => line.trim())
      }
    };

    fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => alert(res.status === 'success' ? 'Đã lưu!' : 'Lỗi: ' + res.message));
  }

  function exportPDF() {
  const url = `${GOOGLE_SCRIPT_URL}?action=exportPDF&code=${currentStudent}&week=${currentWeek}`;
  
  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        window.open(data.pdfUrl, '_blank');
      } else {
        alert('Lỗi xuất PDF: ' + data.message);
      }
    })
    .catch(err => {
      console.error(err);
      alert('Lỗi kết nối khi xuất PDF');
    });
}
</script>

</body>
</html>