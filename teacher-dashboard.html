<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard - FCE Writing - LIME</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tab { @apply px-4 py-2 rounded-t-lg font-semibold transition; }
    .tab-active { @apply bg-white text-green-700 border-t-2 border-green-600; }
    .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    .editable { @apply p-3 border rounded-lg bg-yellow-50 border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500; }
  </style>
</head>
<body class="min-h-screen p-4">

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-20 fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
        <div>
          <h1 class="text-2xl font-bold text-green-700">Teacher Dashboard</h1>
          <p class="text-green-600 text-sm">FCE Writing - Quản lý bài nộp & Feedback</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-600">
        <p>Giáo viên: <span class="font-semibold">Admin</span></p>
        <p id="currentDate"></p>
      </div>
    </div>
  </div>

  <!-- CHỌN TUẦN -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <label class="block text-green-800 font-semibold mb-2">Chọn Tuần</label>
    <select id="weekSelect" class="w-full md:w-64 px-4 py-3 border-2 border-green-300 rounded-lg text-lg" onchange="loadDashboard()">
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
    </select>
  </div>

  <!-- TỔNG QUAN & THỐNG KÊ -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">Tổng quan</h3>
      <p class="text-3xl font-bold text-green-600" id="submittedCount">0</p>
      <p class="text-sm text-gray-600">Đã nộp / <span id="totalStudents">0</span> học sinh</p>
      <p class="text-sm text-orange-600 mt-2" id="notSubmittedList"></p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">Điểm trung bình</h3>
      <p class="text-2xl font-bold text-blue-600" id="avgAnalysis">0.0</p>
      <p class="text-sm text-gray-600">Phân tích đề</p>
      <p class="text-2xl font-bold text-purple-600 mt-2" id="avgIntro">0.0</p>
      <p class="text-sm text-gray-600">Mở bài</p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <canvas id="cefrChart" height="100"></canvas>
    </div>
  </div>

  <!-- DANH SÁCH HỌC SINH -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <h3 class="text-xl font-bold text-green-700 mb-4">Danh sách học sinh</h3>
    <div id="studentList" class="space-y-3">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- CHI TIẾT HỌC SINH -->
  <div id="studentDetail" class="hidden bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-green-700" id="detailName"></h3>
      <button onclick="closeDetail()" class="text-red-600 hover:text-red-800 font-bold">Đóng</button>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-1 mb-6 border-b">
      <button class="tab tab-active" onclick="showTab('topic1')">Đề 1</button>
      <button class="tab tab-inactive" onclick="showTab('topic2')">Đề 2</button>
      <button class="tab tab-inactive" onclick="showTab('stats')">Thống kê</button>
    </div>

    <!-- Nội dung tab -->
    <div id="tab-topic1" class="space-y-6"></div>
    <div id="tab-topic2" class="hidden space-y-6"></div>
    <div id="tab-stats" class="hidden space-y-6"></div>

    <!-- Nút hành động -->
    <div class="flex gap-3 mt-6">
      <button onclick="saveEditedFeedback()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        Lưu Feedback Đã Sửa
      </button>
      <button onclick="exportPDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
        Export PDF
      </button>
    </div>
  </div>

</div>

<script>
  // THAY BẰNG URL WEB APP CỦA BẠN
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx.../exec';

  let currentWeek = 1;
  let currentStudent = null;
  let allSubmissions = [];
  let allStudents = [];
  let currentFeedback = {}; // Lưu feedback đang chỉnh sửa

  // Load khi mở trang
  window.onload = () => {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
    loadDashboard();
  };

  function loadDashboard() {
    currentWeek = document.getElementById('weekSelect').value;
    document.getElementById('studentList').innerHTML = '<div class="spinner"></div>';

    // Lấy danh sách nộp
    fetch(`${GOOGLE_SCRIPT_URL}?action=getSubmissions&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        allSubmissions = data.submissions || [];
        loadStudentList();
        loadOverview();
      })
      .catch(err => {
        document.getElementById('studentList').innerHTML = '<p class="text-red-600">Lỗi kết nối Apps Script!</p>';
        console.error(err);
      });

    // Lấy danh sách học sinh
    fetch(`${GOOGLE_SCRIPT_URL}?action=getAllStudents`)
      .then(r => r.json())
      .then(data => allStudents = data.students || [])
      .catch(() => allStudents = []);
  }

  function loadStudentList() {
    const list = document.getElementById('studentList');
    const submittedCodes = allSubmissions.map(s => s.code);
    const notSubmitted = allStudents.filter(s => !submittedCodes.includes(s.code));

    let html = '';
    [...allSubmissions, ...notSubmitted.map(s => ({...s, notSubmitted: true}))].sort((a,b) => a.code.localeCompare(b.code)).forEach(s => {
      const status = s.notSubmitted ? 'text-red-600' : 'text-green-600';
      const btn = s.notSubmitted ? '' : `<button onclick="viewStudent('${s.code}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Xem</button>`;
      html += `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
          <div>
            <span class="font-semibold">${s.code}</span> - 
            <span>${s.name || 'Chưa có tên'}</span>
            ${s.notSubmitted ? '<span class="text-red-500 text-sm ml-2">(Chưa nộp)</span>' : ''}
          </div>
          ${btn}
        </div>`;
    });
    list.innerHTML = html || '<p class="text-gray-500 text-center">Không có dữ liệu</p>';
  }

  function loadOverview() {
    const submitted = allSubmissions.length;
    const total = allStudents.length;
    document.getElementById('submittedCount').textContent = submitted;
    document.getElementById('totalStudents').textContent = total;

    const notSubmittedNames = allStudents.filter(s => !allSubmissions.find(sub => sub.code === s.code)).map(s => s.code).join(', ');
    document.getElementById('notSubmittedList').textContent = notSubmittedNames ? `Chưa nộp: ${notSubmittedNames}` : 'Tất cả đã nộp';

    // Giả lập thống kê (sẽ lấy thật từ API sau)
    document.getElementById('avgAnalysis').textContent = '7.8';
    document.getElementById('avgIntro').textContent = '6.5';

    // Biểu đồ CEFR
    const ctx = document.getElementById('cefrChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['C1/C2', 'B2+', 'B2', 'B1+', 'B1', 'A2'],
        datasets: [{
          data: [1, 2, 3, 5, 4, 0],
          backgroundColor: ['#4CAF50', '#8BC34A', '#2196F3', '#FFC107', '#FF9800', '#F44336']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  function viewStudent(code) {
    currentStudent = code;
    document.getElementById('studentDetail').classList.remove('hidden');
    document.getElementById('detailName').textContent = `${code} - Đang tải...`;
    document.getElementById('tab-topic1').innerHTML = '<div class="spinner"></div>';

    fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentDetail&code=${code}&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        if (data.status === 'success') {
          renderStudentDetail(data);
        } else {
          alert('Không tìm thấy bài làm');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Lỗi kết nối');
      });
  }

  function renderStudentDetail(data) {
    const work = data.work;
    const name = work.studentName || 'Unknown';
    document.getElementById('detailName').textContent = `${currentStudent} - ${name}`;

    currentFeedback = data;

    // === ĐỀ 1 ===
    const t1 = work.topic1;
    const fb1 = data.teacherFeedback?.topic1 || data.aiFeedback?.topic1 || {};
    document.getElementById('tab-topic1').innerHTML = `
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
        <h4 class="font-bold text-blue-800 mb-3">ĐỀ 1: ${t1.title || 'APPEARANCE & SOCIETY'}</h4>
        <p class="text-sm italic mb-4">"${t1.prompt || '...'}"</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Phân tích -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
            <div class="space-y-1 text-sm">
              <div><strong>SS:</strong> ${t1.ss || '—'}</div>
              <div><strong>IS:</strong> ${t1.is || '—'}</div>
              <div><strong>Q:</strong> ${t1.q || '—'}</div>
              <div><strong>T:</strong> ${t1.t || '—'}</div>
            </div>
            <p class="mt-2"><strong>Outline:</strong> ${[t1.body1, t1.body2, t1.body3].filter(x=>x).join(' → ') || '—'}</p>
          </div>

          <!-- Mở bài -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
            <p class="text-sm bg-gray-50 p-3 rounded">${t1.introduction || '—'}</p>
            <p class="mt-2 text-xs text-gray-600">Số từ: ${t1.wordCount || 0}</p>
          </div>
        </div>

        <!-- Feedback (có thể sửa) -->
        <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
          <h5 class="font-bold text-yellow-800 mb-2">FEEDBACK (AI → Giáo viên sửa)</h5>
          <textarea id="edit-analysis" class="editable w-full mb-2" rows="3" placeholder="Nhận xét phân tích...">${fb1.analysis_feedback?.outline_comment || ''}</textarea>
          <textarea id="edit-intro" class="editable w-full" rows="4" placeholder="Nhận xét mở bài...">${fb1.introduction_feedback?.strengths?.join('\n') || ''}</textarea>
        </div>
      </div>
    `;

    // Tương tự cho Đề 2 (bạn có thể copy paste và thay t2)
    // === ĐỀ 2 ===
    const t2 = work.topic2;
    const fb2 = data.teacherFeedback?.topic2 || data.aiFeedback?.topic2 || {};
    document.getElementById('tab-topic2').innerHTML = `
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
        <h4 class="font-bold text-blue-800 mb-3">ĐỀ 2: ${t2.title || 'APPEARANCE & SOCIETY'}</h4>
        <p class="text-sm italic mb-4">"${t2.prompt || '...'}"</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Phân tích -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-green-700 mb-2">PHÂN TÍCH ĐỀ</h5>
            <div class="space-y-1 text-sm">
              <div><strong>SS:</strong> ${t2.ss || '—'}</div>
              <div><strong>IS:</strong> ${t2.is || '—'}</div>
              <div><strong>Q:</strong> ${t2.q || '—'}</div>
              <div><strong>T:</strong> ${t2.t || '—'}</div>
            </div>
            <p class="mt-2"><strong>Outline:</strong> ${[t2.body1, t2.body2, t2.body3].filter(x=>x).join(' → ') || '—'}</p>
          </div>

          <!-- Mở bài -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h5 class="font-bold text-purple-700 mb-2">MỞ BÀI</h5>
            <p class="text-sm bg-gray-50 p-3 rounded">${t2.introduction || '—'}</p>
            <p class="mt-2 text-xs text-gray-600">Số từ: ${t2.wordCount || 0}</p>
          </div>
        </div>

        <!-- Feedback (có thể sửa) -->
        <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
          <h5 class="font-bold text-yellow-800 mb-2">FEEDBACK (AI → Giáo viên sửa)</h5>
          <textarea id="edit-analysis" class="editable w-full mb-2" rows="3" placeholder="Nhận xét phân tích...">${fb2.analysis_feedback?.outline_comment || ''}</textarea>
          <textarea id="edit-intro" class="editable w-full" rows="4" placeholder="Nhận xét mở bài...">${fb2.introduction_feedback?.strengths?.join('\n') || ''}</textarea>
        </div>
      </div>
    `;
    // Tab Thống kê: thời gian, paste, edit...
  }

  function showTab(tab) {
    document.querySelectorAll('#studentDetail > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(t => t.className = 'tab tab-inactive');
    event.target.className = 'tab tab-active';
  }

  function closeDetail() {
    document.getElementById('studentDetail').classList.add('hidden');
  }

  function saveEditedFeedback() {
    const payload = {
      action: 'saveTeacherFeedback',
      studentCode: currentStudent,
      weekNumber: currentWeek,
      studentName: document.getElementById('detailName').textContent.split(' - ')[1],
      topic1: { analysis_feedback: { outline_comment: document.getElementById('edit-analysis').value } },
      topic2: { /* tương tự */ }
    };

    fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => alert(res.status === 'success' ? 'Đã lưu!' : 'Lỗi: ' + res.message));
  }

  function exportPDF() {
    const url = `${GOOGLE_SCRIPT_URL}?action=exportPDF&code=${currentStudent}&week=${currentWeek}`;
    window.open(url, '_blank');
  }
</script>

</body>
</html>