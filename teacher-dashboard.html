<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard - FCE Writing - LIME</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tab { @apply px-4 py-2 rounded-t-lg font-semibold transition; }
    .tab-active { @apply bg-white text-green-700 border-t-2 border-green-600; }
    .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    .editable {
  @apply p-4 border rounded-lg bg-yellow-50 border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500;
  min-height: 100px;
  overflow-y: auto;           /* Quan tr·ªçng nh·∫•t */
  resize: vertical;
  line-height: 1.6;
  max-height: 80vh;
  scrollbar-width: thin;      /* Firefox */
}
.editable::-webkit-scrollbar {
  width: 6px;
}
.editable::-webkit-scrollbar-track {
  background: #fefce8;
}
.editable::-webkit-scrollbar-thumb {
  background: #ca8a04;
  border-radius: 3px;
}
  </style>
</head>
<body class="min-h-screen p-4">

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-20 fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
        <div>
          <h1 class="text-2xl font-bold text-green-700">Teacher Dashboard</h1>
          <p class="text-green-600 text-sm">FCE Writing - Qu·∫£n l√Ω b√†i n·ªôp & Feedback</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-600">
        <p>Gi√°o vi√™n: <span class="font-semibold">Admin</span></p>
        <p id="currentDate"></p>
      </div>
    </div>
  </div>

  <!-- CH·ªåN TU·∫¶N -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <label class="block text-green-800 font-semibold mb-2">Ch·ªçn Tu·∫ßn</label>
    <select id="weekSelect" class="w-full md:w-64 px-4 py-3 border-2 border-green-300 rounded-lg text-lg" onchange="loadDashboard()">
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
    </select>
  </div>

  <!-- T·ªîNG QUAN & TH·ªêNG K√ä -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">T·ªïng quan</h3>
      <p class="text-3xl font-bold text-green-600" id="submittedCount">0</p>
      <p class="text-sm text-gray-600">ƒê√£ n·ªôp / <span id="totalStudents">0</span> h·ªçc sinh</p>
      <p class="text-sm text-orange-600 mt-2" id="notSubmittedList"></p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
  <h3 class="text-xl font-bold text-green-700 mb-3">Average Scores (5 Topics)</h3>
  <div class="grid grid-cols-2 gap-4">
    <div>
      <p class="text-3xl font-bold text-blue-600" id="avgAnalysis">0.0</p>
      <p class="text-sm text-gray-600">Analysis</p>
    </div>
    <div>
      <p class="text-3xl font-bold text-purple-600" id="avgIntro">0.0</p>
      <p class="text-sm text-gray-600">Introduction</p>
    </div>
  </div>
</div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <canvas id="cefrChart" height="100"></canvas>
    </div>
  </div>

  <!-- DANH S√ÅCH H·ªåC SINH -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <h3 class="text-xl font-bold text-green-700 mb-4">Danh s√°ch h·ªçc sinh</h3>
    <div id="studentList" class="space-y-3">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- CHI TI·∫æT H·ªåC SINH -->
  <div id="studentDetail" class="hidden bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-green-700" id="detailName"></h3>
      <button onclick="closeDetail()" class="text-red-600 hover:text-red-800 font-bold">ƒê√≥ng</button>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-1 mb-6 border-b">
  <button class="tab tab-active" onclick="showTab('topic1')">Topic 1</button>
  <button class="tab tab-inactive" onclick="showTab('topic2')">Topic 2</button>
  <button class="tab tab-inactive" onclick="showTab('topic3')">Topic 3</button>
  <button class="tab tab-inactive" onclick="showTab('topic4')">Topic 4</button>
  <button class="tab tab-inactive" onclick="showTab('topic5')">Topic 5</button>
  <button class="tab tab-inactive" onclick="showTab('stats')">Statistics</button>
</div>

    <!-- N·ªôi dung tab -->
    <div id="tab-topic1" class="space-y-6"></div>
<div id="tab-topic2" class="hidden space-y-6"></div>
<div id="tab-topic3" class="hidden space-y-6"></div>
<div id="tab-topic4" class="hidden space-y-6"></div>
<div id="tab-topic5" class="hidden space-y-6"></div>
<div id="tab-stats" class="hidden space-y-6"></div>

    <!-- N√∫t h√†nh ƒë·ªông -->
    <div class="flex gap-3 mt-6">
     <button onclick="saveEditedFeedback()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
       L∆∞u Feedback ƒê√£ S·ª≠a
     </button>
     <button onclick="exportDOCX()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
       üì• Export DOCX
     </button>
     <button onclick="exportPDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
       Export PDF
     </button>
   </div>
  </div>

</div>

<script>
  // THAY B·∫∞NG URL WEB APP C·ª¶A B·∫†N
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIp9jfs0GEOh_Y-0AnBBXXaX4AjsMHHW7SkZjDjJwtXFHicIqXyddq9IOZmEijXuu-Fg/exec';

  let currentWeek = 1;
  let currentStudent = null;
  let allSubmissions = [];
  let allStudents = [];
  let currentFeedback = {}; // L∆∞u feedback ƒëang ch·ªânh s·ª≠a

  // Load khi m·ªü trang
  window.onload = () => {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
    loadDashboard();
  };

  function loadDashboard() {
    currentWeek = document.getElementById('weekSelect').value;
    document.getElementById('studentList').innerHTML = '<div class="spinner"></div>';

    // L·∫•y danh s√°ch n·ªôp
    fetch(`${GOOGLE_SCRIPT_URL}?action=getSubmissions&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        allSubmissions = data.submissions || [];
        loadStudentList();
        loadOverview();
      })
      .catch(err => {
        document.getElementById('studentList').innerHTML = '<p class="text-red-600">L·ªói k·∫øt n·ªëi Apps Script!</p>';
        console.error(err);
      });

    // L·∫•y danh s√°ch h·ªçc sinh
    fetch(`${GOOGLE_SCRIPT_URL}?action=getAllStudents`)
      .then(r => r.json())
      .then(data => allStudents = data.students || [])
      .catch(() => allStudents = []);
  }

  function loadStudentList() {
    const list = document.getElementById('studentList');
    const submittedCodes = allSubmissions.map(s => s.code);
    const notSubmitted = allStudents.filter(s => !submittedCodes.includes(s.code));

    let html = '';
    [...allSubmissions, ...notSubmitted.map(s => ({...s, notSubmitted: true}))].sort((a,b) => a.code.localeCompare(b.code)).forEach(s => {
      const status = s.notSubmitted ? 'text-red-600' : 'text-green-600';
      const btn = s.notSubmitted ? '' : `<button onclick="viewStudent('${s.code}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Xem</button>`;
      html += `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
          <div>
            <span class="font-semibold">${s.code}</span> - 
            <span>${s.name || 'Ch∆∞a c√≥ t√™n'}</span>
            ${s.notSubmitted ? '<span class="text-red-500 text-sm ml-2">(Ch∆∞a n·ªôp)</span>' : ''}
          </div>
          ${btn}
        </div>`;
    });
    list.innerHTML = html || '<p class="text-gray-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
  }

  function loadOverview() {
    const submitted = allSubmissions.length;
    const total = allStudents.length;
    document.getElementById('submittedCount').textContent = submitted;
    document.getElementById('totalStudents').textContent = total;

    const notSubmittedNames = allStudents.filter(s => !allSubmissions.find(sub => sub.code === s.code)).map(s => s.code).join(', ');
    document.getElementById('notSubmittedList').textContent = notSubmittedNames ? `Ch∆∞a n·ªôp: ${notSubmittedNames}` : 'T·∫•t c·∫£ ƒë√£ n·ªôp';

    // Gi·∫£ l·∫≠p th·ªëng k√™ (s·∫Ω l·∫•y th·∫≠t t·ª´ API sau)
    document.getElementById('avgAnalysis').textContent = '7.8';
    document.getElementById('avgIntro').textContent = '6.5';

    // Bi·ªÉu ƒë·ªì CEFR
    const ctx = document.getElementById('cefrChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['C1/C2', 'B2+', 'B2', 'B1+', 'B1', 'A2'],
        datasets: [{
          data: [1, 2, 3, 5, 4, 0],
          backgroundColor: ['#4CAF50', '#8BC34A', '#2196F3', '#FFC107', '#FF9800', '#F44336']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  function viewStudent(code) {
    currentStudent = code;
    document.getElementById('studentDetail').classList.remove('hidden');
    document.getElementById('detailName').textContent = `${code} - ƒêang t·∫£i...`;
    document.getElementById('tab-topic1').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-topic2').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-stats').innerHTML = '<div class="spinner"></div>';

    fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentDetail&code=${code}&week=${currentWeek}`)
  .then(r => r.json())
  .then(data => {
    console.log('=== RAW API RESPONSE ===');
    console.log('Full response:', data);
    console.log('feedbackSource:', data.feedbackSource);
    console.log('aiFeedback exists:', !!data.aiFeedback);
    console.log('teacherFeedback exists:', !!data.teacherFeedback);
    
    if (data.status === 'success') {
      renderStudentDetail(data);
    } else {
      alert('Kh√¥ng t√¨m th·∫•y b√†i l√†m');
    }
  })
  .catch(err => {
    console.error('Fetch error:', err);
    alert('L·ªói k·∫øt n·ªëi');
  });
} 
  function renderStudentDetail(data) {
    const work = data.work;
    const name = work.studentName || 'Unknown';
    document.getElementById('detailName').textContent = `${currentStudent} - ${name}`;

currentFeedback = data;
const t1 = work.topic1;
const t2 = work.topic2;
const t3 = work.topic3;
const t4 = work.topic4;
const t5 = work.topic5;

console.log('===== DEBUG TOPICS =====');
console.log('Topic 1 SS:', t1?.ss);
console.log('AI Feedback:', data.aiFeedback);
console.log('Teacher Feedback:', data.teacherFeedback);

// ===== H√ÄM HELPER ƒê·ªÇ L·∫§Y FEEDBACK =====
function getFeedback(topicNum) {
  const topicKey = `topic${topicNum}`;
  
  // ∆Øu ti√™n Teacher Feedback
  if (data.teacherFeedback?.[topicKey]) {
    const tf = data.teacherFeedback[topicKey];
    return {
      analysis_full: tf.analysis_full || '',
      strengths_vn: Array.isArray(tf.strengths_vn) ? tf.strengths_vn : 
                    (typeof tf.strengths_vn === 'string' ? JSON.parse(tf.strengths_vn || '[]') : []),
      weaknesses_vn: Array.isArray(tf.weaknesses_vn) ? tf.weaknesses_vn : 
                     (typeof tf.weaknesses_vn === 'string' ? JSON.parse(tf.weaknesses_vn || '[]') : []),
      structure_breakdown: tf.structure_breakdown || '',
      suggestions_vn: Array.isArray(tf.suggestions_vn) ? tf.suggestions_vn : 
                      (typeof tf.suggestions_vn === 'string' ? JSON.parse(tf.suggestions_vn || '[]') : [])
    };
  }
  
  // Fallback: D√πng AI Feedback
  if (data.aiFeedback?.[topicKey]) {
    const ai = data.aiFeedback[topicKey];
    const vn = ai.vietnamese_feedback || {};
    const intro = ai.introduction_feedback || {};
    const analysis = ai.analysis_feedback || {};
    
    return {
      analysis_full: vn.summary || analysis.outline_comment || '',
      strengths_vn: intro.strengths || [],
      weaknesses_vn: intro.weaknesses || [],
      structure_breakdown: JSON.stringify(intro.structure_breakdown || {}, null, 2),
      suggestions_vn: vn.suggestions_vn || ai.improvement_suggestions || []
    };
  }
  
  // Kh√¥ng c√≥ g√¨ c·∫£
  return {
    analysis_full: '',
    strengths_vn: [],
    weaknesses_vn: [],
    structure_breakdown: '',
    suggestions_vn: []
  };
}

// === ƒê·ªÄ 1 ===
{
const fb1 = getFeedback(1);

document.getElementById('tab-topic1').innerHTML = `
  <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
    <h4 class="font-bold text-blue-800 mb-3">ƒê·ªÅ 1: ${t1.title || 'APPEARANCE & SOCIETY'}</h4>
    <p class="text-sm italic mb-4">"${t1.prompt || '...'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ph√¢n t√≠ch -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PH√ÇN T√çCH ƒê·ªÄ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t1.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t1.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t1.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t1.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t1.body1, t1.body2, t1.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- M·ªü b√†i -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">M·ªû B√ÄI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t1.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">S·ªë t·ª´: ${t1.wordCount || 0} | Th·ªùi gian: ${t1.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Ti·∫øt -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Ph√¢n t√≠ch ƒë·ªÅ</h6>
          <textarea id="t1-analysis-full" class="editable w-full mt-2" rows="6">${fb1.analysis_full}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">M·ªü b√†i</h6>
          
          <div>
            <strong>ƒêi·ªÉm m·∫°nh & ƒêi·ªÉm y·∫øu:</strong>
            <textarea id="t1-strengths-weaknesses" class="editable w-full mt-2" rows="8">ƒêI·ªÇM M·∫†NH:
${fb1.strengths_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}

ƒêI·ªÇM Y·∫æU:
${fb1.weaknesses_vn.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown ƒëi·ªÉm s·ªë chi ti·∫øt:</strong>
            <textarea id="t1-structure" class="editable w-full mt-2" rows="5">${fb1.structure_breakdown}</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">G·ª£i √Ω c·∫£i thi·ªán:</h6>
          <textarea id="t1-suggestions" class="editable w-full mt-2" rows="6">${fb1.suggestions_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ƒê·ªÄ 2 ===
{
const fb2 = getFeedback(2);

document.getElementById('tab-topic2').innerHTML = `
  <div class="bg-gradient-to-r from-green-50 to-green-100 p-5 rounded-xl">
    <h4 class="font-bold text-green-800 mb-3">ƒê·ªÅ 2: ${t2.title || 'STUDENTS & SCHOOL DECISIONS'}</h4>
    <p class="text-sm italic mb-4">"${t2.prompt || 'Students should help to make decisions about what happens at school'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PH√ÇN T√çCH ƒê·ªÄ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t2.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t2.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t2.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t2.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t2.body1, t2.body2, t2.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">M·ªû B√ÄI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t2.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">S·ªë t·ª´: ${t2.wordCount || 0} | Th·ªùi gian: ${t2.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <div>
          <h6 class="font-semibold text-gray-700">Ph√¢n t√≠ch ƒë·ªÅ</h6>
          <textarea id="t2-analysis-full" class="editable w-full mt-2" rows="6">${fb2.analysis_full}</textarea>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">M·ªü b√†i</h6>
          
          <div>
            <strong>ƒêi·ªÉm m·∫°nh & ƒêi·ªÉm y·∫øu:</strong>
            <textarea id="t2-strengths-weaknesses" class="editable w-full mt-2" rows="8">ƒêI·ªÇM M·∫†NH:
${fb2.strengths_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}

ƒêI·ªÇM Y·∫æU:
${fb2.weaknesses_vn.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown ƒëi·ªÉm s·ªë chi ti·∫øt:</strong>
            <textarea id="t2-structure" class="editable w-full mt-2" rows="5">${fb2.structure_breakdown}</textarea>
          </div>
        </div>

        <div>
          <h6 class="font-semibold text-gray-700">G·ª£i √Ω c·∫£i thi·ªán:</h6>
          <textarea id="t2-suggestions" class="editable w-full mt-2" rows="6">${fb2.suggestions_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ƒê·ªÄ 3, 4, 5 t∆∞∆°ng t·ª± ===
// (Copy pattern c·ªßa topic 2, thay t3, t4, t5)

// === ƒê·ªÄ 3 ===
{
const fb3 = getFeedback(3);

document.getElementById('tab-topic3').innerHTML = `
  <div class="bg-gradient-to-r from-teal-50 to-teal-100 p-5 rounded-xl">
    <h4 class="font-bold text-teal-800 mb-3">ƒê·ªÅ 3: ${t3.title || 'TECHNOLOGY & HAPPINESS'}</h4>
    <p class="text-sm italic mb-4">"${t3.prompt || 'Technology has made our lives easier but has it made us happier?'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ph√¢n t√≠ch -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PH√ÇN T√çCH ƒê·ªÄ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t3.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t3.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t3.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t3.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t3.body1, t3.body2, t3.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- M·ªü b√†i -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">M·ªû B√ÄI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t3.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">S·ªë t·ª´: ${t3.wordCount || 0} | Th·ªùi gian: ${t3.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Ti·∫øt -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Ph√¢n t√≠ch ƒë·ªÅ</h6>
          <textarea id="t3-analysis-full" class="editable w-full mt-2" rows="6">${fb3.analysis_full}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">M·ªü b√†i</h6>
          
          <div>
            <strong>ƒêi·ªÉm m·∫°nh & ƒêi·ªÉm y·∫øu:</strong>
            <textarea id="t3-strengths-weaknesses" class="editable w-full mt-2" rows="8">ƒêI·ªÇM M·∫†NH:
${fb3.strengths_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}

ƒêI·ªÇM Y·∫æU:
${fb3.weaknesses_vn.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown ƒëi·ªÉm s·ªë chi ti·∫øt:</strong>
            <textarea id="t3-structure" class="editable w-full mt-2" rows="5">${fb3.structure_breakdown}</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">G·ª£i √Ω c·∫£i thi·ªán:</h6>
          <textarea id="t3-suggestions" class="editable w-full mt-2" rows="6">${fb3.suggestions_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ƒê·ªÄ 4 ===
{
const fb4 = getFeedback(4);

document.getElementById('tab-topic4').innerHTML = `
  <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-5 rounded-xl">
    <h4 class="font-bold text-orange-800 mb-3">ƒê·ªÅ 4: ${t4.title || 'OPPORTUNITIES FOR YOUNG PEOPLE'}</h4>
    <p class="text-sm italic mb-4">"${t4.prompt || 'Young people today have more opportunities than their parents\' generation'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ph√¢n t√≠ch -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PH√ÇN T√çCH ƒê·ªÄ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t4.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t4.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t4.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t4.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t4.body1, t4.body2, t4.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- M·ªü b√†i -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">M·ªû B√ÄI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t4.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">S·ªë t·ª´: ${t4.wordCount || 0} | Th·ªùi gian: ${t4.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Ti·∫øt -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Ph√¢n t√≠ch ƒë·ªÅ</h6>
          <textarea id="t4-analysis-full" class="editable w-full mt-2" rows="6">${fb4.analysis_full}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">M·ªü b√†i</h6>
          
          <div>
            <strong>ƒêi·ªÉm m·∫°nh & ƒêi·ªÉm y·∫øu:</strong>
            <textarea id="t4-strengths-weaknesses" class="editable w-full mt-2" rows="8">ƒêI·ªÇM M·∫†NH:
${fb4.strengths_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}

ƒêI·ªÇM Y·∫æU:
${fb4.weaknesses_vn.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown ƒëi·ªÉm s·ªë chi ti·∫øt:</strong>
            <textarea id="t4-structure" class="editable w-full mt-2" rows="5">${fb4.structure_breakdown}</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">G·ª£i √Ω c·∫£i thi·ªán:</h6>
          <textarea id="t4-suggestions" class="editable w-full mt-2" rows="6">${fb4.suggestions_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === ƒê·ªÄ 5 ===
{
const fb5 = getFeedback(5);

document.getElementById('tab-topic5').innerHTML = `
  <div class="bg-gradient-to-r from-pink-50 to-pink-100 p-5 rounded-xl">
    <h4 class="font-bold text-pink-800 mb-3">ƒê·ªÅ 5: ${t5.title || 'PRACTICAL LIFE SKILLS IN SCHOOLS'}</h4>
    <p class="text-sm italic mb-4">"${t5.prompt || 'Schools should teach practical life skills rather than just academic subjects'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ph√¢n t√≠ch -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PH√ÇN T√çCH ƒê·ªÄ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t5.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t5.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t5.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t5.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t5.body1, t5.body2, t5.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- M·ªü b√†i -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">M·ªû B√ÄI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t5.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">S·ªë t·ª´: ${t5.wordCount || 0} | Th·ªùi gian: ${t5.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Ti·∫øt -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Ph√¢n t√≠ch ƒë·ªÅ</h6>
          <textarea id="t5-analysis-full" class="editable w-full mt-2" rows="6">${fb5.analysis_full}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">M·ªü b√†i</h6>
          
          <div>
            <strong>ƒêi·ªÉm m·∫°nh & ƒêi·ªÉm y·∫øu:</strong>
            <textarea id="t5-strengths-weaknesses" class="editable w-full mt-2" rows="8">ƒêI·ªÇM M·∫†NH:
${fb5.strengths_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}

ƒêI·ªÇM Y·∫æU:
${fb5.weaknesses_vn.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Breakdown ƒëi·ªÉm s·ªë chi ti·∫øt:</strong>
            <textarea id="t5-structure" class="editable w-full mt-2" rows="5">${fb5.structure_breakdown}</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">G·ª£i √Ω c·∫£i thi·ªán:</h6>
          <textarea id="t5-suggestions" class="editable w-full mt-2" rows="6">${fb5.suggestions_vn.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ Ch∆∞a c√≥'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;
}

// === Tab Statistics (gi·ªØ nguy√™n nh∆∞ c≈©) ===
document.getElementById('tab-stats').innerHTML = `
  <div class="bg-green-50 p-4 rounded-lg">
    <h5 class="font-bold text-green-700 mb-3">WORK STATISTICS</h5>
    <div class="space-y-2 text-sm">
      <p><strong>Total time:</strong> ${work.totalTime || '0m 0s'}</p>
      <p><strong>Topic 1 time:</strong> ${t1.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 2 time:</strong> ${t2.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 3 time:</strong> ${t3.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 4 time:</strong> ${t4.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 5 time:</strong> ${t5.timeUsed || '0m 0s'}</p>
      <p><strong>Total pastes:</strong> ${data.totalPastes || 0}</p>
      <p><strong>Total edits:</strong> ${data.totalEdits || 0}</p>
    </div>
  </div>
`;

// Auto resize textarea khi load xong
setTimeout(() => {
  document.querySelectorAll('#tab-topic1 .editable').forEach(textarea => {
    textarea.style.height = 'auto';
    textarea.style.height = (textarea.scrollHeight + 10) + 'px';
    textarea.style.overflowY = 'hidden';
  });
}, 100);
}

 function showTab(tab) {
  // ·∫®n t·∫•t c·∫£ tab
  document.querySelectorAll('#studentDetail > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
  
  // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
  const activeTab = document.getElementById(`tab-${tab}`);
  activeTab.classList.remove('hidden');

  // Active n√∫t
  document.querySelectorAll('.tab').forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
  event.target.classList.replace('tab-inactive', 'tab-active');

  // QUAN TR·ªåNG: Ch·ªâ resize textarea c·ªßa tab ƒëang hi·ªán
  setTimeout(() => {
    activeTab.querySelectorAll('.editable').forEach(textarea => {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight + 10) + 'px';
      textarea.style.overflowY = 'hidden';
    });
  }, 50);
}

  function closeDetail() {
    document.getElementById('studentDetail').classList.add('hidden');
  }

function exportDOCX() {
  if (!currentStudent) return alert('Ch·ªçn h·ªçc sinh tr∆∞·ªõc!');
  
  // ‚úÖ KI·ªÇM TRA TH∆Ø VI·ªÜN ƒê√É LOAD CH∆ØA
  if (typeof docx === 'undefined' || typeof saveAs === 'undefined') {
    alert('‚è≥ ƒêang t·∫£i th∆∞ vi·ªán... Vui l√≤ng ƒë·ª£i 3 gi√¢y v√† th·ª≠ l·∫°i!');
    console.error('docx:', typeof docx !== 'undefined' ? 'OK' : 'MISSING');
    console.error('saveAs:', typeof saveAs !== 'undefined' ? 'OK' : 'MISSING');
    return;
  }
  
  try {
    const studentName = document.getElementById('detailName').textContent.trim();
    
    function getValue(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : 'Ch∆∞a c√≥ n·ªôi dung';
    }

    // ‚úÖ L·∫§Y D·ªÆ LI·ªÜU T·ª™ currentFeedback
    const work = currentFeedback.work;
    const topicsData = [
      work.topic1,
      work.topic2,
      work.topic3,
      work.topic4,
      work.topic5
    ];

    const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType, UnderlineType } = docx;
    
    const children = [];

    // Header
    children.push(
      new Paragraph({
        text: 'FCE WRITING ‚Äì FEEDBACK REPORT',
        heading: HeadingLevel.HEADING_1,
        alignment: AlignmentType.CENTER,
        spacing: { after: 200 }
      }),
      new Paragraph({
        children: [
          new TextRun({ text: studentName, bold: true }),
          new TextRun({ text: ` ‚Ä¢ Week ${currentWeek} ‚Ä¢ ${new Date().toLocaleDateString('vi-VN')}` })
        ],
        alignment: AlignmentType.CENTER,
        spacing: { after: 400 }
      })
    );

    const topics = ['topic1', 'topic2', 'topic3', 'topic4', 'topic5'];
    const topicTitles = [
      'TOPIC 1 ‚Äì APPEARANCE & SOCIETY',
      'TOPIC 2 ‚Äì STUDENTS & SCHOOL DECISIONS',
      'TOPIC 3 ‚Äì TECHNOLOGY & HAPPINESS',
      'TOPIC 4 ‚Äì OPPORTUNITIES FOR YOUNG PEOPLE',
      'TOPIC 5 ‚Äì PRACTICAL LIFE SKILLS'
    ];

    topics.forEach((topic, index) => {
      const prefix = `t${index + 1}`;
      const topicData = topicsData[index];
      
      // ============= TOPIC TITLE =============
      children.push(
        new Paragraph({ text: '', spacing: { before: 400 } }),
        new Paragraph({
          text: topicTitles[index],
          heading: HeadingLevel.HEADING_2,
          spacing: { after: 200 }
        })
      );

      // ============= ƒê·ªÄ B√ÄI =============
      children.push(
        new Paragraph({
          children: [new TextRun({ 
            text: 'üìù ƒê·ªÄ B√ÄI', 
            bold: true, 
            color: '1E40AF',
            underline: { type: UnderlineType.SINGLE } 
          })],
          spacing: { before: 150, after: 100 }
        }),
        new Paragraph({
          children: [new TextRun({ 
            text: topicData.prompt || 'Kh√¥ng c√≥ ƒë·ªÅ b√†i',
            italics: true,
            color: '374151'
          })],
          spacing: { after: 200 },
          border: {
            top: { color: 'E5E7EB', space: 1, style: 'single', size: 6 },
            bottom: { color: 'E5E7EB', space: 1, style: 'single', size: 6 },
            left: { color: '3B82F6', space: 1, style: 'single', size: 24 },
          },
          shading: { fill: 'EFF6FF' }
        })
      );

      // ============= M·ªû B√ÄI C·ª¶A H·ªåC SINH =============
      children.push(
        new Paragraph({
          children: [new TextRun({ 
            text: '‚úçÔ∏è M·ªû B√ÄI C·ª¶A H·ªåC SINH', 
            bold: true, 
            color: '7C3AED',
            underline: { type: UnderlineType.SINGLE } 
          })],
          spacing: { before: 150, after: 100 }
        }),
        new Paragraph({
          text: topicData.introduction || 'Ch∆∞a c√≥ m·ªü b√†i',
          spacing: { after: 100 },
          border: {
            top: { color: 'E5E7EB', space: 1, style: 'single', size: 6 },
            bottom: { color: 'E5E7EB', space: 1, style: 'single', size: 6 },
            left: { color: '8B5CF6', space: 1, style: 'single', size: 24 },
          },
          shading: { fill: 'FAF5FF' }
        }),
        new Paragraph({
          children: [
            new TextRun({ text: 'S·ªë t·ª´: ', color: '6B7280', size: 18 }),
            new TextRun({ text: `${topicData.wordCount || 0}`, bold: true, color: '059669', size: 18 }),
            new TextRun({ text: ' | Th·ªùi gian: ', color: '6B7280', size: 18 }),
            new TextRun({ text: `${topicData.timeUsed || '0m 0s'}`, bold: true, color: 'D97706', size: 18 })
          ],
          spacing: { after: 250 }
        })
      );

      // ============= PH√ÇN T√çCH ƒê·ªÄ B√ÄI =============
      children.push(
        new Paragraph({
          children: [new TextRun({ text: 'üéØ PH√ÇN T√çCH ƒê·ªÄ B√ÄI', bold: true, underline: { type: UnderlineType.SINGLE } })],
          spacing: { before: 200, after: 100 }
        }),
        new Paragraph({
          text: getValue(`${prefix}-analysis-full`),
          spacing: { after: 200 }
        })
      );

      // ============= M·ªû B√ÄI - ƒêI·ªÇM M·∫†NH & Y·∫æU =============
      children.push(
        new Paragraph({
          children: [new TextRun({ text: '‚≠ê M·ªû B√ÄI - ƒêI·ªÇM M·∫†NH & ƒêI·ªÇM Y·∫æU', bold: true, underline: { type: UnderlineType.SINGLE } })],
          spacing: { before: 200, after: 100 }
        }),
        new Paragraph({
          text: getValue(`${prefix}-strengths-weaknesses`),
          spacing: { after: 200 }
        })
      );

      // ============= BREAKDOWN =============
      children.push(
        new Paragraph({
          children: [new TextRun({ text: 'üìä BREAKDOWN ƒêI·ªÇM S·ªê CHI TI·∫æT', bold: true, underline: { type: UnderlineType.SINGLE } })],
          spacing: { before: 200, after: 100 }
        }),
        new Paragraph({
          text: getValue(`${prefix}-structure`),
          spacing: { after: 200 }
        })
      );

      // ============= G·ª¢I √ù C·∫¢I THI·ªÜN =============
      children.push(
        new Paragraph({
          children: [new TextRun({ text: 'üí° G·ª¢I √ù C·∫¢I THI·ªÜN', bold: true, underline: { type: UnderlineType.SINGLE } })],
          spacing: { before: 200, after: 100 }
        }),
        new Paragraph({
          text: getValue(`${prefix}-suggestions`),
          spacing: { after: 300 }
        })
      );
    });

    // ============= STATISTICS =============
    const statsText = document.getElementById('tab-stats')?.innerText.trim() || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
    children.push(
      new Paragraph({ text: '', spacing: { before: 400 } }),
      new Paragraph({
        text: 'üìà TH·ªêNG K√ä HO·∫†T ƒê·ªòNG',
        heading: HeadingLevel.HEADING_2,
        spacing: { after: 200 }
      }),
      new Paragraph({
        text: statsText,
        spacing: { after: 200 }
      })
    );

    const doc = new Document({
      sections: [{
        properties: {
          page: {
            margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
          }
        },
        children: children
      }]
    });

    // ‚úÖ Export file
    docx.Packer.toBlob(doc).then(blob => {
      saveAs(blob, `FCE_Feedback_${currentStudent}_Week${currentWeek}.docx`);
      alert('‚úÖ ƒê√£ t·∫£i xu·ªëng file DOCX! B·∫°n c√≥ th·ªÉ m·ªü b·∫±ng Word ƒë·ªÉ ch·ªânh s·ª≠a.');
    }).catch(err => {
      console.error('L·ªói export DOCX:', err);
      alert('‚ùå L·ªói khi t·∫°o file DOCX. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
    });

  } catch (error) {
    console.error('L·ªói export DOCX:', error);
    alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
  }
}

function exportPDF() {
  if (!currentStudent) return alert('Ch·ªçn h·ªçc sinh tr∆∞·ªõc!');

  const studentName = document.getElementById('detailName').textContent.trim();
  const printWin = window.open('', '_blank');

  const topics = ['topic1', 'topic2', 'topic3', 'topic4', 'topic5'];
  const topicTitles = [
    'TOPIC 1 ‚Äì APPEARANCE & SOCIETY',
    'TOPIC 2 ‚Äì STUDENTS & SCHOOL DECISIONS',
    'TOPIC 3 ‚Äì TECHNOLOGY & HAPPINESS',
    'TOPIC 4 ‚Äì OPPORTUNITIES FOR YOUNG PEOPLE',
    'TOPIC 5 ‚Äì PRACTICAL LIFE SKILLS'
  ];
  const topicColors = ['topic1', 'topic2', 'topic3', 'topic4', 'topic5'];

  printWin.document.write(`
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>FCE Feedback - ${studentName}</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  @page {
    size: A4;
    margin: 1.5cm;  /* ‚úÖ L·ªÄ 1.5CM */
  }
  
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    color: #1f2937;
    line-height: 1.6;
    background: white;
    font-size: 13pt;
  }

  /* ===== TABLE LAYOUT ƒê·ªÇ HEADER/FOOTER T·ª∞ ƒê·ªòNG ===== */
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  thead {
    display: table-header-group;  /* ‚úÖ T·ª∞ ƒê·ªòNG L·∫∂P L·∫†I M·ªåI TRANG */
  }
  
  tfoot {
    display: table-footer-group;  /* ‚úÖ T·ª∞ ƒê·ªòNG L·∫∂P L·∫†I M·ªåI TRANG */
  }
  
  tbody {
    display: table-row-group;
  }

  /* ===== HEADER ===== */
  .page-header {
    text-align: center;
    padding-bottom: 0.3cm;
    border-bottom: 2px solid #10b981;
  }
  .page-header img {
    height: 35px;
    margin-bottom: 0.2cm;
  }
  .page-header p {
    font-size: 9pt;
    color: #374151;
    line-height: 1.2;
  }

  /* ===== FOOTER ===== */
  .page-footer {
    text-align: center;
    font-size: 9pt;
    color: #6b7280;
    border-top: 1px solid #e5e7eb;
    padding-top: 0.3cm;
  }

  /* ===== TI√äU ƒê·ªÄ CH√çNH (CH·ªà TRANG 1) ===== */
  .main-title {
    text-align: center;
    margin: 0.5cm 0 0.6cm 0;
  }
  .main-title h1 {
    font-size: 18pt;
    font-weight: bold;
    color: #065f46;
    margin-bottom: 0.2cm;
  }
  .main-title p {
    font-size: 11pt;
    color: #374151;
  }

  /* ===== TOPIC TITLE ===== */
  .topic-title {
    font-size: 14pt;
    font-weight: bold;
    color: white;
    padding: 7px 12px;
    border-radius: 5px;
    margin: 0.6cm 0 0.3cm 0;
    display: inline-block;
  }
  .topic1 { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
  .topic2 { background: linear-gradient(135deg, #10b981, #059669); }
  .topic3 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
  .topic4 { background: linear-gradient(135deg, #f59e0b, #d97706); }
  .topic5 { background: linear-gradient(135deg, #ec4899, #db2777); }
  .stats { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

  /* ===== SECTION ===== */
  .section {
    margin: 0.3cm 0;
    background: #fffbeb;
    padding: 0.35cm 0.4cm;
    border-radius: 5px;
    border-left: 3px solid #f59e0b;
  }
  .section h3 {
    font-size: 12pt;
    margin-bottom: 0.25cm;
    color: #92400e;
    font-weight: 600;
  }
  .section pre {
    white-space: pre-wrap;
    font-family: inherit;
    font-size: 12pt;
    line-height: 1.5;
    margin: 0;
  }

  @media print {
    body { 
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }
</style>
</head>
<body>

<table>
  <!-- ‚úÖ HEADER (L·∫∂P L·∫†I M·ªåI TRANG) -->
  <thead>
    <tr>
      <td>
        <div class="page-header">
          <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME">
          <p>Hotline: 0976222792 ‚Ä¢ Email: info.limeschool@gmail.com</p>
        </div>
      </td>
    </tr>
  </thead>

  <!-- ‚úÖ FOOTER (L·∫∂P L·∫†I M·ªåI TRANG) -->
  <tfoot>
    <tr>
      <td>
        <div class="page-footer">
          LIME English Center ‚Ä¢ ƒê·ªãa ch·ªâ: Y√™n H√≤a - M·ªπ ƒê√¨nh, H√† N·ªôi ‚Ä¢ www.lime.edu.vn
        </div>
      </td>
    </tr>
  </tfoot>

  <!-- ‚úÖ N·ªòI DUNG CH√çNH -->
  <tbody>
    <tr>
      <td>
        <!-- TI√äU ƒê·ªÄ CH√çNH (CH·ªà TRANG 1) -->
        <div class="main-title">
          <h1>FCE WRITING ‚Äì FEEDBACK REPORT</h1>
          <p><strong>${studentName}</strong> ‚Ä¢ Week ${currentWeek} ‚Ä¢ ${new Date().toLocaleDateString('vi-VN')}</p>
        </div>

        <!-- N·ªòI DUNG C√ÅC TOPIC -->
        ${topics.map((topic, index) => generateTopic(index)).join('')}

        <!-- STATISTICS -->
        <div class="topic-title stats">TH·ªêNG K√ä HO·∫†T ƒê·ªòNG</div>
        <div class="section">
          <pre>${document.getElementById('tab-stats')?.innerText.trim() || 'Kh√¥ng c√≥ d·ªØ li·ªáu'}</pre>
        </div>
      </td>
    </tr>
  </tbody>
</table>

</body>
</html>
`);

  function generateTopic(index) {
    const tabId = topics[index];
    const title = topicTitles[index];
    const colorClass = topicColors[index];
    const tab = document.getElementById('tab-' + tabId);
    
    if (!tab) return '';
    
    const textareas = tab.querySelectorAll('textarea.editable');
    let html = `<div class="topic-title ${colorClass}">${title}</div>`;
    
    textareas.forEach(textarea => {
      let label = 'N·ªôi dung';
      const prevElement = textarea.previousElementSibling;
      if (prevElement && prevElement.tagName === 'STRONG') {
        label = prevElement.textContent;
      } else if (prevElement?.querySelector) {
        const strong = prevElement.querySelector('strong');
        if (strong) label = strong.textContent;
      }
      
      html += `
        <div class="section">
          <h3>${label}</h3>
          <pre>${textarea.value}</pre>
        </div>`;
    });
    
    return html;
  }

  printWin.document.close();
  setTimeout(() => printWin.print(), 500);
}

function saveEditedFeedback() {
  if (!currentStudent || !currentFeedback) {
    alert('Vui l√≤ng ch·ªçn h·ªçc sinh tr∆∞·ªõc!');
    return;
  }

  // Helper l·∫•y gi√° tr·ªã textarea an to√†n (d√π tab ƒëang ·∫©n)
  function getValue(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
  }

  function parseStrengthsWeaknesses(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    const strengths = [], weaknesses = [];
    let section = null;
    lines.forEach(line => {
      if (line.includes('ƒêI·ªÇM M·∫†NH')) section = 'strengths';
      else if (line.includes('ƒêI·ªÇM Y·∫æU')) section = 'weaknesses';
      else if ((line.startsWith('‚Ä¢') || line.startsWith('-') || line.match(/^\d+\./)) && line.length > 2) {
        const content = line.replace(/^[‚Ä¢\-\d.\s]+/, '').trim();
        if (content && !content.includes('Ch∆∞a c√≥')) {
          if (section === 'strengths') strengths.push(content);
          else if (section === 'weaknesses') weaknesses.push(content);
        }
      }
    });
    return { strengths, weaknesses };
  }

  const payload = {
    action: 'saveTeacherFeedback',
    studentCode: currentStudent,
    weekNumber: currentWeek,
    studentName: document.getElementById('detailName').textContent.split(' - ')[1] || 'Unknown',
    teacherFeedback: {}  // ƒê·ªïi c·∫•u tr√∫c cho r√µ r√†ng
  };

  // Duy·ªát 5 topic
  for (let i = 1; i <= 5; i++) {
    const prefix = `t${i}`;
    const analysis = getValue(`${prefix}-analysis-full`);
    const swText = getValue(`${prefix}-strengths-weaknesses`);
    const structure = getValue(`${prefix}-structure`);
    const suggestions = getValue(`${prefix}-suggestions`);

    const { strengths, weaknesses } = parseStrengthsWeaknesses(swText);
    const suggs = suggestions.split('\n')
      .map(l => l.replace(/^[‚Ä¢\-\d.\s]+/, '').trim())
      .filter(Boolean);

    payload.teacherFeedback[`topic${i}`] = {
      analysis_full: analysis,
      strengths_vn: strengths,
      weaknesses_vn: weaknesses,
      structure_breakdown: structure,
      suggestions_vn: suggs,
      saved_at: new Date().toISOString()
    };
  }

  // G·ª≠i l√™n Google Apps Script
fetch(GOOGLE_SCRIPT_URL, {
  method: 'POST',
  mode: 'cors',                    // b·∫Øt bu·ªôc c√≥
  cache: 'no-cache',
  // B·ªé HO√ÄN TO√ÄN header Content-Type ‚Üí t·ª± ƒë·ªông th√†nh text/plain ‚Üí bypass preflight
  body: JSON.stringify(payload)
})
.then(r => {
  if (!r.ok) throw new Error(`Server error: ${r.status}`);
  return r.text();                 // ƒë·ªçc text
})
.then(text => {
  let res;
  try { res = JSON.parse(text); } 
  catch(e) { console.log('Response kh√¥ng ph·∫£i JSON, nh∆∞ng v·∫´n l∆∞u ƒë∆∞·ª£c:', text); }
  
  alert('ƒê√£ l∆∞u th√†nh c√¥ng t·∫•t c·∫£ 5 ƒë·ªÅ!');
  setTimeout(() => location.reload(), 800);  // reload ƒë·ªÉ in ra n·ªôi dung m·ªõi
})
.catch(err => {
  console.error('L·ªói l∆∞u feedback:', err);
  alert('L·ªói m·∫°ng ho·∫∑c server. Ki·ªÉm tra console (F12) ƒë·ªÉ xem chi ti·∫øt.');
});
}

// Auto-resize all editable textareas
function autoResizeTextareas() {
  document.querySelectorAll('.editable').forEach(textarea => {
    // Reset height to recalculate
    textarea.style.height = 'auto';
    // Set height based on scrollHeight
    textarea.style.height = (textarea.scrollHeight + 5) + 'px';
    
    // Add input listener for dynamic resize
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight + 5) + 'px';
    });
  });
}
  </script>

</body>
</html>