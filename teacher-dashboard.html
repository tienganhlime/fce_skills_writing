<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard - FCE Writing - LIME</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tab { @apply px-4 py-2 rounded-t-lg font-semibold transition; }
    .tab-active { @apply bg-white text-green-700 border-t-2 border-green-600; }
    .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    .editable {
  @apply p-3 border rounded-lg bg-yellow-50 border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500;
  min-height: 60px;
  overflow: hidden;
  resize: vertical; /* Cho ph√©p k√©o th·ªß c√¥ng n·∫øu c·∫ßn */
}
  </style>
</head>
<body class="min-h-screen p-4">

<div class="max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-20 fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="w-12 h-12 object-contain">
        <div>
          <h1 class="text-2xl font-bold text-green-700">Teacher Dashboard</h1>
          <p class="text-green-600 text-sm">FCE Writing - Qu·∫£n l√Ω b√†i n·ªôp & Feedback</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-600">
        <p>Gi√°o vi√™n: <span class="font-semibold">Admin</span></p>
        <p id="currentDate"></p>
      </div>
    </div>
  </div>

  <!-- CH·ªåN TU·∫¶N -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <label class="block text-green-800 font-semibold mb-2">Ch·ªçn Tu·∫ßn</label>
    <select id="weekSelect" class="w-full md:w-64 px-4 py-3 border-2 border-green-300 rounded-lg text-lg" onchange="loadDashboard()">
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
    </select>
  </div>

  <!-- T·ªîNG QUAN & TH·ªêNG K√ä -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <h3 class="text-xl font-bold text-green-700 mb-3">T·ªïng quan</h3>
      <p class="text-3xl font-bold text-green-600" id="submittedCount">0</p>
      <p class="text-sm text-gray-600">ƒê√£ n·ªôp / <span id="totalStudents">0</span> h·ªçc sinh</p>
      <p class="text-sm text-orange-600 mt-2" id="notSubmittedList"></p>
    </div>

    <<div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
  <h3 class="text-xl font-bold text-green-700 mb-3">Average Scores (5 Topics)</h3>
  <div class="grid grid-cols-2 gap-4">
    <div>
      <p class="text-3xl font-bold text-blue-600" id="avgAnalysis">0.0</p>
      <p class="text-sm text-gray-600">Analysis</p>
    </div>
    <div>
      <p class="text-3xl font-bold text-purple-600" id="avgIntro">0.0</p>
      <p class="text-sm text-gray-600">Introduction</p>
    </div>
  </div>
</div>

    <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <canvas id="cefrChart" height="100"></canvas>
    </div>
  </div>

  <!-- DANH S√ÅCH H·ªåC SINH -->
  <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <h3 class="text-xl font-bold text-green-700 mb-4">Danh s√°ch h·ªçc sinh</h3>
    <div id="studentList" class="space-y-3">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- CHI TI·∫æT H·ªåC SINH -->
  <div id="studentDetail" class="hidden bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-green-700" id="detailName"></h3>
      <button onclick="closeDetail()" class="text-red-600 hover:text-red-800 font-bold">ƒê√≥ng</button>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-1 mb-6 border-b">
  <button class="tab tab-active" onclick="showTab('topic1')">Topic 1</button>
  <button class="tab tab-inactive" onclick="showTab('topic2')">Topic 2</button>
  <button class="tab tab-inactive" onclick="showTab('topic3')">Topic 3</button>
  <button class="tab tab-inactive" onclick="showTab('topic4')">Topic 4</button>
  <button class="tab tab-inactive" onclick="showTab('topic5')">Topic 5</button>
  <button class="tab tab-inactive" onclick="showTab('stats')">Statistics</button>
</div>

    <!-- N·ªôi dung tab -->
    <div id="tab-topic1" class="space-y-6"></div>
    <div id="tab-topic2" class="hidden space-y-6"></div>
   <div id="tab-topic3" class="hidden space-y-6"></div>
<div id="tab-topic4" class="hidden space-y-6"></div>
<div id="tab-topic5" class="hidden space-y-6"></div>
<div id="tab-stats" class="hidden space-y-6"></div>

    <!-- N√∫t h√†nh ƒë·ªông -->
    <div class="flex gap-3 mt-6">
      <button onclick="saveEditedFeedback()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        L∆∞u Feedback ƒê√£ S·ª≠a
      </button>
      <button onclick="exportPDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
        Export PDF
      </button>
    </div>
  </div>

</div>

<script>
  // THAY B·∫∞NG URL WEB APP C·ª¶A B·∫†N
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIp9jfs0GEOh_Y-0AnBBXXaX4AjsMHHW7SkZjDjJwtXFHicIqXyddq9IOZmEijXuu-Fg/exec';

  let currentWeek = 1;
  let currentStudent = null;
  let allSubmissions = [];
  let allStudents = [];
  let currentFeedback = {}; // L∆∞u feedback ƒëang ch·ªânh s·ª≠a

  // Load khi m·ªü trang
  window.onload = () => {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
    loadDashboard();
  };

  function loadDashboard() {
    currentWeek = document.getElementById('weekSelect').value;
    document.getElementById('studentList').innerHTML = '<div class="spinner"></div>';

    // L·∫•y danh s√°ch n·ªôp
    fetch(`${GOOGLE_SCRIPT_URL}?action=getSubmissions&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        allSubmissions = data.submissions || [];
        loadStudentList();
        loadOverview();
      })
      .catch(err => {
        document.getElementById('studentList').innerHTML = '<p class="text-red-600">L·ªói k·∫øt n·ªëi Apps Script!</p>';
        console.error(err);
      });

    // L·∫•y danh s√°ch h·ªçc sinh
    fetch(`${GOOGLE_SCRIPT_URL}?action=getAllStudents`)
      .then(r => r.json())
      .then(data => allStudents = data.students || [])
      .catch(() => allStudents = []);
  }

  function loadStudentList() {
    const list = document.getElementById('studentList');
    const submittedCodes = allSubmissions.map(s => s.code);
    const notSubmitted = allStudents.filter(s => !submittedCodes.includes(s.code));

    let html = '';
    [...allSubmissions, ...notSubmitted.map(s => ({...s, notSubmitted: true}))].sort((a,b) => a.code.localeCompare(b.code)).forEach(s => {
      const status = s.notSubmitted ? 'text-red-600' : 'text-green-600';
      const btn = s.notSubmitted ? '' : `<button onclick="viewStudent('${s.code}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Xem</button>`;
      html += `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
          <div>
            <span class="font-semibold">${s.code}</span> - 
            <span>${s.name || 'Ch∆∞a c√≥ t√™n'}</span>
            ${s.notSubmitted ? '<span class="text-red-500 text-sm ml-2">(Ch∆∞a n·ªôp)</span>' : ''}
          </div>
          ${btn}
        </div>`;
    });
    list.innerHTML = html || '<p class="text-gray-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
  }

  function loadOverview() {
    const submitted = allSubmissions.length;
    const total = allStudents.length;
    document.getElementById('submittedCount').textContent = submitted;
    document.getElementById('totalStudents').textContent = total;

    const notSubmittedNames = allStudents.filter(s => !allSubmissions.find(sub => sub.code === s.code)).map(s => s.code).join(', ');
    document.getElementById('notSubmittedList').textContent = notSubmittedNames ? `Ch∆∞a n·ªôp: ${notSubmittedNames}` : 'T·∫•t c·∫£ ƒë√£ n·ªôp';

    // Gi·∫£ l·∫≠p th·ªëng k√™ (s·∫Ω l·∫•y th·∫≠t t·ª´ API sau)
    document.getElementById('avgAnalysis').textContent = '7.8';
    document.getElementById('avgIntro').textContent = '6.5';

    // Bi·ªÉu ƒë·ªì CEFR
    const ctx = document.getElementById('cefrChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['C1/C2', 'B2+', 'B2', 'B1+', 'B1', 'A2'],
        datasets: [{
          data: [1, 2, 3, 5, 4, 0],
          backgroundColor: ['#4CAF50', '#8BC34A', '#2196F3', '#FFC107', '#FF9800', '#F44336']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  function viewStudent(code) {
    currentStudent = code;
    document.getElementById('studentDetail').classList.remove('hidden');
    document.getElementById('detailName').textContent = `${code} - ƒêang t·∫£i...`;
    document.getElementById('tab-topic1').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-topic2').innerHTML = '<div class="spinner"></div>';
    document.getElementById('tab-stats').innerHTML = '<div class="spinner"></div>';

    fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentDetail&code=${code}&week=${currentWeek}`)
      .then(r => r.json())
      .then(data => {
        if (data.status === 'success') {
          renderStudentDetail(data);
        } else {
          alert('Kh√¥ng t√¨m th·∫•y b√†i l√†m');
        }
      })
      .catch(err => {
        console.error(err);
        alert('L·ªói k·∫øt n·ªëi');
      });
  }

  function renderStudentDetail(data) {
    const work = data.work;
    const name = work.studentName || 'Unknown';
    document.getElementById('detailName').textContent = `${currentStudent} - ${name}`;

    currentFeedback = data;

// === ƒê·ªÄ 1 ===
const t1 = work.topic1;
const fb1 = data.teacherFeedback?.topic1 || data.aiFeedback?.topic1 || {};
const analysisFb = fb1.analysis_feedback || {};
const introFb = fb1.introduction_feedback || {};
const grammarErrors = introFb.grammar_errors || [];
const suggestions = fb1.improvement_suggestions || [];

document.getElementById('tab-topic1').innerHTML = `
  <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
    <h4 class="font-bold text-blue-800 mb-3">ƒê·ªÄ 1: ${t1.title || 'APPEARANCE & SOCIETY'}</h4>
    <p class="text-sm italic mb-4">"${t1.prompt || '...'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ph√¢n t√≠ch -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PH√ÇN T√çCH ƒê·ªÄ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t1.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t1.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t1.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t1.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t1.body1, t1.body2, t1.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- M·ªü b√†i -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">M·ªû B√ÄI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t1.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">S·ªë t·ª´: ${t1.wordCount || 0} | Th·ªùi gian: ${t1.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Ti·∫øt -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Ph√¢n t√≠ch ƒë·ªÅ (Score: <span class="text-blue-600">${fb1.analysis_score || 0}/10</span>)</h6>
          <textarea id="t1-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb.ss_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb.ss_comment || ''}
IS: ${analysisFb.is_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb.is_comment || ''}
Q: ${analysisFb.q_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb.q_comment || ''}
T: ${analysisFb.t_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb.t_comment || ''}
Outline Score: ${analysisFb.outline_score || 0}/2 - ${analysisFb.outline_comment || ''}

Overall: ${fb1.overall_comment || ''}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">M·ªü b√†i (Score: <span class="text-blue-600">${fb1.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb1.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Strengths & Weaknesses:</strong>
            <textarea id="t1-strengths-weaknesses" class="editable w-full mt-2" rows="8">STRENGTHS:
${introFb.strengths?.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}

WEAKNESSES:
${introFb.weaknesses?.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Grammar Errors:</strong>
            <textarea id="t1-grammar" class="editable w-full mt-2" rows="5">${grammarErrors.map(e => `‚Ä¢ Error: "${e.error}" ‚Üí Correction: "${e.correction}"`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Structure Breakdown (Scores):</strong>
            <textarea id="t1-structure" class="editable w-full mt-2" rows="4">Background: ${introFb.structure_breakdown?.background || 0}/1
Paraphrase: ${introFb.structure_breakdown?.paraphrase || 0}/1.5
Thesis: ${introFb.structure_breakdown?.thesis || 0}/2
General: ${introFb.structure_breakdown?.general || 0}/0.5</textarea>
          </div>

          <div class="mt-3">
            <strong>Word Count Score:</strong>
            <textarea id="t1-wordcount" class="editable w-full mt-2" rows="1">${introFb.word_count_score || 0}/1 (${introFb.word_count || 0} words)</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Improvement Suggestions:</h6>
          <textarea id="t1-suggestions" class="editable w-full mt-2" rows="6">${suggestions.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;

// === ƒê·ªÄ 2 ===
const t2 = work.topic2;
const fb2 = data.teacherFeedback?.topic2 || data.aiFeedback?.topic2 || {};
const analysisFb2 = fb2.analysis_feedback || {};
const introFb2 = fb2.introduction_feedback || {};
const grammarErrors2 = introFb2.grammar_errors || [];
const suggestions2 = fb2.improvement_suggestions || [];

document.getElementById('tab-topic2').innerHTML = `
  <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl">
    <h4 class="font-bold text-blue-800 mb-3">ƒê·ªÄ 2: ${t2.title || 'SCHOOL DECISIONS'}</h4>
    <p class="text-sm italic mb-4">"${t2.prompt || '...'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ph√¢n t√≠ch -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">PH√ÇN T√çCH ƒê·ªÄ</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t2.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t2.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t2.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t2.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t2.body1, t2.body2, t2.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- M·ªü b√†i -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">M·ªû B√ÄI</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t2.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">S·ªë t·ª´: ${t2.wordCount || 0} | Th·ªùi gian: ${t2.timeUsed || '0p 0s'}</p>
      </div>
    </div>

    <!-- Feedback Chi Ti·∫øt -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Ph√¢n t√≠ch ƒë·ªÅ (Score: <span class="text-blue-600">${fb2.analysis_score || 0}/10</span>)</h6>
          <textarea id="t2-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb2.ss_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb2.ss_comment || ''}
IS: ${analysisFb2.is_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb2.is_comment || ''}
Q: ${analysisFb2.q_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb2.q_comment || ''}
T: ${analysisFb2.t_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb2.t_comment || ''}
Outline Score: ${analysisFb2.outline_score || 0}/2 - ${analysisFb2.outline_comment || ''}

Overall: ${fb2.overall_comment || ''}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">M·ªü b√†i (Score: <span class="text-blue-600">${fb2.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb2.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Strengths & Weaknesses:</strong>
            <textarea id="t2-strengths-weaknesses" class="editable w-full mt-2" rows="8">STRENGTHS:
${introFb2.strengths?.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}

WEAKNESSES:
${introFb2.weaknesses?.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Grammar Errors:</strong>
            <textarea id="t2-grammar" class="editable w-full mt-2" rows="5">${grammarErrors2.map(e => `‚Ä¢ Error: "${e.error}" ‚Üí Correction: "${e.correction}"`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Structure Breakdown (Scores):</strong>
            <textarea id="t2-structure" class="editable w-full mt-2" rows="4">Background: ${introFb2.structure_breakdown?.background || 0}/1
Paraphrase: ${introFb2.structure_breakdown?.paraphrase || 0}/1.5
Thesis: ${introFb2.structure_breakdown?.thesis || 0}/2
General: ${introFb2.structure_breakdown?.general || 0}/0.5</textarea>
          </div>

          <div class="mt-3">
            <strong>Word Count Score:</strong>
            <textarea id="t2-wordcount" class="editable w-full mt-2" rows="1">${introFb2.word_count_score || 0}/1 (${introFb2.word_count || 0} words)</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Improvement Suggestions:</h6>
          <textarea id="t2-suggestions" class="editable w-full mt-2" rows="6">${suggestions2.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;

// === TOPIC 3 ===
const t3 = work.topic3;
const fb3 = data.teacherFeedback?.topic3 || data.aiFeedback?.topic3 || {};
const analysisFb3 = fb3.analysis_feedback || {};
const introFb3 = fb3.introduction_feedback || {};
const grammarErrors3 = introFb3.grammar_errors || [];
const suggestions3 = fb3.improvement_suggestions || [];

document.getElementById('tab-topic3').innerHTML = `
  <div class="bg-gradient-to-r from-teal-50 to-teal-100 p-5 rounded-xl">
    <h4 class="font-bold text-teal-800 mb-3">TOPIC 3: ${t3.title || 'TECHNOLOGY & HAPPINESS'}</h4>
    <p class="text-sm italic mb-4">"${t3.prompt || 'Technology has made our lives easier but has it made us happier?'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Essay Analysis -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">ESSAY ANALYSIS</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t3.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t3.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t3.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t3.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t3.body1, t3.body2, t3.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- Introduction -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">INTRODUCTION</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t3.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">Word count: ${t3.wordCount || 0} | Time: ${t3.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <!-- Detailed Feedback -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Essay Analysis (Score: <span class="text-blue-600">${fb3.analysis_score || 0}/10</span>)</h6>
          <textarea id="t3-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb3.ss_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb3.ss_comment || ''}
IS: ${analysisFb3.is_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb3.is_comment || ''}
Q: ${analysisFb3.q_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb3.q_comment || ''}
T: ${analysisFb3.t_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb3.t_comment || ''}
Outline Score: ${analysisFb3.outline_score || 0}/2 - ${analysisFb3.outline_comment || ''}

Overall: ${fb3.overall_comment || ''}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Introduction (Score: <span class="text-blue-600">${fb3.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb3.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Strengths & Weaknesses:</strong>
            <textarea id="t3-strengths-weaknesses" class="editable w-full mt-2" rows="8">STRENGTHS:
${introFb3.strengths?.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}

WEAKNESSES:
${introFb3.weaknesses?.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Grammar Errors:</strong>
            <textarea id="t3-grammar" class="editable w-full mt-2" rows="5">${grammarErrors3.map(e => `‚Ä¢ Error: "${e.error}" ‚Üí Correction: "${e.correction}"`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Structure Breakdown (Scores):</strong>
            <textarea id="t3-structure" class="editable w-full mt-2" rows="4">Background: ${introFb3.structure_breakdown?.background || 0}/1
Paraphrase: ${introFb3.structure_breakdown?.paraphrase || 0}/1.5
Thesis: ${introFb3.structure_breakdown?.thesis || 0}/2
General: ${introFb3.structure_breakdown?.general || 0}/0.5</textarea>
          </div>

          <div class="mt-3">
            <strong>Word Count Score:</strong>
            <textarea id="t3-wordcount" class="editable w-full mt-2" rows="1">${introFb3.word_count_score || 0}/1 (${introFb3.word_count || 0} words)</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Improvement Suggestions:</h6>
          <textarea id="t3-suggestions" class="editable w-full mt-2" rows="6">${suggestions3.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;

// === TOPIC 4 ===
const t4 = work.topic4;
const fb4 = data.teacherFeedback?.topic4 || data.aiFeedback?.topic4 || {};
const analysisFb4 = fb4.analysis_feedback || {};
const introFb4 = fb4.introduction_feedback || {};
const grammarErrors4 = introFb4.grammar_errors || [];
const suggestions4 = fb4.improvement_suggestions || [];

document.getElementById('tab-topic4').innerHTML = `
  <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-5 rounded-xl">
    <h4 class="font-bold text-orange-800 mb-3">TOPIC 4: ${t4.title || 'OPPORTUNITIES FOR YOUNG PEOPLE'}</h4>
    <p class="text-sm italic mb-4">"${t4.prompt || 'Young people today have more opportunities than their parents\' generation'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Essay Analysis -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">ESSAY ANALYSIS</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t4.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t4.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t4.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t4.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t4.body1, t4.body2, t4.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- Introduction -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">INTRODUCTION</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t4.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">Word count: ${t4.wordCount || 0} | Time: ${t4.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <!-- Detailed Feedback -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Essay Analysis (Score: <span class="text-blue-600">${fb4.analysis_score || 0}/10</span>)</h6>
          <textarea id="t4-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb4.ss_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb4.ss_comment || ''}
IS: ${analysisFb4.is_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb4.is_comment || ''}
Q: ${analysisFb4.q_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb4.q_comment || ''}
T: ${analysisFb4.t_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb4.t_comment || ''}
Outline Score: ${analysisFb4.outline_score || 0}/2 - ${analysisFb4.outline_comment || ''}

Overall: ${fb4.overall_comment || ''}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Introduction (Score: <span class="text-blue-600">${fb4.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb4.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Strengths & Weaknesses:</strong>
            <textarea id="t4-strengths-weaknesses" class="editable w-full mt-2" rows="8">STRENGTHS:
${introFb4.strengths?.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}

WEAKNESSES:
${introFb4.weaknesses?.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Grammar Errors:</strong>
            <textarea id="t4-grammar" class="editable w-full mt-2" rows="5">${grammarErrors4.map(e => `‚Ä¢ Error: "${e.error}" ‚Üí Correction: "${e.correction}"`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Structure Breakdown (Scores):</strong>
            <textarea id="t4-structure" class="editable w-full mt-2" rows="4">Background: ${introFb4.structure_breakdown?.background || 0}/1
Paraphrase: ${introFb4.structure_breakdown?.paraphrase || 0}/1.5
Thesis: ${introFb4.structure_breakdown?.thesis || 0}/2
General: ${introFb4.structure_breakdown?.general || 0}/0.5</textarea>
          </div>

          <div class="mt-3">
            <strong>Word Count Score:</strong>
            <textarea id="t4-wordcount" class="editable w-full mt-2" rows="1">${introFb4.word_count_score || 0}/1 (${introFb4.word_count || 0} words)</textarea>
          </div>
        </div>

        <!-- Suggestions -->
        <div>
          <h6 class="font-semibold text-gray-700">Improvement Suggestions:</h6>
          <textarea id="t4-suggestions" class="editable w-full mt-2" rows="6">${suggestions4.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}</textarea>
        </div>
      </div>
    </div>
  </div>
`;

// === TOPIC 5 ===
const t5 = work.topic5;
const fb5 = data.teacherFeedback?.topic5 || data.aiFeedback?.topic5 || {};
const analysisFb5 = fb5.analysis_feedback || {};
const introFb5 = fb5.introduction_feedback || {};
const grammarErrors5 = introFb5.grammar_errors || [];
const suggestions5 = fb5.improvement_suggestions || [];

document.getElementById('tab-topic5').innerHTML = `
  <div class="bg-gradient-to-r from-pink-50 to-pink-100 p-5 rounded-xl">
    <h4 class="font-bold text-pink-800 mb-3">TOPIC 5: ${t5.title || 'PRACTICAL LIFE SKILLS IN SCHOOLS'}</h4>
    <p class="text-sm italic mb-4">"${t5.prompt || 'Schools should teach practical life skills rather than just academic subjects'}"</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Essay Analysis -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-green-700 mb-2">ESSAY ANALYSIS</h5>
        <div class="space-y-1 text-sm">
          <div><strong>SS:</strong> ${t5.ss || '‚Äî'}</div>
          <div><strong>IS:</strong> ${t5.is || '‚Äî'}</div>
          <div><strong>Q:</strong> ${t5.q || '‚Äî'}</div>
          <div><strong>T:</strong> ${t5.t || '‚Äî'}</div>
        </div>
        <p class="mt-2"><strong>Outline:</strong> ${[t5.body1, t5.body2, t5.body3].filter(x=>x).join(' ‚Üí ') || '‚Äî'}</p>
      </div>

      <!-- Introduction -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h5 class="font-bold text-purple-700 mb-2">INTRODUCTION</h5>
        <p class="text-sm bg-gray-50 p-3 rounded">${t5.introduction || '‚Äî'}</p>
        <p class="mt-2 text-xs text-gray-600">Word count: ${t5.wordCount || 0} | Time: ${t5.timeUsed || '0m 0s'}</p>
      </div>
    </div>

    <!-- Detailed Feedback -->
    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
      <h5 class="font-bold text-yellow-800 mb-2">NH·∫¨N X√âT & ƒê√ÅNH GI√Å</h5>
      
      <div class="space-y-4">
        <!-- Analysis Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Essay Analysis (Score: <span class="text-blue-600">${fb5.analysis_score || 0}/10</span>)</h6>
          <textarea id="t5-analysis-full" class="editable w-full mt-2" rows="6">SS: ${analysisFb5.ss_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb5.ss_comment || ''}
IS: ${analysisFb5.is_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb5.is_comment || ''}
Q: ${analysisFb5.q_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb5.q_comment || ''}
T: ${analysisFb5.t_correct ? '‚úÖ' : '‚ùå'} - ${analysisFb5.t_comment || ''}
Outline Score: ${analysisFb5.outline_score || 0}/2 - ${analysisFb5.outline_comment || ''}

Overall: ${fb5.overall_comment || ''}</textarea>
        </div>

        <!-- Introduction Feedback -->
        <div>
          <h6 class="font-semibold text-gray-700">Introduction (Score: <span class="text-blue-600">${fb5.introduction_score || 0}/10</span>) | CEFR: <span class="text-purple-600">${fb5.cefr_level || 'N/A'}</span></h6>
          
          <div>
            <strong>Strengths & Weaknesses:</strong>
            <textarea id="t5-strengths-weaknesses" class="editable w-full mt-2" rows="8">STRENGTHS:
${introFb5.strengths?.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}

WEAKNESSES:
${introFb5.weaknesses?.map(w => `‚Ä¢ ${w}`).join('\n') || '‚Ä¢ None'}</textarea>
          </div>

          <div class="mt-3">
            <strong>Grammar Errors:</strong>
            <textarea id="t5-grammar" class="editable w-full mt-2" rows="5">${grammarErrors5.map(e => `‚Ä¢ Error: "e.error"‚ÜíCorrection:"{e.error}" ‚Üí Correction: "
e.error"‚ÜíCorrection:"{e.correction}"`).join('\n') || '‚Ä¢ None'}
</textarea>
</div>
      <div class="mt-3">
        <strong>Structure Breakdown (Scores):</strong>
        <textarea id="t5-structure" class="editable w-full mt-2" rows="4">Background: ${introFb5.structure_breakdown?.background || 0}/1
Paraphrase: ${introFb5.structure_breakdown?.paraphrase || 0}/1.5
Thesis: ${introFb5.structure_breakdown?.thesis || 0}/2
General: ${introFb5.structure_breakdown?.general || 0}/0.5</textarea>
</div>
      <div class="mt-3">
        <strong>Word Count Score:</strong>
        <textarea id="t5-wordcount" class="editable w-full mt-2" rows="1">${introFb5.word_count_score || 0}/1 (${introFb5.word_count || 0} words)</textarea>
      </div>
    </div>

    <!-- Suggestions -->
    <div>
      <h6 class="font-semibold text-gray-700">Improvement Suggestions:</h6>
      <textarea id="t5-suggestions" class="editable w-full mt-2" rows="6">${suggestions5.map(s => `‚Ä¢ ${s}`).join('\n') || '‚Ä¢ None'}</textarea>
    </div>
  </div>
</div>
  </div>
`;


    // === Tab Statistics (Work statistics for 5 topics) ===
document.getElementById('tab-stats').innerHTML = `
  <div class="bg-green-50 p-4 rounded-lg">
    <h5 class="font-bold text-green-700 mb-3">WORK STATISTICS</h5>
    <div class="space-y-2 text-sm">
      <p><strong>Total time:</strong> ${work.totalTime || '0m 0s'}</p>
      <p><strong>Topic 1 time:</strong> ${t1.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 2 time:</strong> ${t2.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 3 time:</strong> ${work.topic3?.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 4 time:</strong> ${work.topic4?.timeUsed || '0m 0s'}</p>
      <p><strong>Topic 5 time:</strong> ${work.topic5?.timeUsed || '0m 0s'}</p>
      <p><strong>Total pastes:</strong> ${data.totalPastes || 0}</p>
      <p><strong>Total edits:</strong> ${data.totalEdits || 0}</p>
    </div>
  </div>
`;

  setTimeout(() => {
    autoResizeTextareas();
  }, 100);
}

  function showTab(tab) {
    document.querySelectorAll('#studentDetail > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
    event.target.classList.replace('tab-inactive', 'tab-active');
  }

  function closeDetail() {
    document.getElementById('studentDetail').classList.add('hidden');
  }

function exportPDF() {
  if (!currentStudent) {
    alert('Vui l√≤ng ch·ªçn h·ªçc sinh tr∆∞·ªõc!');
    return;
  }

  // L·∫•y n·ªôi dung t·ª´ t·∫•t c·∫£ c√°c tab
  const studentName = document.getElementById('detailName').textContent;
  const topic1Content = document.getElementById('tab-topic1').innerText;
  const topic2Content = document.getElementById('tab-topic2').innerText;
  const topic3Content = document.getElementById('tab-topic3').innerText;
  const topic4Content = document.getElementById('tab-topic4').innerText;
  const topic5Content = document.getElementById('tab-topic5').innerText;
  const statsContent = document.getElementById('tab-stats').innerText;

  // T·∫°o c·ª≠a s·ªï m·ªõi ƒë·ªÉ in PDF
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Feedback Report - ${studentName}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: 'Segoe UI', 'Arial', sans-serif;
          padding: 30px;
          background: #ffffff;
          color: #333;
          line-height: 1.8;
        }
        
        .header {
          background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);
          color: white;
          padding: 30px;
          border-radius: 10px;
          margin-bottom: 30px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
          font-size: 32px;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        .header-info {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 15px;
          margin-top: 20px;
          font-size: 14px;
        }
        
        .info-box {
          background: rgba(255,255,255,0.2);
          padding: 10px 15px;
          border-radius: 5px;
          backdrop-filter: blur(10px);
        }
        
        .info-box strong {
          display: block;
          font-size: 11px;
          opacity: 0.9;
          margin-bottom: 3px;
        }
        
        .topic-section {
          page-break-before: always;
          margin-bottom: 40px;
          border: 2px solid #e0e0e0;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .topic-section:first-of-type {
          page-break-before: auto;
        }
        
        .topic-header {
          padding: 20px 25px;
          font-size: 24px;
          font-weight: bold;
          color: white;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .topic1-header { background: linear-gradient(135deg, #2196F3, #1976d2); }
        .topic2-header { background: linear-gradient(135deg, #4CAF50, #388e3c); }
        .topic3-header { background: linear-gradient(135deg, #00BCD4, #0097a7); }
        .topic4-header { background: linear-gradient(135deg, #FF9800, #f57c00); }
        .topic5-header { background: linear-gradient(135deg, #E91E63, #c2185b); }
        .stats-header { background: linear-gradient(135deg, #9C27B0, #7b1fa2); }
        
        .topic-content {
          padding: 25px;
          background: #fafafa;
          font-size: 13px;
          white-space: pre-wrap;
          font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .footer {
          margin-top: 50px;
          padding-top: 20px;
          border-top: 2px solid #e0e0e0;
          text-align: center;
          color: #999;
          font-size: 11px;
        }
        
        .logo {
          width: 40px;
          height: 40px;
          background: white;
          border-radius: 50%;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
        }
        
        @media print {
          body { 
            print-color-adjust: exact; 
            -webkit-print-color-adjust: exact; 
          }
          .topic-section { 
            page-break-inside: avoid; 
          }
          .header {
            box-shadow: none;
          }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>
          <span class="logo">üìù</span>
          FCE Writing Feedback Report
        </h1>
        <div class="header-info">
          <div class="info-box">
            <strong>H·ªåC SINH</strong>
            <div>${studentName}</div>
          </div>
          <div class="info-box">
            <strong>TU·∫¶N H·ªåC</strong>
            <div>Week ${currentWeek}</div>
          </div>
          <div class="info-box">
            <strong>NG√ÄY XU·∫§T</strong>
            <div>${new Date().toLocaleDateString('vi-VN')}</div>
          </div>
        </div>
      </div>
      
      <div class="topic-section">
        <div class="topic-header topic1-header">üìò TOPIC 1</div>
        <div class="topic-content">${topic1Content}</div>
      </div>
      
      <div class="topic-section">
        <div class="topic-header topic2-header">üìó TOPIC 2</div>
        <div class="topic-content">${topic2Content}</div>
      </div>
      
      <div class="topic-section">
        <div class="topic-header topic3-header">üìô TOPIC 3</div>
        <div class="topic-content">${topic3Content}</div>
      </div>
      
      <div class="topic-section">
        <div class="topic-header topic4-header">üìï TOPIC 4</div>
        <div class="topic-content">${topic4Content}</div>
      </div>
      
      <div class="topic-section">
        <div class="topic-header topic5-header">üìî TOPIC 5</div>
        <div class="topic-content">${topic5Content}</div>
      </div>
      
      <div class="topic-section">
        <div class="topic-header stats-header">üìä STATISTICS</div>
        <div class="topic-content">${statsContent}</div>
      </div>
      
      <div class="footer">
        <p><strong>LIME English Center</strong></p>
        <p>Generated by FCE Writing Teacher Dashboard System</p>
        <p>¬© 2025 All Rights Reserved</p>
      </div>
    </body>
    </html>
  `);
  
  printWindow.document.close();
  
  setTimeout(() => {
    printWindow.print();
  }, 500);
}

function saveEditedFeedback() {
  const payload = {
    action: 'saveTeacherFeedback',
    studentCode: currentStudent,
    weekNumber: currentWeek,
    studentName: document.getElementById('detailName').textContent.split(' - ')[1],
    
    topic1: {
      analysis_score: currentFeedback.aiFeedback?.topic1.analysis_score || 0,
      analysis_feedback: {
        outline_comment: document.getElementById('t1-analysis-comment').value
      },
      introduction_score: currentFeedback.aiFeedback?.topic1.introduction_score || 0,
      introduction_feedback: {
        strengths: document.getElementById('t1-strengths').value.split('\n').filter(line => line.trim()),
        weaknesses: document.getElementById('t1-weaknesses').value.split('\n').filter(line => line.trim()),
        grammar_errors: document.getElementById('t1-grammar').value.split('\n').filter(line => line.trim()).map(line => {
          const [error, correction] = line.split(' ‚Üí ').map(s => s.trim());
          return {error, correction};
        })
      },
      cefr_level: currentFeedback.aiFeedback?.topic1.cefr_level || 'N/A',
      overall_comment: document.getElementById('t1-analysis-comment').value,
      improvement_suggestions: document.getElementById('t1-suggestions').value.split('\n').filter(line => line.trim())
    },
    
    topic2: {
      analysis_score: currentFeedback.aiFeedback?.topic2.analysis_score || 0,
      analysis_feedback: {
        outline_comment: document.getElementById('t2-analysis-comment').value
      },
      introduction_score: currentFeedback.aiFeedback?.topic2.introduction_score || 0,
      introduction_feedback: {
        strengths: document.getElementById('t2-strengths').value.split('\n').filter(line => line.trim()),
        weaknesses: document.getElementById('t2-weaknesses').value.split('\n').filter(line => line.trim()),
        grammar_errors: document.getElementById('t2-grammar').value.split('\n').filter(line => line.trim()).map(line => {
          const [error, correction] = line.split(' ‚Üí ').map(s => s.trim());
          return {error, correction};
        })
      },
      cefr_level: currentFeedback.aiFeedback?.topic2.cefr_level || 'N/A',
      overall_comment: document.getElementById('t2-analysis-comment').value,
      improvement_suggestions: document.getElementById('t2-suggestions').value.split('\n').filter(line => line.trim())
    },
    
    topic3: {
      analysis_score: currentFeedback.aiFeedback?.topic3.analysis_score || 0,
      analysis_feedback: {
        outline_comment: document.getElementById('t3-analysis-comment').value
      },
      introduction_score: currentFeedback.aiFeedback?.topic3.introduction_score || 0,
      introduction_feedback: {
        strengths: document.getElementById('t3-strengths').value.split('\n').filter(line => line.trim()),
        weaknesses: document.getElementById('t3-weaknesses').value.split('\n').filter(line => line.trim()),
        grammar_errors: document.getElementById('t3-grammar').value.split('\n').filter(line => line.trim()).map(line => {
          const [error, correction] = line.split(' ‚Üí ').map(s => s.trim());
          return {error, correction};
        })
      },
      cefr_level: currentFeedback.aiFeedback?.topic3.cefr_level || 'N/A',
      overall_comment: document.getElementById('t3-analysis-comment').value,
      improvement_suggestions: document.getElementById('t3-suggestions').value.split('\n').filter(line => line.trim())
    },
    
    topic4: {
      analysis_score: currentFeedback.aiFeedback?.topic4.analysis_score || 0,
      analysis_feedback: {
        outline_comment: document.getElementById('t4-analysis-comment').value
      },
      introduction_score: currentFeedback.aiFeedback?.topic4.introduction_score || 0,
      introduction_feedback: {
        strengths: document.getElementById('t4-strengths').value.split('\n').filter(line => line.trim()),
        weaknesses: document.getElementById('t4-weaknesses').value.split('\n').filter(line => line.trim()),
        grammar_errors: document.getElementById('t4-grammar').value.split('\n').filter(line => line.trim()).map(line => {
          const [error, correction] = line.split(' ‚Üí ').map(s => s.trim());
          return {error, correction};
        })
      },
      cefr_level: currentFeedback.aiFeedback?.topic4.cefr_level || 'N/A',
      overall_comment: document.getElementById('t4-analysis-comment').value,
      improvement_suggestions: document.getElementById('t4-suggestions').value.split('\n').filter(line => line.trim())
    },
    
    topic5: {
      analysis_score: currentFeedback.aiFeedback?.topic5.analysis_score || 0,
      analysis_feedback: {
        outline_comment: document.getElementById('t5-analysis-comment').value
      },
      introduction_score: currentFeedback.aiFeedback?.topic5.introduction_score || 0,
      introduction_feedback: {
        strengths: document.getElementById('t5-strengths').value.split('\n').filter(line => line.trim()),
        weaknesses: document.getElementById('t5-weaknesses').value.split('\n').filter(line => line.trim()),
        grammar_errors: document.getElementById('t5-grammar').value.split('\n').filter(line => line.trim()).map(line => {
          const [error, correction] = line.split(' ‚Üí ').map(s => s.trim());
          return {error, correction};
        })
      },
      cefr_level: currentFeedback.aiFeedback?.topic5.cefr_level || 'N/A',
      overall_comment: document.getElementById('t5-analysis-comment').value,
      improvement_suggestions: document.getElementById('t5-suggestions').value.split('\n').filter(line => line.trim())
    }
  };

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => alert(res.status === 'success' ? 'Saved!' : 'Error: ' + res.message));
}
// Auto-resize all editable textareas
function autoResizeTextareas() {
  document.querySelectorAll('.editable').forEach(textarea => {
    // Reset height to recalculate
    textarea.style.height = 'auto';
    // Set height based on scrollHeight
    textarea.style.height = (textarea.scrollHeight + 5) + 'px';
    
    // Add input listener for dynamic resize
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight + 5) + 'px';
    });
  });
}
  </script>

</body>
</html>